<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>STOCKMANAGERAPP · Mobile Inventory (Validated)</title>
<link crossorigin="" href="https://unpkg.com" rel="preconnect"/>
<script src="https://unpkg.com/@zxing/browser@0.1.5">
// CONFIG section
const CONFIG = {
  POST_URL: "https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec"
};

// UPC scan auto-fill logic
function handleUPCScan(upc) {
  if (upc === "123456789012") {
    document.getElementById("brand").value = "SampleBrand";
    document.getElementById("gender").value = "Unisex";
    document.getElementById("masterItemDesc").value = "Sample Master Item Description";
  }
}

// QR scan parsing logic
function handleQRScanResult(qrString) {
  const parts = qrString.split("-");
  if (parts.length === 4) {
    document.getElementById("zone").value = parts[0];
    document.getElementById("aisle").value = parts[1];
    document.getElementById("rack").value = parts[2];
    document.getElementById("shelf").value = parts[3];
    document.getElementById("locationCode").value = qrString;
  }
}

// Submit & Next logic
function handleSubmit() {
  const payload = {
    upc: document.getElementById("upc").value,
    brand: document.getElementById("brand").value,
    gender: document.getElementById("gender").value,
    masterItemDesc: document.getElementById("masterItemDesc").value,
    locationCode: document.getElementById("locationCode").value,
    zone: document.getElementById("zone").value,
    aisle: document.getElementById("aisle").value,
    rack: document.getElementById("rack").value,
    shelf: document.getElementById("shelf").value,
    notes: document.getElementById("notes") ? document.getElementById("notes").value : ""
  };

  fetch(CONFIG.POST_URL, {
    method: "POST",
    body: JSON.stringify(payload),
    headers: { "Content-Type": "application/json" }
  })
  .then(response => response.text())
  .then(data => {
    alert("Submit successful!");
  })
  .catch(error => {
    alert("Submit failed. Use Download JSON.");
  });
}

// Attach event listener to Submit button
document.addEventListener("DOMContentLoaded", function() {
  const submitBtn = document.getElementById("submitBtn");
  if (submitBtn) {
    submitBtn.addEventListener("click", handleSubmit);
  }
});
</script>
<style>
  :root{ --bg:#0b1220; --panel:#111a2b; --ink:#e8eef9; --muted:#97a6c3; --acc:#3dbb8e; --warn:#ffb02e; --err:#ff6363; --line:#24314e; --gap:12px; --radius:12px }
  html,body{height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  *{box-sizing:border-box}
  .app{max-width:1080px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .title{font-weight:800;font-size:20px}
  .badge{background:#16233b;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:#9fb3d7}
  .spacer{flex:1}
  .status-strip{display:flex;gap:8px;align-items:center;color:#9fb3d7;font-size:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap)}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap}
  label{display:block;font-size:12px;color:#9fb3d7;margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1830;color:var(--ink)}
  input[readonly]{opacity:.85}
  textarea{min-height:72px;resize:vertical}
  h2{margin:0 0 10px;font-size:16px}
  h3{margin:8px 0;font-size:14px;color:#9fb3d7}
  .btn{background:linear-gradient(180deg,#2ac28b,#22a173);color:#001b12;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#1b2b4a;color:var(--ink);border:1px solid var(--line)}
  .btn.warn{background:#3b2a12;color:#ffd39c;border:1px solid #6b4a1b}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .pill{background:#11253c;border:1px solid var(--line);color:#b7c5e6;padding:8px 12px;border-radius:999px;font-size:12px}
  .version{color:#7aa2ff;font-size:12px;margin-left:8px}
  dialog#scanner{border:none;border-radius:14px;padding:0;max-width:min(640px,96vw);width:100%;background:#0a1428}
  .scan-wrap{position:relative}
  video{width:100%;height:auto;border-bottom:1px solid var(--line);background:#000}
  .overlay{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center}
  .reticle{width:min(75vw,420px);height:min(50vh,260px);border:2px solid rgba(61,187,142,.9);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.45) inset,0 0 16px rgba(61,187,142,.35)}
  .scan-hud{position:absolute;left:10px;right:10px;bottom:10px;display:flex;align-items:center;justify-content:space-between;color:#cfe7ff;font-size:12px}
  .chip{background:#0c1a33;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:#b7c5e6}
  .close-x{position:absolute;top:8px;right:8px;background:#142748;border:1px solid var(--line);color:#cfe7ff;border-radius:10px;padding:6px 10px;cursor:pointer}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} .grid-3{grid-template-columns:1fr} .grid-4{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<div class="app">
<header>
<div class="title">STOCKMANAGERAPP · Mobile Inventory <span class="version">v1.0.0-PRELOCK</span></div>
<span class="badge" id="pageIndicator">Page 1 of 2</span>
<div class="spacer"></div>
<div class="status-strip">
<span id="now"></span>
<span>•</span>
<span>Logged in as:</span>
<input id="loginName" placeholder="Your name" style="width:150px"/>
<button class="btn secondary" id="saveLogin" title="Save name on this device">Save</button>
</div>
</header>
<section class="panel" id="screen1">
<h2>Validate Item Details &amp; Packing</h2>
<div class="grid">
<div>
<label>UPC <span style="color:#ffb02e">*</span></label>
<div class="row">
<input autocomplete="off" id="upc" inputmode="numeric" placeholder="Scan or enter UPC"/>
<button class="btn" id="scanUPC">Scan UPC/Barcode</button>
<button class="btn secondary" id="genUPC">Generate UPC</button>
</div>
<small id="upcMsg" style="color:#9fb3d7"></small>
</div>
<div class="grid-3">
<div>
<label>Brand</label>
<input id="brand" placeholder="Auto-filled from base list"/>
</div>
<div>
<label>Gender</label>
<input id="gender" placeholder="Auto-filled from base list"/>
</div>
<div>
<label>Master Item Description</label>
<input id="desc" placeholder="Auto-filled from base list" style="width: 100%;"/>
</div>
</div>
</div>
<div class="grid">
<div class="grid-4">
<div>
<label>COO</label>
<input id="coo" placeholder="Country of Origin"/>
</div>
<div>
<label>C/D</label>
<input id="cd" placeholder="Clean/Decoded"/>
</div>
<div>
<label>Expected Quantity</label>
<input id="expectedQty" inputmode="numeric" placeholder="From base list (optional)"/>
</div>
<div>
<label>Entered Quantity (Subtotal)</label>
<input id="enteredQty" inputmode="numeric" placeholder="Auto-calculated" readonly=""/>
</div>
</div>
<div>
<div class="kpi">
<span class="pill">Sheet ID: <code id="sheetId"></code></span>
<span class="pill">Scan: <span id="scanStatus">Ready</span></span>
<span class="pill">Camera: <select id="cameraFacing"><option value="environment">Back</option><option value="user">Front</option></select></span>
</div>
</div>
</div>
<h3>Item Weight &amp; Dimensions</h3>
<div class="grid-4">
<div>
<label>Item Weight (lb)</label>
<input id="itemWeight" inputmode="decimal" placeholder="0.0"/>
</div>
<div>
<label>Item L (in)</label>
<input id="itemDimL" inputmode="decimal" placeholder="0.0"/>
</div>
<div>
<label>Item W (in)</label>
<input id="itemDimW" inputmode="decimal" placeholder="0.0"/>
</div>
<div>
<label>Item H (in)</label>
<input id="itemDimH" inputmode="decimal" placeholder="0.0"/>
</div>
</div>
<h3>Box Breakdown (Styles 1–4)</h3>
<div class="grid-4">
<div class="panel">
<strong>Box Style 1</strong>
<div class="grid-3">
<div><label>Boxes</label><input id="bs1_boxes" inputmode="numeric" placeholder="10"/></div>
<div><label>Qty/Box</label><input id="bs1_qty" inputmode="numeric" placeholder="20"/></div>
<div><label>Pcs (auto)</label><input id="bs1_pcs" readonly=""/></div>
</div>
<div class="grid-4">
<div><label>L (in)</label><input id="bs1_l" inputmode="decimal"/></div>
<div><label>W (in)</label><input id="bs1_w" inputmode="decimal"/></div>
<div><label>H (in)</label><input id="bs1_h" inputmode="decimal"/></div>
<div><label>Weight (lb)</label><input id="bs1_wt" inputmode="decimal"/></div>
</div>
</div>
<div class="panel">
<strong>Box Style 2</strong>
<div class="grid-3">
<div><label>Boxes</label><input id="bs2_boxes" inputmode="numeric"/></div>
<div><label>Qty/Box</label><input id="bs2_qty" inputmode="numeric"/></div>
<div><label>Pcs (auto)</label><input id="bs2_pcs" readonly=""/></div>
</div>
<div class="grid-4">
<div><label>L (in)</label><input id="bs2_l" inputmode="decimal"/></div>
<div><label>W (in)</label><input id="bs2_w" inputmode="decimal"/></div>
<div><label>H (in)</label><input id="bs2_h" inputmode="decimal"/></div>
<div><label>Weight (lb)</label><input id="bs2_wt" inputmode="decimal"/></div>
</div>
</div>
<div class="panel">
<strong>Box Style 3</strong>
<div class="grid-3">
<div><label>Boxes</label><input id="bs3_boxes" inputmode="numeric"/></div>
<div><label>Qty/Box</label><input id="bs3_qty" inputmode="numeric"/></div>
<div><label>Pcs (auto)</label><input id="bs3_pcs" readonly=""/></div>
</div>
<div class="grid-4">
<div><label>L (in)</label><input id="bs3_l" inputmode="decimal"/></div>
<div><label>W (in)</label><input id="bs3_w" inputmode="decimal"/></div>
<div><label>H (in)</label><input id="bs3_h" inputmode="decimal"/></div>
<div><label>Weight (lb)</label><input id="bs3_wt" inputmode="decimal"/></div>
</div>
</div>
<div class="panel">
<strong>Box Style 4</strong>
<div class="grid-3">
<div><label>Boxes</label><input id="bs4_boxes" inputmode="numeric"/></div>
<div><label>Qty/Box</label><input id="bs4_qty" inputmode="numeric"/></div>
<div><label>Pcs (auto)</label><input id="bs4_pcs" readonly=""/></div>
</div>
<div class="grid-4">
<div><label>L (in)</label><input id="bs4_l" inputmode="decimal"/></div>
<div><label>W (in)</label><input id="bs4_w" inputmode="decimal"/></div>
<div><label>H (in)</label><input id="bs4_h" inputmode="decimal"/></div>
<div><label>Weight (lb)</label><input id="bs4_wt" inputmode="decimal"/></div>
</div>
</div>
</div>
<div class="row" style="margin-top:10px">
<div class="kpi">
<span class="pill">Subtotal Pcs: <strong id="subtotalPcs">0</strong></span>
<span class="pill">Match Status: <strong id="matchStatus">—</strong></span>
</div>
<div class="spacer"></div>
<button class="btn" id="checkDiscrepancy">Check Discrepancy</button>
</div>
<div class="footer-actions">
<button class="btn secondary" id="toScreen2">Next → Putaway (Page 2)</button>
</div>
</section>
<section class="panel" id="screen2" style="display:none">
<h2>Putaway</h2>
<div class="grid-3">
<div>
<label>Putaway Instructions / Notes</label>
<textarea id="notes" placeholder="Optional"></textarea>
</div>
<div class="panel">
<strong>Scan Controls</strong>
<div class="row" style="margin-top:6px">
<button class="btn secondary" id="scanLocation">Scan Location QR</button>
<button class="btn secondary" id="toggleCamera">Toggle Camera</button>
</div>
<small>Tip: Use the front camera if it’s easier to align shelf/bin QR codes.</small>
</div>
<div class="panel">
<strong>Totals</strong>
<div class="kpi" style="margin-top:6px">
<span class="pill">Entered Qty: <strong id="enteredQty2">0</strong></span>
<span class="pill">Putaway Total: <strong id="putawayTotal">0</strong></span>
<span class="pill">OK to Submit: <strong id="okToSubmit">No</strong></span>
</div>
</div>
</div>
<h3>Locations (up to 9)</h3>
<div class="grid" id="locRows"></div>
<div class="footer-actions">
<button class="btn secondary" id="backTo1">← Back</button>
<button class="btn warn" id="downloadJson" style="display:none">Download JSON (offline)</button>
<button class="btn" id="submitSheet">Submit &amp; Next</button>
</div>
</section>
</div>
<dialog id="scanner">
<div class="scan-wrap">
<video autoplay="" id="video" muted="" playsinline=""></video>
<div class="overlay"><div class="reticle"></div></div>
<div class="scan-hud">
<div class="chip" id="scanTypeLabel">Scanning…</div>
<div class="row" style="gap:8px">
<button class="btn secondary" id="flipFacing">Flip</button>
<button class="btn" id="closeScanner">Done</button>
</div>
</div>
<button class="close-x" id="xClose">✕</button>
</div>
</dialog>
<script id="seedData" type="application/json">[{"upc":"3700591230073","brand":"ATELIER COLOGNE","gender":"LADIES","desc":"ATELIER CLEMENTINE CALIFORNIA L .33OZ PURE PERFUME SPRAY","coo":"FRANCE","cd":"C","expectedQty":4211},{"upc":"3700591230035","brand":"ATELIER COLOGNE","gender":"LADIES","desc":"ATELIER CLEMENTINE CALIFORNIA L 3.3OZ PURE PERFUME SPRAY","coo":"FRANCE","cd":"C","expectedQty":144},{"upc":"6290360593241","brand":"LATTAFA","gender":"UNISEX","desc":"LATTAFA KHAMRAH 6.7OZ DEO SPRAY","coo":"UAE","cd":"C","expectedQty":288}]</script>
<script>
const CONFIG = { SHEET_WEBAPP_URL: 'https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec', SHEET_ID: '1k1j6Qn5VLXyuFbZm_vOUelB1hD2AT-pAL_0_22LcIrA', REQUIRE_UPC: true };
const $ = (id)=>document.getElementById(id);
const val = (id)=>$(id).value?.trim();
const setVal = (id,v)=>($(id).value = v ?? '');
const num = (id)=>{ const x = val(id); const n = Number(x); return isNaN(n)?0:n };
let ctx; function beep(){ try{ ctx = ctx || new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='sine'; o.frequency.value=880; o.start(); g.gain.setValueAtTime(0.001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.12); o.stop(ctx.currentTime+0.13); }catch(e){} }
function onlyDigits(s){ return (s||'').replace(/\D+/g,''); }
function normalizeUPC(s){ return onlyDigits(s); }
function upcCheckDigit11(ups11){ let sum=0; for(let i=0;i<11;i++){ const d = Number(ups11[i]); sum += (i%2===0) ? d*3 : d; } return (10 - (sum % 10)) % 10; }
function generateUPC(){ let base=''; for(let i=0;i<11;i++) base += Math.floor(Math.random()*10); return base + upcCheckDigit11(base); }
function loadPrefs(){ setVal('loginName', localStorage.getItem('loginName')||''); $('cameraFacing').value = localStorage.getItem('cameraFacing')||'environment'; }
function savePrefs(){ localStorage.setItem('loginName', val('loginName')); localStorage.setItem('cameraFacing', $('cameraFacing').value); }
function tick(){ $('now').textContent = new Date().toLocaleString(); setTimeout(tick, 1000); }
[1,2,3,4].forEach(i=>{ ['bs'+i+'_boxes','bs'+i+'_qty'].forEach(id=> $(id).addEventListener('input', recomputeTotals)); });
function calcStylePcs(i){ const pcs = (num(`bs${i}_boxes`) * num(`bs${i}_qty`)) || 0; setVal(`bs${i}_pcs`, pcs); return pcs; }
function recomputeTotals(){ let total=0; [1,2,3,4].forEach(i=> total += calcStylePcs(i)); $('subtotalPcs').textContent = String(total); setVal('enteredQty', total); $('enteredQty2').textContent = String(total); validatePutaway(); }
function checkDiscrepancy(){ const expected = Number(val('expectedQty')||'0'); const entered = Number(val('enteredQty')||'0'); if(!expected){ $('matchStatus').innerHTML = '<span class="warn-text">No expected qty</span>'; return; } if(entered===expected){ $('matchStatus').innerHTML = '<span class="ok">Match</span>'; } else { const diff=entered-expected; const msg = diff>0? `Over by ${diff}`:`Short by ${Math.abs(diff)}`; $('matchStatus').innerHTML = `<span class="no">Mismatch – ${msg}</span>`; } }

let currentCtrl = {target:null,type:'UPC'}, codeReader, previewStream; const scannerDialog=$('scanner'), videoEl=$('video');
async function startScan(targetId, type){ currentCtrl={target:targetId,type}; const facing=$('cameraFacing').value; localStorage.setItem('cameraFacing', facing); $('scanStatus').textContent = (facing==='user'?'Front':'Back'); if(!codeReader) codeReader = new ZXingBrowser.BrowserMultiFormatReader(); try{ scannerDialog.showModal(); const constraints={ video: { facingMode: { ideal: facing }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false }; previewStream=await navigator.mediaDevices.getUserMedia(constraints); videoEl.srcObject=previewStream; await codeReader.decodeFromVideoDevice(undefined, videoEl, (result,err)=>{ if(result){ const text=String(result.getText()).trim(); onScanSuccess(text); } }); }catch(e){ alert('Camera access failed. Please allow camera permissions and try again.'); closeScanner(); } }
function onScanSuccess(text){ beep(); const tgt=$(currentCtrl.target); if(currentCtrl.type==='UPC'){ const d=normalizeUPC(text); if(!d) return; tgt.value=d; $('upcMsg').textContent=`Scanned: ${d}`; fetchBaseItem(d); } else { tgt.value=text; } closeScanner(); }
function stopStream(){ try{ if(previewStream) previewStream.getTracks().forEach(t=>t.stop()); }catch(_ ){} try{ if(codeReader) codeReader.reset(); }catch(_ ){} }
function closeScanner(){ stopStream(); if(scannerDialog.open) scannerDialog.close(); }
$('xClose').addEventListener('click', closeScanner);
$('closeScanner').addEventListener('click', closeScanner);
$('flipFacing').addEventListener('click', ()=>{ $('cameraFacing').value=$('cameraFacing').value==='environment'?'user':'environment'; closeScanner(); startScan(currentCtrl.target, currentCtrl.type); });

async function fetchBaseItem(upc){ // Primary: Apps Script
  try{ if(CONFIG.SHEET_WEBAPP_URL){ const url = CONFIG.SHEET_WEBAPP_URL+`?action=getItem&upc=${encodeURIComponent(upc)}`; const res = await fetch(url); const data = await res.json(); if(data && data.item){ applyBaseItem(data.item); return; } } }catch(e){ /* ignore and fallback */ }
  // Fallback: embedded Excel seed
  const seed = JSON.parse(document.getElementById('seedData').textContent||'[]');
  const found = seed.find(x=>String(x.upc)===String(upc));
  if(found) applyBaseItem(found); else $('upcMsg').textContent='No base item found';
}
function applyBaseItem(item){ setVal('brand', item.brand||''); setVal('gender', item.gender||''); setVal('desc', item.desc||''); setVal('coo', item.coo||''); setVal('cd', item.cd||''); setVal('expectedQty', item.expectedQty||''); lockBrandGender(); }
function lockBrandGender(){ const lock=(id)=>{ const el=$(id); if(val(id)) el.setAttribute('readonly','readonly'); else el.removeAttribute('readonly'); }; ['brand','gender'].forEach(lock); }

function makeLocRow(i){ const d=document.createElement('div'); d.className='panel'; d.innerHTML = `
  <div class="grid-4">
    <div><label>ZONE</label><input id="loc${i}_zone" placeholder="A"></div>
    <div><label>AISLE</label><input id="loc${i}_aisle" placeholder="05"></div>
    <div><label>RACK</label><input id="loc${i}_rack" placeholder="02"></div>
    <div><label>SHELF</label><input id="loc${i}_shelf" placeholder="3"></div>
  </div>
  <div class="grid-4" style="margin-top:8px">
    <div><label>BIN</label><input id="loc${i}_bin" placeholder="B"></div>
    <div><label>Location Code (QR)</label><input id="loc${i}_code" placeholder="Scan or paste"></div>
    <div><label>Qty</label><input id="loc${i}_qty" inputmode="numeric" placeholder="0"></div>
    <div style="display:flex;align-items:flex-end;gap:8px">
      <button class="btn secondary" onclick="startScan('loc${i}_code','QR');return false;">Scan</button>
      <button class="btn secondary" onclick="parseLoc(${i});return false;">Parse</button>
    </div>
  </div>`; return d; }
function buildLocRows(){ const host=$('locRows'); host.innerHTML=''; for(let i=1;i<=9;i++) host.appendChild(makeLocRow(i)); }
function parseLoc(i){ const code=val(`loc${i}_code`); if(!code) return; const k={ZONE:'',AISLE:'',RACK:'',SHELF:'',BIN:''}; code.split(/[\|,;]+/).forEach(p=>{ const m=p.match(/(ZONE|AISLE|RACK|SHELF|BIN)\s*[:=]\s*([A-Za-z0-9-]+)/i); if(m) k[m[1].toUpperCase()]=m[2]; }); if(!k.ZONE){ const parts=code.split(/[-_/]/); if(parts.length>=5) [k.ZONE,k.AISLE,k.RACK,k.SHELF,k.BIN]=parts.slice(0,5); } ['zone','aisle','rack','shelf','bin'].forEach(f=> setVal(`loc${i}_${f}`, k[f.toUpperCase()]||'')); }
function validatePutaway(){ let s=0; for(let i=1;i<=9;i++) s += Number(val(`loc${i}_qty`)||'0'); $('putawayTotal').textContent=String(s); const entered=Number(val('enteredQty')||'0'); $('okToSubmit').textContent = (s>0 && s===entered) ? 'Yes':'No'; return (s>0 && s===entered); }
for(let i=1;i<=9;i++){ document.addEventListener('input', (e)=>{ if(e.target && e.target.id===`loc${i}_qty`) validatePutaway(); }); }
function buildPayload(){ const locs=[]; for(let i=1;i<=9;i++){ const qty=Number(val(`loc${i}_qty`)||'0'); if(qty>0) locs.push({zone:val(`loc${i}_zone`),aisle:val(`loc${i}_aisle`),rack:val(`loc${i}_rack`),shelf:val(`loc${i}_shelf`),bin:val(`loc${i}_bin`),code:val(`loc${i}_code`),qty}); } return {
  timestamp:new Date().toISOString(), login:val('loginName')||'', upc:normalizeUPC(val('upc')),
  brand:val('brand'), gender:val('gender'), desc:val('desc'), coo:val('coo'), cd:val('cd'),
  expectedQty:Number(val('expectedQty')||'0'),
  itemWeight:Number(val('itemWeight')||'0'), itemDimL:Number(val('itemDimL')||'0'), itemDimW:Number(val('itemDimW')||'0'), itemDimH:Number(val('itemDimH')||'0'),
  boxStyles:[1,2,3,4].map(i=>({ boxes:Number(val(`bs${i}_boxes`)||'0'), qtyPerBox:Number(val(`bs${i}_qty`)||'0'), pcs:Number(val(`bs${i}_pcs`)||'0'), l:val(`bs${i}_l`), w:val(`bs${i}_w`), h:val(`bs${i}_h`), weight:val(`bs${i}_wt`) })),
  subtotalPcs:Number(val('enteredQty')||'0'), locations:locs, notes:val('notes')||''
}; }
async function submit(){ if(CONFIG.REQUIRE_UPC && !val('upc')){ alert('UPC is required.'); return; } if(!validatePutaway()){ alert('Putaway total must equal Entered Quantity.'); return; } const payload=buildPayload(); if(CONFIG.SHEET_WEBAPP_URL){ try{ const res=await fetch(CONFIG.SHEET_WEBAPP_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'submit',payload}) }); const data=await res.json(); if(data && data.ok){ alert('Submitted ✔'); resetForm(); } else throw new Error('Bad response'); }catch(e){ alert('Submit failed. Use Download JSON.'); $('downloadJson').style.display='inline-flex'; } } else { $('downloadJson').style.display='inline-flex'; alert('No Google Sheets endpoint configured.'); } }
function downloadJson(){ const blob = new Blob([JSON.stringify(buildPayload(), null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='stockmanagerapp_prelock_submit_'+Date.now()+'.json'; a.click(); }
function resetForm(){ const keep=['loginName']; document.querySelectorAll('input,textarea,select').forEach(el=>{ if(!keep.includes(el.id)) el.value=''; }); $('cameraFacing').value=localStorage.getItem('cameraFacing')||'environment'; lockBrandGender(); recomputeTotals(); buildLocRows(); $('pageIndicator').textContent='Page 1 of 2'; $('screen1').style.display='block'; $('screen2').style.display='none'; }
$('saveLogin').addEventListener('click', savePrefs);
$('cameraFacing').addEventListener('change', savePrefs);
$('scanUPC').addEventListener('click', ()=> startScan('upc','UPC'));
$('genUPC').addEventListener('click', ()=>{ const u=generateUPC(); setVal('upc',u); $('upcMsg').textContent='Generated: '+u; });
$('checkDiscrepancy').addEventListener('click', checkDiscrepancy);
$('submitSheet').addEventListener('click', submit);
$('downloadJson').addEventListener('click', downloadJson);
$('scanLocation').addEventListener('click', ()=> startScan('loc1_code','QR'));
$('toggleCamera').addEventListener('click', ()=>{ $('cameraFacing').value=$('cameraFacing').value==='environment'?'user':'environment'; savePrefs(); });
$('toScreen2').addEventListener('click', ()=>{ $('screen1').style.display='none'; $('screen2').style.display='block'; $('pageIndicator').textContent='Page 2 of 2'; validatePutaway(); });
$('backTo1').addEventListener('click', ()=>{ $('screen2').style.display='none'; $('screen1').style.display='block'; $('pageIndicator').textContent='Page 1 of 2'; });
$('upc').addEventListener('change', ()=>{ const d=normalizeUPC(val('upc')); setVal('upc', d); if(d) fetchBaseItem(d); });
(function init(){ loadPrefs(); tick(); buildLocRows(); recomputeTotals(); lockBrandGender(); $('sheetId').textContent = '…'+CONFIG.SHEET_ID.slice(-6); })();
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const qrInput = document.getElementById("locationCodeQR");
  const zoneField = document.getElementById("zone");
  const aisleField = document.getElementById("aisle");
  const rackField = document.getElementById("rack");
  const shelfField = document.getElementById("shelf");

  if (qrInput) {
    qrInput.addEventListener("change", function () {
      const scanned = qrInput.value.trim();
      const parts = scanned.split("-");
      if (parts.length === 4) {
        zoneField.value = parts[0];
        aisleField.value = parts[1];
        rackField.value = parts[2];
        shelfField.value = parts[3];
      }
    });
  }
});
</script>
<script>
// CONFIG: Google Apps Script Web App URL
const POST_URL = "https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec";

// Submit & Next logic
document.getElementById("submitBtn")?.addEventListener("click", function () {
    const payload = {
        upc: document.getElementById("upc")?.value || "",
        brand: document.getElementById("brand")?.value || "",
        gender: document.getElementById("gender")?.value || "",
        masterItemDesc: document.getElementById("masterItemDesc")?.value || "",
        coo: document.getElementById("coo")?.value || "",
        cd: document.getElementById("cd")?.value || "",
        expectedQty: document.getElementById("expectedQty")?.value || "",
        enteredQty: document.getElementById("enteredQty")?.value || "",
        itemWeight: document.getElementById("itemWeight")?.value || "",
        itemLength: document.getElementById("itemLength")?.value || "",
        itemWidth: document.getElementById("itemWidth")?.value || "",
        itemHeight: document.getElementById("itemHeight")?.value || "",
        notes: document.getElementById("notes")?.value || "",
        locations: []
    };

    for (let i = 1; i <= 9; i++) {
        const loc = document.getElementById("location" + i)?.value || "";
        if (loc) payload.locations.push(loc);
    }

    fetch(POST_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
    })
    .then(res => res.ok ? alert("Submitted successfully!") : alert("Submit failed. Use Download JSON."))
    .catch(() => alert("Submit failed. Use Download JSON."));
});

// QR Scan logic: parse full location string into ZONE, AISLE, RACK, SHELF
function handleQRScanResult(result) {
    const parts = result.split("-");
    if (parts.length === 4) {
        document.getElementById("zone")?.value = parts[0];
        document.getElementById("aisle")?.value = parts[1];
        document.getElementById("rack")?.value = parts[2];
        document.getElementById("shelf")?.value = parts[3];
        document.getElementById("location1")?.value = result;
    } else {
        document.getElementById("location1")?.value = result;
    }
}
</script>
<script>
const CONFIG = {
  POST_URL: "https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec"
};
</script><script>
document.getElementById("submitBtn").addEventListener("click", function () {
  const payload = {
    upc: document.getElementById("upc").value,
    brand: document.getElementById("brand").value,
    gender: document.getElementById("gender").value,
    masterDesc: document.getElementById("masterDesc").value,
    coo: document.getElementById("coo").value,
    cd: document.getElementById("cd").value,
    weight: document.getElementById("weight").value,
    length: document.getElementById("length").value,
    width: document.getElementById("width").value,
    height: document.getElementById("height").value,
    expectedQty: document.getElementById("expectedQty").value,
    enteredQty: document.getElementById("enteredQty").value,
    notes: document.getElementById("notes").value,
    locations: []
  };

  for (let i = 1; i <= 9; i++) {
    const loc = document.getElementById("location" + i);
    if (loc && loc.value.trim() !== "") {
      payload.locations.push(loc.value.trim());
    }
  }

  fetch(CONFIG.POST_URL, {
    method: "POST",
    body: JSON.stringify(payload),
    headers: {
      "Content-Type": "application/json"
    }
  })
    .then((res) => res.text())
    .then((data) => {
      alert("Submit successful!");
    })
    .catch((err) => {
      alert("Submit failed. Use Download JSON.");
    });
});

// QR scan parsing logic
function handleQRScan(result) {
  const parts = result.split("-");
  if (parts.length === 4) {
    document.getElementById("zone").value = parts[0];
    document.getElementById("aisle").value = parts[1];
    document.getElementById("rack").value = parts[2];
    document.getElementById("shelf").value = parts[3];
    document.getElementById("location1").value = result;
  } else {
    alert("Invalid QR code format. Expected format: ZONE-AISLE-RACK-SHELF");
  }
}
</script><script>
const CONFIG = {
  POST_URL: "https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec"
};
</script><script>
document.getElementById("submitBtn")?.addEventListener("click", function () {
  const payload = {
    upc: document.getElementById("upc")?.value || "",
    brand: document.getElementById("brand")?.value || "",
    gender: document.getElementById("gender")?.value || "",
    masterItemDesc: document.getElementById("masterItemDesc")?.value || "",
    coo: document.getElementById("coo")?.value || "",
    cd: document.getElementById("cd")?.value || "",
    notes: document.getElementById("notes")?.value || "",
    location1: document.getElementById("location1")?.value || "",
    zone: document.getElementById("zone")?.value || "",
    aisle: document.getElementById("aisle")?.value || "",
    rack: document.getElementById("rack")?.value || "",
    shelf: document.getElementById("shelf")?.value || ""
  };

  fetch(CONFIG.POST_URL, {
    method: "POST",
    body: JSON.stringify(payload),
    headers: { "Content-Type": "application/json" }
  })
    .then((res) => res.text())
    .then((data) => {
      alert("Submit successful!");
    })
    .catch((err) => {
      alert("Submit failed. Use Download JSON.");
    });
});

// QR scan parsing logic
function handleQRScanResult(qrString) {
  const parts = qrString.split("-");
  if (parts.length === 4) {
    document.getElementById("zone").value = parts[0];
    document.getElementById("aisle").value = parts[1];
    document.getElementById("rack").value = parts[2];
    document.getElementById("shelf").value = parts[3];
    document.getElementById("location1").value = qrString;
  }
}
</script><script>
document.getElementById("scanUPCBtn").addEventListener("click", function() {
    const upcInput = document.getElementById("upcInput");
    const upc = upcInput.value.trim();
    if (upc === "123456789012") {
        document.getElementById("brandInput").value = "SampleBrand";
        document.getElementById("genderInput").value = "Unisex";
        document.getElementById("masterItemDesc").value = "Sample Item Description";
    }
});

document.getElementById("scanLocationBtn").addEventListener("click", function() {
    const qrInput = document.getElementById("locationQRInput");
    const qr = qrInput.value.trim();
    const parts = qr.split("-");
    if (parts.length === 4) {
        document.getElementById("zoneInput").value = parts[0];
        document.getElementById("aisleInput").value = parts[1];
        document.getElementById("rackInput").value = parts[2];
        document.getElementById("shelfInput").value = parts[3];
        document.getElementById("location1Input").value = qr;
    }
});

document.getElementById("submitBtn").addEventListener("click", function() {
    const payload = {
        upc: document.getElementById("upcInput").value,
        brand: document.getElementById("brandInput").value,
        gender: document.getElementById("genderInput").value,
        description: document.getElementById("masterItemDesc").value,
        zone: document.getElementById("zoneInput").value,
        aisle: document.getElementById("aisleInput").value,
        rack: document.getElementById("rackInput").value,
        shelf: document.getElementById("shelfInput").value,
        location1: document.getElementById("location1Input").value
    };
    fetch("https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {
            "Content-Type": "application/json"
        }
    }).then(response => {
        if (response.ok) {
            alert("Submit successful!");
        } else {
            alert("Submit failed. Use Download JSON.");
        }
    }).catch(error => {
        alert("Submit failed. Use Download JSON.");
    });
});
</script><script>
const CONFIG = {
  POST_URL: "https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec"
};
</script><script>
document.getElementById("submitBtn").addEventListener("click", function () {
  const payload = {
    upc: document.querySelector("[name='upc']").value,
    brand: document.querySelector("[name='brand']").value,
    gender: document.querySelector("[name='gender']").value,
    masterItemDesc: document.querySelector("[name='masterItemDesc']").value,
    locationCode: document.querySelector("[name='locationCode']").value,
    zone: document.querySelector("[name='zone']").value,
    aisle: document.querySelector("[name='aisle']").value,
    rack: document.querySelector("[name='rack']").value,
    shelf: document.querySelector("[name='shelf']").value,
    notes: document.querySelector("[name='notes']").value
  };

  fetch(CONFIG.POST_URL, {
    method: "POST",
    body: JSON.stringify(payload),
    headers: { "Content-Type": "application/json" }
  })
    .then(response => response.text())
    .then(data => {
      alert("Submit successful!");
    })
    .catch(error => {
      alert("Submit failed. Use Download JSON.");
    });
});

// QR scan parsing logic
function handleQRScanResult(scannedValue) {
  const parts = scannedValue.split("-");
  if (parts.length === 4) {
    document.querySelector("[name='zone']").value = parts[0];
    document.querySelector("[name='aisle']").value = parts[1];
    document.querySelector("[name='rack']").value = parts[2];
    document.querySelector("[name='shelf']").value = parts[3];
    document.querySelector("[name='locationCode']").value = scannedValue;
  }
}

// Simulated UPC autofill logic
document.getElementById("scanUPCBtn").addEventListener("click", function () {
  const upc = document.querySelector("[name='upc']").value;
  if (upc === "123456789012") {
    document.querySelector("[name='brand']").value = "SampleBrand";
    document.querySelector("[name='gender']").value = "Unisex";
    document.querySelector("[name='masterItemDesc']").value = "Sample Master Item Description";
  }
});
</script></body>
</html>