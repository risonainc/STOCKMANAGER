<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STOCKMANAGERAPP ¬∑ Mobile Inventory (Validated)</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --line:#1f2937;
    }
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:980px;margin:0 auto;padding:16px}
    h1,h2,h3{margin:.25rem 0 1rem} h1{font-size:1.25rem;font-weight:700} h2{font-size:1.1rem;font-weight:700}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .row-6{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    @media (max-width:720px){ .row,.row-3,.row-4,.row-6{grid-template-columns:1fr} }
    label{font-size:.85rem;color:var(--muted)}
    input,select,textarea{width:100%;background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:1rem}
    input[readonly]{background:#0b1320b3}
    select:disabled{opacity:.8}
    textarea{min-height:72px}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.65rem .9rem;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--accent);color:#03200e;border:0;font-weight:700}
    .btn.ghost{background:transparent}
    .btn.block{width:100%;justify-content:center}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .grid-label{font-size:.8rem;color:var(--muted)}
    .status{padding:.35rem .6rem;border-radius:8px;font-size:.9rem;font-weight:700}
    .ok{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.35)}
    .bad{background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
    .scanbox{position:relative;aspect-ratio:4/3;background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--line)}
    video{width:100%;height:100%;object-fit:cover}
    .aim{position:absolute;inset:12%;border:2px solid #22c55e99;border-radius:8px;box-shadow:0 0 0 200vmax rgba(0,0,0,.3) inset}
    .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 0}
    .page-indicator{color:var(--muted)} .hidden{display:none!important}
    small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;color:#93c5fd}
    .hint{color:#9ca3af;font-size:.78rem;margin-top:4px}
    .lockedNote{color:#f59e0b;font-size:.8rem;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="bar">
      <h1>STOCKMANAGERAPP ¬∑ Mobile Inventory v1.0.0-PRELOCK</h1>
      <span id="pageIndicator" class="page-indicator">Page <b>1</b> of 2</span>
    </div>

    <!-- PAGE 1: Validate Item Details & Packing -->
    <section id="page1" class="card">
      <h2>Validate Item Details &amp; Packing</h2>
      <div class="toolbar" style="margin-bottom:8px">
        <button id="btnScanUPC" class="btn">üì∑ Scan UPC/Barcode</button>
        <button id="btnGenUPC" class="btn">üî¢ Generate UPC</button>
      </div>

      <div class="row">
        <div>
          <label for="upc">UPC *</label>
          <input id="upc" inputmode="numeric" autocomplete="off" placeholder="Scan or enter 12‚Äì14 digit UPC" />
        </div>
        <div>
          <label for="brand" id="labelBrand">Brand</label>
          <input id="brand" placeholder="Auto-filled on scan or editable if blank" />
          <div id="brandLockNote" class="lockedNote hidden">Auto-filled & locked ¬∑ long‚Äëpress ‚ÄúBrand‚Äù to unlock</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="gender" id="labelGender">Gender</label>
          <select id="gender">
            <option value="">‚Äî</option>
            <option>WOMEN</option>
            <option>MEN</option>
            <option>UNISEX</option>
          </select>
          <div id="genderLockNote" class="lockedNote hidden">Auto-filled & locked ¬∑ long‚Äëpress ‚ÄúGender‚Äù to unlock</div>
        </div>
        <div>
          <label for="itemDesc">Master Item Description</label>
          <input id="itemDesc" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="coo">COO</label>
          <input id="coo" placeholder="Country of Origin" />
        </div>
        <div>
          <label for="cd">C/D</label>
          <select id="cd">
            <option value="">‚Äî</option>
            <option value="CLEAN">CLEAN</option>
            <option value="DECODED">DECODED</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="expectedQty">Expected Quantity</label>
          <input id="expectedQty" type="number" min="0" value="0" />
        </div>
        <div>
          <label for="enteredQty">Entered Quantity (Subtotal)</label>
          <input id="enteredQty" type="number" min="0" value="0" readonly />
        </div>
      </div>

      <h3>Item Weight &amp; Dimensions</h3>
      <div class="row-4">
        <div><label for="itemWeight">Item Weight (lb)</label><input id="itemWeight" type="number" step="0.01" min="0"/></div>
        <div><label for="itemL">Item L (in)</label><input id="itemL" type="number" step="0.01" min="0"/></div>
        <div><label for="itemW">Item W (in)</label><input id="itemW" type="number" step="0.01" min="0"/></div>
        <div><label for="itemH">Item H (in)</label><input id="itemH" type="number" step="0.01" min="0"/></div>
      </div>

      <h3>Box Breakdown (Styles 1‚Äì4)</h3>
      <div id="boxStyles">
        <!-- Style 1 -->
        <div class="card" style="background:transparent">
          <div class="grid-label">Box Style 1</div>
          <div class="row-6">
            <div><label>Boxes</label><input id="s1_boxes" type="number" min="0" value="0"></div>
            <div><label>Qty/Box</label><input id="s1_qty" type="number" min="0" value="0"></div>
            <div><label>Pcs (auto)</label><input id="s1_pcs" type="number" value="0" readonly></div>
            <div><label>L (in)</label><input id="s1_l" type="number" step="0.01" min="0"></div>
            <div><label>W (in)</label><input id="s1_w" type="number" step="0.01" min="0"></div>
            <div><label>H (in)</label><input id="s1_h" type="number" step="0.01" min="0"></div>
          </div>
        </div>
        <!-- Style 2 -->
        <div class="card" style="background:transparent">
          <div class="grid-label">Box Style 2</div>
          <div class="row-6">
            <div><label>Boxes</label><input id="s2_boxes" type="number" min="0" value="0"></div>
            <div><label>Qty/Box</label><input id="s2_qty" type="number" min="0" value="0"></div>
            <div><label>Pcs (auto)</label><input id="s2_pcs" type="number" value="0" readonly></div>
            <div><label>L (in)</label><input id="s2_l" type="number" step="0.01" min="0"></div>
            <div><label>W (in)</label><input id="s2_w" type="number" step="0.01" min="0"></div>
            <div><label>H (in)</label><input id="s2_h" type="number" step="0.01" min="0"></div>
          </div>
        </div>
        <!-- Style 3 -->
        <div class="card" style="background:transparent">
          <div class="grid-label">Box Style 3</div>
          <div class="row-6">
            <div><label>Boxes</label><input id="s3_boxes" type="number" min="0" value="0"></div>
            <div><label>Qty/Box</label><input id="s3_qty" type="number" min="0" value="0"></div>
            <div><label>Pcs (auto)</label><input id="s3_pcs" type="number" value="0" readonly></div>
            <div><label>L (in)</label><input id="s3_l" type="number" step="0.01" min="0"></div>
            <div><label>W (in)</label><input id="s3_w" type="number" step="0.01" min="0"></div>
            <div><label>H (in)</label><input id="s3_h" type="number" step="0.01" min="0"></div>
          </div>
        </div>
        <!-- Style 4 -->
        <div class="card" style="background:transparent">
          <div class="grid-label">Box Style 4</div>
          <div class="row-6">
            <div><label>Boxes</label><input id="s4_boxes" type="number" min="0" value="0"></div>
            <div><label>Qty/Box</label><input id="s4_qty" type="number" min="0" value="0"></div>
            <div><label>Pcs (auto)</label><input id="s4_pcs" type="number" value="0" readonly></div>
            <div><label>L (in)</label><input id="s4_l" type="number" step="0.01" min="0"></div>
            <div><label>W (in)</label><input id="s4_w" type="number" step="0.01" min="0"></div>
            <div><label>H (in)</label><input id="s4_h" type="number" step="0.01" min="0"></div>
          </div>
        </div>
      </div>

      <div class="row" style="align-items:center">
        <div>
          <div class="grid-label">Subtotal Pcs</div>
          <div><span id="subtotal" class="status">0</span></div>
        </div>
        <div>
          <div class="grid-label">Match Status</div>
          <div id="matchStatus" class="status">‚Äî</div>
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button id="btnCheck" class="btn">üîé Check Discrepancy</button>
        <button id="btnNext" class="btn primary">Next ‚Üí Putaway (Page 2)</button>
      </div>
      <div class="hint">Hint: Enter box counts on Page 1. On Page 2, split the same subtotal across up to 9 locations.</div>
    </section>

    <!-- PAGE 2: Putaway -->
    <section id="page2" class="card hidden">
      <h2>Putaway</h2>
      <label for="notes">Putaway Instructions / Notes</label>
      <textarea id="notes" placeholder="e.g., Reserve top shelf, fragile, etc."></textarea>

      <div class="toolbar" style="margin:8px 0">
        <button id="btnScanLoc" class="btn">üì∑ Scan Location QR</button>
        <button id="btnToggleCam" class="btn ghost">üîÅ Toggle Camera</button>
      </div>
      <small class="mono">Tip: Use the front camera if it‚Äôs easier to align shelf/bin QR codes.</small>

      <div class="row" style="margin-top:10px">
        <div class="card" style="background:transparent">
          <div class="grid-label">Totals</div>
          <div class="row-3">
            <div><label>Entered Qty</label><input id="enteredQty2" type="number" readonly value="0"/></div>
            <div><label>Putaway Total</label><input id="putawayTotal" type="number" readonly value="0"/></div>
            <div><label>OK to Submit</label><input id="okSubmit" readonly value="No"/></div>
          </div>
        </div>
      </div>

      <h3>Locations (up to 9)</h3>
      <div id="locations"></div>

      <div class="toolbar" style="margin-top:10px;justify-content:space-between">
        <button id="btnBack" class="btn">‚Üê Back</button>
        <div style="display:flex;gap:8px">
          <button id="btnDownload" class="btn">‚¨áÔ∏è Download JSON (offline)</button>
          <button id="btnSubmitNext" class="btn primary">Submit &amp; Next</button>
        </div>
      </div>
    </section>

    <!-- SCAN MODAL -->
    <div id="scanModal" class="card hidden">
      <div class="bar"><strong id="scanTitle">Scanning‚Ä¶</strong><button id="btnCloseScan" class="btn">‚úï</button></div>
      <div class="scanbox"><video id="video" autoplay muted playsinline></video><div class="aim"></div></div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnFlip" class="btn">üîÑ Flip</button>
        <button id="btnDone" class="btn">‚úÖ Done</button>
      </div>
      <small class="mono">If camera scanning isn‚Äôt supported, type into the input field directly.</small>
    </div>
  </div>

<script>
/***********************************
 * CONFIG (your Apps Script endpoints)
 ***********************************/
const CONFIG = {
  POST_URL: 'https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec',
  LOOKUP_URL: 'https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec',
  ENABLE_BIN: false // NO BIN ATM: 4-part location code (Z-##-##-##)
};

/***********************************
 * STATE
 ***********************************/
let activePage = 1;
let facingMode = 'environment'; // or 'user'
let scanMode = null; // 'upc' | 'location'
let stream = null;
let barcodeDetector = null;

const el = (id) => document.getElementById(id);
const $  = (sel, root=document) => root.querySelector(sel);

/***********************************
 * HELPERS
 ***********************************/
function fmt(n){return Number(n||0)}
function calcStylePcs(boxes, qty){ return Math.max(0, fmt(boxes)) * Math.max(0, fmt(qty)); }

function updateBoxTotals(){
  const s = [1,2,3,4].map(i=>({
    boxes: fmt(el(`s${i}_boxes`).value),
    qty:   fmt(el(`s${i}_qty`).value)
  }));
  s.forEach((r,i)=> el(`s${i+1}_pcs`).value = calcStylePcs(r.boxes, r.qty));
  const subtotal = s.reduce((a,r)=> a + calcStylePcs(r.boxes, r.qty), 0);
  el('enteredQty').value = subtotal;
  el('subtotal').textContent = String(subtotal);
  el('enteredQty2').value = subtotal;
  reconcileTotals();
}

function sumPutaway(){ let t = 0; for(let i=1;i<=9;i++){ t += fmt(el(`loc${i}_qty`).value) } return t; }

function reconcileTotals(){
  const expected = fmt(el('expectedQty').value);
  const entered  = fmt(el('enteredQty').value);
  const putaway  = sumPutaway();

  const status = el('matchStatus'); status.classList.remove('ok','bad');
  if(expected === 0 && entered === 0){ status.textContent = '‚Äî'; }
  else if(expected === entered){ status.textContent = 'MATCH'; status.classList.add('ok'); }
  else { status.textContent = `MISMATCH (Œî ${entered - expected})`; status.classList.add('bad'); }

  el('putawayTotal').value = putaway;
  el('okSubmit').value = (entered > 0 && entered === putaway) ? 'Yes' : 'No';
}

function genUPC12(){
  const base = Array.from({length:11},()=>Math.floor(Math.random()*10));
  const sumOdd  = (base[0]+base[2]+base[4]+base[6]+base[8]+base[10]) * 3;
  const sumEven = (base[1]+base[3]+base[5]+base[7]+base[9]);
  const check   = (10 - ((sumOdd + sumEven) % 10)) % 10;
  return base.join('') + check;
}

function parseLocationCode(code){
  const trimmed = (code||'').trim().toUpperCase();
  const m = trimmed.match(/^([A-Z])-(\d{2})-(\d{2})-(\d{2})$/);
  if(!m){ throw new Error('Invalid location format. Use Z-##-##-## (e.g., C-01-05-02)'); }
  return { zone:m[1], aisle:m[2], rack:m[3], shelf:m[4], code:trimmed };
}

function collectBoxBreakdown(){
  const rows = [];
  for(let i=1;i<=4;i++){
    rows.push({
      style: i,
      boxes: fmt(el(`s${i}_boxes`).value),
      qtyPerBox: fmt(el(`s${i}_qty`).value),
      pcs:  fmt(el(`s${i}_pcs`).value),
      dims: { L:fmt(el(`s${i}_l`).value), W:fmt(el(`s${i}_w`).value), H:fmt(el(`s${i}_h`).value) }
    });
  }
  return rows;
}

function collectLocations(){
  const list = [];
  for(let i=1;i<=9;i++){
    const code = el(`loc${i}_code`).value.trim();
    const qty  = fmt(el(`loc${i}_qty`).value);
    if(code || qty>0){
      list.push({
        index:i, code,
        zone: el(`loc${i}_zone`).value,
        aisle:el(`loc${i}_aisle`).value,
        rack: el(`loc${i}_rack`).value,
        shelf:el(`loc${i}_shelf`).value,
        qty
      });
    }
  }
  return list;
}

function collectPayload(){
  return {
    metadata: { app:'STOCKMANAGERAPP', version:'1.0.0-PRELOCK', ts:new Date().toISOString(), device:navigator.userAgent },
    pageIndicator: `Page ${activePage} of 2`,
    item: {
      upc: el('upc').value.trim(),
      brand: el('brand').value.trim(),
      gender: el('gender').value,
      masterItemDesc: el('itemDesc').value.trim(),
      coo: el('coo').value.trim(),
      cd: el('cd').value,
      expectedQty: fmt(el('expectedQty').value),
      enteredQty: fmt(el('enteredQty').value),
      itemWeightLb: fmt(el('itemWeight').value),
      itemDimsIn: { L:fmt(el('itemL').value), W:fmt(el('itemW').value), H:fmt(el('itemH').value) }
    },
    boxBreakdown: collectBoxBreakdown(),
    putaway: { notes: el('notes').value.trim(), totalQty: sumPutaway(), locations: collectLocations() }
  };
}

function downloadJSON(){
  const blob = new Blob([JSON.stringify(collectPayload(),null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `stockmanagerapp_payload_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

async function submitNext(){
  const payload = collectPayload();
  if(!/^\d{12,14}$/.test(payload.item.upc)){ alert('UPC must be 12‚Äì14 digits.'); return; }
  if(payload.item.enteredQty <= 0){ alert('Entered Quantity must be greater than 0.'); return; }
  if(payload.item.enteredQty !== payload.putaway.totalQty){ alert('Putaway Total must match Entered Quantity.'); return; }
  if(!CONFIG.POST_URL){ alert('No POST URL configured. Use Download JSON (offline) or set CONFIG.POST_URL.'); return; }

  try{
    const res = await fetch(CONFIG.POST_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const text = await res.text();
    alert('Submit successful!\n' + text.slice(0,200));
    resetForNext();
  }catch(err){
    console.error(err);
    alert('Submit failed. Use Download JSON (offline).');
  }
}

function resetForNext(){
  unlockBrand(); unlockGender();

  const keep = ['gender','cd'];
  Array.from(document.querySelectorAll('input,textarea,select')).forEach(inp=>{
    if(keep.includes(inp.id)) return;
    if(inp.tagName==='SELECT') inp.selectedIndex = 0; else inp.value = '';
  });
  ['expectedQty','enteredQty','enteredQty2','putawayTotal'].forEach(id=> el(id).value = 0);
  el('subtotal').textContent = '0';
  el('okSubmit').value = 'No';
  el('matchStatus').textContent = '‚Äî';
  el('matchStatus').classList.remove('ok','bad');

  for(let i=1;i<=9;i++){ ['code','zone','aisle','rack','shelf','qty'].forEach(k=> el(`loc${i}_${k}`).value = (k==='qty'?'0':'')) }
  for(let i=1;i<=4;i++){ ['boxes','qty','pcs','l','w','h'].forEach(k=>{ const id=`s${i}_${k}`; el(id).value = (k==='pcs'?'0': (k==='boxes'||k==='qty')?'0':''); }) }

  goPage(1);
  el('upc').focus();
}

/***********************************
 * CAMERA / SCANNING (BarcodeDetector)
 ***********************************/
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
function beep(){ try{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.value=880; g.gain.value=0.05; o.start(); setTimeout(()=>o.stop(),120) }catch(e){} }

async function ensureBarcodeDetector(){
  if('BarcodeDetector' in window){
    try{
      barcodeDetector = new BarcodeDetector({formats:['qr_code','ean_13','ean_8','code_128','upc_a','upc_e']});
    }catch(e){ barcodeDetector = null; }
  }
}

async function openScanner(mode){
  scanMode = mode; // 'upc' | 'location'
  await ensureBarcodeDetector();
  if(!barcodeDetector){ alert('Camera barcode scanning not supported on this device/browser.'); return; }

  try{ stream?.getTracks().forEach(t=>t.stop()); }catch(e){}
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode}});
    el('video').srcObject = stream;
    el('scanTitle').textContent = mode==='upc' ? 'Scanning UPC/Barcode‚Ä¶' : 'Scanning Location QR‚Ä¶';
    el('scanModal').classList.remove('hidden');
    scanLoop();
  }catch(err){
    console.error(err);
    alert('Could not open camera. Check permissions.');
  }
}

async function scanLoop(){
  if(!barcodeDetector || el('scanModal').classList.contains('hidden')) return;
  try{
    const detections = await barcodeDetector.detect(el('video'));
    if(detections && detections.length){
      const raw = (detections[0].rawValue||'').trim();
      if(scanMode==='upc'){ await applyUPC(raw); }
      else if(scanMode==='location'){ applyLocation(raw); }
      beep();
      await new Promise(r=>setTimeout(r, 600));
    }
  }catch(e){ /* swallow */ }
  requestAnimationFrame(scanLoop);
}

function closeScanner(){
  el('scanModal').classList.add('hidden');
  try{ stream?.getTracks().forEach(t=>t.stop()); }catch(e){}
}

function flipCamera(){
  facingMode = (facingMode==='environment') ? 'user' : 'environment';
  if(!el('scanModal').classList.contains('hidden')){ openScanner(scanMode); }
}

/***********************************
 * UPC AUTO-FILL + LOCKING
 ***********************************/
const ITEM_DB = {
  // Example mapping; replace with live lookup via CONFIG.LOOKUP_URL
  '123456789012': {brand:'SAMPLEBRAND', gender:'UNISEX', masterItemDesc:'Sample Master Item Description'}
};

async function lookupUPC(upc){
  upc = (upc||'').replace(/\D/g,'');
  if(!upc) return null;
  if(ITEM_DB[upc]) return ITEM_DB[upc];
  if(CONFIG.LOOKUP_URL){
    try{
      const res = await fetch(`${CONFIG.LOOKUP_URL}?upc=${encodeURIComponent(upc)}`);
      if(res.ok){ const data = await res.json(); return data && Object.keys(data).length ? data : null; }
    }catch(e){}
  }
  return null;
}

function lockBrand(){ el('brand').readOnly = true; el('brandLockNote').classList.remove('hidden'); }
function unlockBrand(){ el('brand').readOnly = false; el('brandLockNote').classList.add('hidden'); }
function lockGender(){ el('gender').disabled = true; el('genderLockNote').classList.remove('hidden'); }
function unlockGender(){ el('gender').disabled = false; el('genderLockNote').classList.add('hidden'); }

// Long-press label to unlock (mobile-friendly)
function attachLongPressUnlock(){
  let timer = null;
  const press = (fn)=> (e)=>{ e.preventDefault(); timer = setTimeout(fn, 700); };
  const clear = ()=>{ if(timer) clearTimeout(timer); timer = null; };

  const lb = document.querySelector('label[for="brand"]');
  const lg = document.querySelector('label[for="gender"]');

  if(lb){
    lb.addEventListener('touchstart', press(unlockBrand), {passive:false});
    lb.addEventListener('mousedown',  press(unlockBrand));
    lb.addEventListener('touchend', clear); lb.addEventListener('mouseup', clear); lb.addEventListener('mouseleave', clear);
  }
  if(lg{
    // ensure element exists before attaching
  })
  if(lg){
    lg.addEventListener('touchstart', press(unlockGender), {passive:false});
    lg.addEventListener('mousedown',  press(unlockGender));
    lg.addEventListener('touchend', clear); lg.addEventListener('mouseup', clear); lg.addEventListener('mouseleave', clear);
  }
}

async function applyUPC(raw){
  const upc = (raw||'').replace(/\D/g,'').slice(0,14);
  if(!upc){return}
  el('upc').value = upc;

  const info = await lookupUPC(upc);
  if(info){
    if(info.brand){
      if(!el('brand').value){ el('brand').value = String(info.brand).toUpperCase(); }
      lockBrand();
    }
    if(info.gender){
      if(!el('gender').value){ el('gender').value = String(info.gender).toUpperCase(); }
      lockGender();
    }
    if(info.masterItemDesc && !el('itemDesc').value){ el('itemDesc').value = info.masterItemDesc; }
  }
  if(!el('scanModal').classList.contains('hidden')) closeScanner();
}

function applyLocation(raw){
  try{
    const loc = parseLocationCode(raw);
    for(let i=1;i<=9;i++){
      if(!el(`loc${i}_code`).value){ fillLoc(i, loc); break; }
    }
    closeScanner();
  }catch(err){ alert(err.message); }
}

function fillLoc(i, loc){
  el(`loc${i}_code`).value  = loc.code;
  el(`loc${i}_zone`).value  = loc.zone;
  el(`loc${i}_aisle`).value = loc.aisle;
  el(`loc${i}_rack`).value  = loc.rack;
  el(`loc${i}_shelf`).value = loc.shelf;
}

/***********************************
 * PAGE / UI
 ***********************************/
function goPage(n){
  activePage = n;
  el('page1').classList.toggle('hidden', n!==1);
  el('page2').classList.toggle('hidden', n!==2);
  el('pageIndicator').innerHTML = `Page <b>${n}</b> of 2`;
}

function buildLocations(){
  const host = el('locations');
  host.innerHTML = '';
  for(let i=1;i<=9;i++){
    const row = document.createElement('div');
    row.className = 'card';
    row.style.background = 'transparent';
    row.innerHTML = `
      <div class="grid-label">Location ${i}</div>
      <div class="row-6">
        <div><label>Location Code</label><input id="loc${i}_code" placeholder="e.g., C-01-05-02" /></div>
        <div><label>ZONE</label><input id="loc${i}_zone" /></div>
        <div><label>AISLE</label><input id="loc${i}_aisle" /></div>
        <div><label>RACK</label><input id="loc${i}_rack" /></div>
        <div><label>SHELF</label><input id="loc${i}_shelf" /></div>
        <div><label>Qty</label><input id="loc${i}_qty" type="number" min="0" value="0" /></div>
      </div>`;
    host.appendChild(row);
  }
}

/***********************************
 * EVENTS
 ***********************************/
document.addEventListener('DOMContentLoaded', ()=>{
  buildLocations();
  attachLongPressUnlock();

  // Box totals
  [1,2,3,4].forEach(i=>{
    ['s'+i+'_boxes','s'+i+'_qty'].forEach(id=> el(id).addEventListener('input', updateBoxTotals));
  });

  // Putaway qty & manual code parse
  for(let i=1;i<=9;i++){
    el(`loc${i}_qty`).addEventListener('input', reconcileTotals);
    el(`loc${i}_code`).addEventListener('change', (e)=>{
      const val = e.target.value;
      if(!val) return;
      try{ fillLoc(i, parseLocationCode(val)); }catch(err){ alert(err.message); }
      reconcileTotals();
    });
  }

  el('btnCheck').addEventListener('click', reconcileTotals);
  el('btnNext').addEventListener('click', ()=> goPage(2));
  el('btnBack').addEventListener('click', ()=> goPage(1));

  // Scanning controls
  el('btnScanUPC').addEventListener('click', ()=> openScanner('upc'));
  el('btnScanLoc').addEventListener('click', ()=> openScanner('location'));
  el('btnToggleCam').addEventListener('click', flipCamera);
  el('btnFlip').addEventListener('click', flipCamera);
  el('btnCloseScan').addEventListener('click', closeScanner);
  el('btnDone').addEventListener('click', closeScanner);

  // UPC generate & manual entry lookup
  el('btnGenUPC').addEventListener('click', ()=>{ const upc = genUPC12(); el('upc').value = upc; applyUPC(upc); });
  el('upc').addEventListener('change', (e)=> applyUPC(e.target.value));

  // Submit & offline
  el('btnDownload').addEventListener('click', downloadJSON);
  el('btnSubmitNext').addEventListener('click', submitNext);
});
</script>
</body>
</html>