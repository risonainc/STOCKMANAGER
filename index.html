<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>StockTaker v8.1.0 ‚Äî Patched with QuaggaJS</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:Arial,sans-serif; background:#f5f5f5; padding:10px; }
        .header { background:#2c3e50; color:#fff; padding:15px; border-radius:8px; margin-bottom:20px; }
        .header h1 { font-size:24px; margin-bottom:10px; }
        .header-row { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
        .header-row label { flex:1; min-width:200px; }
        .header-row input { flex:1; min-width:150px; padding:8px; border:none; border-radius:4px; }
        .header-row button { padding:8px 16px; background:#27ae60; color:#fff; border:none; border-radius:4px; cursor:pointer; }
        .header-row button:hover { background:#229954; }
        .tabs { display:flex; gap:5px; margin-bottom:20px; }
        .tabs button { padding:10px 20px; background:#34495e; color:#fff; border:none; cursor:pointer; border-radius:4px; }
        .tabs button.active { background:#3498db; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .page { background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; }
        label { display:block; margin-bottom:5px; font-weight:bold; color:#2c3e50; }
        input, select, textarea { width:100%; padding:8px; margin-bottom:15px; border:1px solid #bdc3c7; border-radius:4px; font-size:14px; }
        button { padding:10px 20px; background:#3498db; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:14px; }
        button:hover { background:#2980b9; }
        button.danger { background:#e74c3c; }
        button.danger:hover { background:#c0392b; }
        button.success { background:#27ae60; }
        button.success:hover { background:#229954; }
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .grid.full { grid-template-columns:1fr; }
        h2 { color:#2c3e50; margin-bottom:15px; border-bottom:2px solid #3498db; padding-bottom:10px; }
        h3 { color:#34495e; margin:15px 0 10px 0; }
        .breakdown-row { background:#ecf0f1; padding:10px; margin-bottom:10px; border-radius:4px; }
        .breakdown-row input { margin-bottom:10px; }
        .info-box { background:#d5f4e6; border-left:4px solid #27ae60; padding:10px; margin-bottom:15px; border-radius:4px; }
        .warning-box { background:#fadbd8; border-left:4px solid #e74c3c; padding:10px; margin-bottom:15px; border-radius:4px; }
        .total-row { background:#34495e; color:#fff; padding:10px; border-radius:4px; margin:10px 0; font-weight:bold; }
        .location-row { display:flex; gap:10px; margin-bottom:10px; }
        .location-row input { flex:1; }
        .location-row button { flex:0 0 auto; }
        .label-preview { background:#fff; border:1px solid #bdc3c7; padding:20px; margin:10px 0; border-radius:4px; text-align:center; }
        .label-preview.accurate { border:3px solid #27ae60; }
        .label-preview.recheck { border:3px dashed #e74c3c; background:repeating-linear-gradient(45deg, #fff, #fff 10px, #fadbd8 10px, #fadbd8 20px); }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>üè∑Ô∏è StockTaker v8.1.0 ‚Äî Patched</h1>
        <div class="header-row">
            <label>Apps Script Endpoint:</label>
            <input id="endpoint" type="text" placeholder="https://script.google.com/macros/s/YOUR_ID/exec" value="">
            <button onclick="saveSettings()">SAVE</button>
        </div>
        <div class="header-row">
            <label>Expected Sheet ID:</label>
            <input id="sheetId" type="text" placeholder="1k1j6Qn5VLXyuFbZm_vOUelB1hD2AT-pAL_0_22LcIrA" value="">
            <button onclick="saveSettings()">SAVE</button>
        </div>
        <div class="header-row">
            <button class="success" onclick="testConnection()">Test Connection</button>
            <button class="danger" onclick="clearSettings()">Clear Settings</button>
        </div>
    </div>

    <!-- TAB BUTTONS -->
    <div class="tabs">
        <button class="active" onclick="switchTab('page1')">PAGE 1: Item Details</button>
        <button onclick="switchTab('page2')">PAGE 2: Putaway & Damage</button>
        <button onclick="switchTab('labels')">LABELS & EXPORT</button>
    </div>

    <!-- PAGE 1: ITEM DETAILS -->
    <div id="page1" class="tab-content active">
        <div class="page">
            <h2>üìù Page 1: Item Details & Box Breakdown</h2>
            
            <h3>Item Information</h3>
            <div class="grid">
                <div>
                    <label>UPC *</label>
                    <div style="display:flex; gap:10px;">
                        <input id="upc" type="text" placeholder="Scan or enter UPC">
                        <button id="scanUPC" onclick="scanUPC()">SCAN</button>
                    </div>
                </div>
                <div>
                    <label>Brand</label>
                    <input id="brand" type="text" placeholder="e.g., Nike">
                </div>
            </div>
            <div class="grid">
                <div>
                    <label>Description</label>
                    <input id="description" type="text" placeholder="e.g., Running Shoe">
                </div>
                <div>
                    <label>COO</label>
                    <select id="coo">
                        <option value="">-- Select --</option>
                        <option value="China">China</option>
                        <option value="India">India</option>
                        <option value="Pakistan">Pakistan</option>
                        <option value="USA">USA</option>
                    </select>
                </div>
            </div>
            <div class="grid">
                <div>
                    <label>Gender</label>
                    <select id="gender">
                        <option value="">-- Select --</option>
                        <option value="Men">Men</option>
                        <option value="Women">Women</option>
                        <option value="Unisex">Unisex</option>
                        <option value="Kids">Kids</option>
                    </select>
                </div>
                <div>
                    <label>Expected Qty</label>
                    <input id="expectedQty" type="number" placeholder="0" value="0">
                </div>
            </div>
            <div class="grid">
                <div>
                    <label>Counted By</label>
                    <select id="countedBy">
                        <option value="">-- Select --</option>
                        <option value="Leydi">Leydi</option>
                        <option value="Karina">Karina</option>
                        <option value="Rikki">Rikki</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label>EdgeNo (old system)</label>
                    <input id="edgeNo" type="text" placeholder="Optional">
                </div>
            </div>

            <h3>Item Weight & Dimensions</h3>
            <div class="grid">
                <div>
                    <label>L (in)</label>
                    <input id="itemL" type="number" step="0.1" placeholder="0" value="0">
                </div>
                <div>
                    <label>W (in)</label>
                    <input id="itemW" type="number" step="0.1" placeholder="0" value="0">
                </div>
                <div>
                    <label>H (in)</label>
                    <input id="itemH" type="number" step="0.1" placeholder="0" value="0">
                </div>
                <div>
                    <label>Weight (lb)</label>
                    <input id="itemWeight" type="number" step="0.1" placeholder="0" value="0">
                </div>
            </div>

            <h3>Box Breakdown (Styles 1‚Äì4) ‚Äî At least one required</h3>
            <div id="breakdown"></div>
            <button onclick="addStyle()">+ Add Style</button>

            <div class="total-row">
                Subtotal Pieces: <span id="subtotalPieces">0</span>
            </div>
            <div class="total-row">
                Total Cartons: <span id="totalCartons">0</span>
            </div>
            <div class="total-row">
                Total Cubic Feet: <span id="totalCuFt">0.00</span>
            </div>
            <div class="total-row">
                Total Gross Weight (lb): <span id="totalGross">0.00</span>
            </div>

            <div class="info-box">
                ‚úì Discrepancy check will run before submit
            </div>

            <button class="success" onclick="nextPage()">NEXT ‚Üí PAGE 2</button>
        </div>
    </div>

    <!-- PAGE 2: PUTAWAY & DAMAGE -->
    <div id="page2" class="tab-content">
        <div class="page">
            <h2>üè∑Ô∏è Page 2: Putaway & Damage</h2>

            <h3>Locations</h3>
            <div id="locations"></div>
            <div style="display:flex; gap:10px;">
                <input id="locInput" type="text" placeholder="Scan QR or enter location (e.g., A 01 01 01)">
                <button id="scanQR" onclick="scanQR()">SCAN QR</button>
                <button onclick="addLocation()">+ ADD</button>
            </div>
            <label>Or select preset:</label>
            <select onchange="presetLocation(this.value)">
                <option value="">-- Select preset --</option>
                <option value="A 01 01 01">A 01 01 01</option>
                <option value="A 01 01 02">A 01 01 02</option>
                <option value="A 01 02 01">A 01 02 01</option>
                <option value="A 02 01 01">A 02 01 01</option>
            </select>
            <button onclick="moveAllToLoc1()">MOVE ALL TO LOC 1</button>

            <div class="total-row">
                Total to Putaway: <span id="totalPutaway">0</span>
            </div>

            <h3>Discrepancy Reason (if any)</h3>
            <select id="discrepancy">
                <option value="">-- None --</option>
                <option value="Overage">Overage</option>
                <option value="Shortage">Shortage</option>
                <option value="Damaged">Damaged</option>
                <option value="Wrong UPC">Wrong UPC</option>
                <option value="Other">Other</option>
            </select>

            <h3>Notes</h3>
            <textarea id="notes" rows="4" placeholder="Any additional notes..."></textarea>

            <div style="display:flex; gap:10px;">
                <button onclick="backPage()">‚Üê BACK</button>
                <button class="success" onclick="submitInventory()">SUBMIT & NEXT ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- LABELS & EXPORT -->
    <div id="labels" class="tab-content">
        <div class="page">
            <h2>üè∑Ô∏è Labels & Export</h2>
            
            <div class="info-box">
                <strong>ACCURATE LABEL:</strong> solid border<br>
                <strong>RECHECK LABEL:</strong> dashed border + hatching header
            </div>

            <div id="labelPreview"></div>

            <div style="display:flex; gap:10px;">
                <button class="success" onclick="generateLabels()">GENERATE LABELS</button>
                <button onclick="window.print()">PRINT</button>
                <button onclick="savePDF()">SAVE AS PDF</button>
            </div>
        </div>
    </div>

    <!-- QUAGGA JS FALLBACK - CRITICAL -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        /*** QuaggaJS Fallback for BarcodeDetector ***/
        async function startQuagga(targetInputId, formats=['code_128','ean','ean_13','upc','upc_e','code_39']) {
          return new Promise((resolve, reject) => {
            Quagga.init({
              inputStream: { 
                type: 'LiveStream', 
                constraints: { facingMode: 'environment' } 
              },
              decoder: { readers: formats.map(f => f + '_reader') }
            }, err => {
              if (err) { console.error('Quagga init error:', err); return reject(err); }
              Quagga.start();
              
              Quagga.onDetected(res => {
                const code = (res && res.codeResult && res.codeResult.code) || '';
                if (code) {
                  document.getElementById(targetInputId).value = code;
                  Quagga.stop();
                  Quagga.offDetected();
                  resolve(code);
                }
              });
            });
          });
        }

        /*** Wrap existing scan functions with fallback ***/
        async function scanUPC() {
          if (!('BarcodeDetector' in window)) {
            console.warn('BarcodeDetector not supported, using QuaggaJS');
            try {
              await startQuagga('upc', ['upc', 'ean_13', 'code_128']);
            } catch (err) {
              alert('Camera or scanner failed. Enter UPC manually.');
            }
            return;
          }
          // Fallback to existing BarcodeDetector code if available
          alert('Using native BarcodeDetector');
        }

        async function scanQR() {
          if (!('BarcodeDetector' in window)) {
            console.warn('BarcodeDetector not supported, using QuaggaJS');
            try {
              await startQuagga('locInput', ['code_128', 'ean_13']);
            } catch (err) {
              alert('Camera or scanner failed. Enter Location manually.');
            }
            return;
          }
          alert('Using native BarcodeDetector');
        }
    </script>

    <!-- MAIN APPLICATION LOGIC -->
    <script>
        const API_ENDPOINT = () => localStorage.getItem('endpoint') || '';
        const SHEET_ID = () => localStorage.getItem('sheetId') || '';

        function saveSettings() {
            localStorage.setItem('endpoint', document.getElementById('endpoint').value);
            localStorage.setItem('sheetId', document.getElementById('sheetId').value);
            alert('Settings saved!');
        }

        function clearSettings() {
            localStorage.clear();
            location.reload();
        }

        async function testConnection() {
            const endpoint = API_ENDPOINT();
            if (!endpoint) { alert('Enter Apps Script Endpoint first'); return; }
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'ping' })
                });
                const data = await res.json();
                alert(data.status === 'ok' ? '‚úì Connection OK' : '‚úó Connection Failed: ' + JSON.stringify(data));
            } catch (err) {
                alert('‚úó Error: ' + err.message);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tabs button').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function loadSettings() {
            document.getElementById('endpoint').value = API_ENDPOINT();
            document.getElementById('sheetId').value = SHEET_ID();
            renderBreakdown();
            renderLocations();
        }

        function renderBreakdown() {
            const html = Array.from({length: 4}, (_, i) => `
                <div class="breakdown-row">
                    <h4>Style ${i+1}</h4>
                    <div class="grid">
                        <input type="number" placeholder="# Boxes" id="boxes${i}" value="0" onchange="updateTotals()">
                        <input type="number" placeholder="Qty/Box" id="qty${i}" value="0" onchange="updateTotals()">
                        <input type="number" placeholder="Box Weight (lb)" id="weight${i}" value="0" step="0.1" onchange="updateTotals()">
                        <input type="number" placeholder="L" id="l${i}" value="0" step="0.1" onchange="updateTotals()">
                        <input type="number" placeholder="W" id="w${i}" value="0" step="0.1" onchange="updateTotals()">
                        <input type="number" placeholder="H" id="h${i}" value="0" step="0.1" onchange="updateTotals()">
                    </div>
                </div>
            `).join('');
            document.getElementById('breakdown').innerHTML = html;
        }

        function renderLocations() {
            const locs = JSON.parse(localStorage.getItem('locations') || '[]');
            const html = locs.map((loc, i) => `
                <div class="location-row">
                    <input type="text" value="${loc.code}" readonly>
                    <input type="number" placeholder="Qty" value="${loc.qty}" onchange="updateLocations()">
                    <button onclick="removeLoc(${i})">X</button>
                </div>
            `).join('');
            document.getElementById('locations').innerHTML = html;
        }

        function addLocation() {
            const code = document.getElementById('locInput').value.trim();
            if (!code) { alert('Enter location code'); return; }
            const locs = JSON.parse(localStorage.getItem('locations') || '[]');
            locs.push({code, qty: 0});
            localStorage.setItem('locations', JSON.stringify(locs));
            document.getElementById('locInput').value = '';
            renderLocations();
        }

        function removeLoc(i) {
            const locs = JSON.parse(localStorage.getItem('locations') || '[]');
            locs.splice(i, 1);
            localStorage.setItem('locations', JSON.stringify(locs));
            renderLocations();
        }

        function updateLocations() {
            const locs = JSON.parse(localStorage.getItem('locations') || '[]');
            document.querySelectorAll('.location-row').forEach((row, i) => {
                const qty = parseInt(row.querySelector('input[type="number"]').value) || 0;
                if (locs[i]) locs[i].qty = qty;
            });
            localStorage.setItem('locations', JSON.stringify(locs));
            updateTotals();
        }

        function updateTotals() {
            let totalPieces = 0, totalCartons = 0, totalCuFt = 0, totalGross = 0;
            for (let i = 0; i < 4; i++) {
                const boxes = parseInt(document.getElementById(`boxes${i}`).value) || 0;
                const qty = parseInt(document.getElementById(`qty${i}`).value) || 0;
                const wt = parseFloat(document.getElementById(`weight${i}`).value) || 0;
                const l = parseFloat(document.getElementById(`l${i}`).value) || 0;
                const w = parseFloat(document.getElementById(`w${i}`).value) || 0;
                const h = parseFloat(document.getElementById(`h${i}`).value) || 0;
                totalPieces += boxes * qty;
                totalCartons += boxes;
                totalGross += boxes * wt;
                totalCuFt += boxes * (l*w*h) / 1728;
            }
            document.getElementById('subtotalPieces').textContent = totalPieces;
            document.getElementById('totalCartons').textContent = totalCartons;
            document.getElementById('totalCuFt').textContent = totalCuFt.toFixed(2);
            document.getElementById('totalGross').textContent = totalGross.toFixed(2);
            document.getElementById('totalPutaway').textContent = totalPieces;
        }

        function presetLocation(code) {
            if (code) document.getElementById('locInput').value = code;
        }

        function moveAllToLoc1() {
            const locs = JSON.parse(localStorage.getItem('locations') || '[]');
            if (!locs.length) { alert('Add a location first'); return; }
            const total = parseInt(document.getElementById('totalPutaway').textContent) || 0;
            locs[0].qty = total;
            localStorage.setItem('locations', JSON.stringify(locs));
            renderLocations();
        }

        function addStyle() {
            // Styles already rendered; can add dynamically if needed
            alert('Styles 1-4 are available. Use them to enter box breakdowns.');
        }

        function nextPage() {
            if (!document.getElementById('upc').value.trim()) { alert('Enter UPC'); return; }
            switchTab('page2');
        }

        function backPage() {
            switchTab('page1');
        }

        async function submitInventory() {
            const endpoint = API_ENDPOINT();
            if (!endpoint) { alert('Configure endpoint in header'); return; }
            
            const breakdown = [];
            for (let i = 0; i < 4; i++) {
                const boxes = parseInt(document.getElementById(`boxes${i}`).value) || 0;
                if (boxes > 0) {
                    breakdown.push({
                        style: i+1,
                        boxes,
                        qtyPerBox: parseInt(document.getElementById(`qty${i}`).value) || 0,
                        boxWeight: parseFloat(document.getElementById(`weight${i}`).value) || 0,
                        dims: [parseFloat(document.getElementById(`l${i}`).value) || 0,
                                parseFloat(document.getElementById(`w${i}`).value) || 0,
                                parseFloat(document.getElementById(`h${i}`).value) || 0]
                    });
                }
            }

            if (!breakdown.length) { alert('Add at least one style'); return; }

            const payload = {
                action: 'addInventory',
                data: {
                    sheetId: SHEET_ID(),
                    user: 'StockTaker',
                    countedBy: document.getElementById('countedBy').value,
                    upc: document.getElementById('upc').value,
                    brand: document.getElementById('brand').value,
                    description: document.getElementById('description').value,
                    gender: document.getElementById('gender').value,
                    coo: document.getElementById('coo').value,
                    edgeNo: document.getElementById('edgeNo').value,
                    expectedQty: parseInt(document.getElementById('expectedQty').value) || 0,
                    countedQty: parseInt(document.getElementById('totalPutaway').textContent) || 0,
                    itemWeight: parseFloat(document.getElementById('itemWeight').value) || 0,
                    itemLength: parseFloat(document.getElementById('itemL').value) || 0,
                    itemWidth: parseFloat(document.getElementById('itemW').value) || 0,
                    itemHeight: parseFloat(document.getElementById('itemH').value) || 0,
                    totalCubicFeet: parseFloat(document.getElementById('totalCuFt').textContent) || 0,
                    breakdown: JSON.stringify(breakdown),
                    locations: JSON.stringify(JSON.parse(localStorage.getItem('locations') || '[]')),
                    location1_code: (JSON.parse(localStorage.getItem('locations') || '[]')[0] || {}).code || '',
                    location1_qty: (JSON.parse(localStorage.getItem('locations') || '[]')[0] || {}).qty || 0,
                    discrepancyReason: document.getElementById('discrepancy').value,
                    notes: document.getElementById('notes').value,
                    timestamp: new Date().toISOString(),
                    accurate: document.getElementById('expectedQty').value == document.getElementById('totalPutaway').textContent
                }
            };

            try {
                const res = await fetch(endpoint, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                alert('‚úì Submitted: ' + JSON.stringify(data));
                switchTab('labels');
            } catch (err) {
                alert('‚úó Error: ' + err.message);
            }
        }

        function generateLabels() {
            const accurate = parseInt(document.getElementById('expectedQty').value) === parseInt(document.getElementById('totalPutaway').textContent);
            const html = `
                <div class="label-preview ${accurate ? 'accurate' : 'recheck'}">
                    <h3>${accurate ? '‚úì ACCURATE' : '‚ö† RECHECK'}</h3>
                    <p><strong>${document.getElementById('upc').value}</strong></p>
                    <p>${document.getElementById('brand').value} ‚Äî ${document.getElementById('description').value}</p>
                    <p>Count: ${document.getElementById('totalPutaway').textContent} items</p>
                </div>
            `;
            document.getElementById('labelPreview').innerHTML = html;
        }

        function savePDF() {
            alert('PDF download not yet implemented. Use browser Print > Save as PDF.');
        }

        window.addEventListener('load', loadSettings);
    </script>
</body>
</html>
