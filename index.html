<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>StockTaker v7.0.2 ‚Äî PRODUCTION (PDF + Camera Safe Close + Box Weight)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#f7f7fb; --fg:#111827; --muted:#6b7280; --line:#e6e6ef;
    --green:#047857; --red:#dc2626; --amber:#b45309; --blue:#2563eb;
    --label-w: 6in; --label-h: 4in; --m: .25in;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { margin: 0; background: var(--bg); color: var(--fg); font: 14px/1.35 Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
  header { position: sticky; top: 0; z-index: 10; background: #111827; color: #fff; padding: 12px 16px; box-shadow: 0 1px 2px rgba(0,0,0,.1); }
  header h1 { margin: 0; font-size: 18px; font-weight: 800; }
  header small { color: #cbd5e1; }
  main { padding: 16px; max-width: 1200px; margin: 0 auto; }
  .grid { display: grid; gap: 12px; }
  .cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
  .cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
  .cols-4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
  @media (max-width: 900px){ .cols-4 { grid-template-columns: 1fr 1fr; } }
  @media (max-width: 640px){ .cols-2,.cols-3,.cols-4 { grid-template-columns: 1fr; } }

  .card { background: #fff; border: 1px solid var(--line); border-radius: 10px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
  h2 { margin: 0 0 12px; font-size: 16px; }
  h3 { margin: 12px 0 8px; font-size: 14px; color: #111; }
  label { display: block; font-size: 12px; color: #374151; margin-bottom: 4px; }
  input, select, textarea, button { font: inherit; }
  input[type=text], input[type=password], input[type=number], select, textarea { width: 100%; border:1px solid #cbd5e1; border-radius:8px; padding:10px; background:#fff; }
  textarea { min-height: 70px; }
  .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .btn { border:1px solid #111827; background:#111827; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; }
  .btn.secondary { background:#fff; color:#111827; }
  .btn.success { background: var(--green); border-color: var(--green); }
  .btn.warn { background: var(--amber); border-color: var(--amber); }
  .btn.red { background: var(--red); border-color: var(--red); }
  .btn:disabled { opacity: .5; cursor: not-allowed; }
  .muted { color: var(--muted); }
  .ok { color: var(--green); }
  .bad { color: var(--red); }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#f9fafb; }

  /* Tabs & pages */
  .tabs { display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap; }
  .tab { padding:8px 10px; border-radius:999px; border:1px solid var(--line); cursor:pointer; background:#fff; }
  .tab.active { background:#111827; color:#fff; border-color:#111827; }
  .page { display:none; }
  .page.active { display:block; }

  /* Scanner overlay (Safe Close) */
  #scannerModal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; }
  #scannerModal.show { display:flex; }
  #scannerBackdrop { position:fixed; inset:0; }
  #scannerShell { position:relative; z-index:1002; width:min(820px,95vw); background:#111827; border-radius:12px; padding:12px; }
  #scannerHeader { display:flex; justify-content:space-between; align-items:center; color:#fff; }
  #scannerViewport { position:relative; width:100%; aspect-ratio:4/3; background:#000; border-radius:10px; overflow:hidden; margin-top:8px; }
  #scanBox { position:absolute; border:3px solid rgba(0,255,0,.9); width:70%; height:38%; left:15%; top:31%; box-shadow:0 0 0 200vmax rgba(0,0,0,.4); }
  #btnCloseScanner { position:absolute; top:8px; right:8px; z-index:1003; }

  /* Print-only system */
  #printSandbox { display:none; }
  .label { width: var(--label-w); height: var(--label-h); padding: var(--m); box-sizing: border-box; background:#fff;
           border: 4px solid #000; position:relative; break-after: page; page-break-after: always; }
  .label.recheck { border-style: dashed; }
  .label .hdr { text-align:center; font-weight:800; font-size:22px; margin-bottom:6px; }
  .label .grid { display:grid; grid-template-columns: 1.4fr .6fr; gap:8px; }
  .label .big { font-size:18px; font-weight:800; }
  .label .footer { position:absolute; left: var(--m); right: var(--m); bottom: var(--m); font-size:12px; display:flex; justify-content:space-between; }

  @media print {
    @page { size: 6in 4in landscape; margin: 0; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    header, .noprint, #appChrome { display:none !important; }
    #printSandbox { display:block; }
  }
</style>
</head>
<body>
<header>
  <h1>üì¶ StockTaker v7.0.2 ‚Äî PRODUCTION <small class="muted">(PDF + Camera Safe Close + Box Weight)</small></h1>
</header>

<main>
  <!-- Access & Config -->
  <section class="card" id="accessCard">
    <h2>Access & Configuration <span class="pill"><span id="pageIndicator">Page 0 of 2</span></span></h2>
    <div class="grid cols-3">
      <div>
        <label for="username">Logged in as</label>
        <select id="username">
          <option value="">‚Äî Select ‚Äî</option>
          <option>Rikki</option><option>Alberto</option><option>Isabella</option><option>Kelis</option>
          <option>Leydi</option><option>Veronica</option><option>Mabel</option><option>Jocelyn</option>
        </select>
      </div>
      <div>
        <label for="password">Password (username backwards)</label>
        <input id="password" type="password" autocomplete="current-password" />
        <div class="muted" id="pwHint" style="margin-top:4px;">Hint: Rikki ‚Üí <b>ikkiR</b></div>
      </div>
      <div>
        <label for="counter">Counted By</label>
        <select id="counter">
          <option>‚Äî Select Counter ‚Äî</option>
          <option>Leydi</option><option>Karina</option><option>Jocelyn</option><option>Kelis</option><option>Mabel</option>
        </select>
      </div>
    </div>
    <div class="grid cols-3" style="margin-top:8px;">
      <div>
        <label for="endpoint">Google Apps Script Endpoint</label>
        <input type="text" id="endpoint" placeholder="https://script.google.com/macros/s/AKfycbzaWlUf2mpylRpOYTOzl2rxOK71oGM6clodLf18iY51Ina52-2YbKcT2b2HKVEnT6MihA/exec" value="https://script.google.com/macros/s/AKfycbzaWlUf2mpylRpOYTOzl2rxOK71oGM6clodLf18iY51Ina52-2YbKcT2b2HKVEnT6MihA/exec" oninput="document.getElementById('connMsg').textContent=this.value?'Ready to connect to your Google Sheet':''" />
      </div>
      <div>
        <label for="sheetId">Expected Inventory Sheet ID</label>
        <input type="text" id="sheetId" value="1k1j6Qn5VLXyuFbZm_vOUelB1hD2AT-pAL_0_22LcIrA" />
      </div>
      <div class="row" style="align-items:flex-end;">
        <button class="btn" id="btnPing">Test Connection</button>
        <button class="btn secondary" id="btnLoadExpected">Load Expected Inventory</button>
        <span id="connMsg" class="muted"></span>
      </div>
    </div>
    <div class="row" style="margin-top:6px;">
      <span class="pill">Progress: <b id="progressNow">0</b> of <b id="progressTotal">0</b></span>
      <span class="pill">Login: <span id="loginStatus" class="bad">Locked</span></span>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="btn" id="btnUnlock">Unlock</button>
      <button class="btn secondary" id="btnLogout">Logout</button>
      <span id="authMsg" class="muted"></span>
    </div>
  </section>

  <section class="card" id="appChrome">
    <div class="tabs">
      <div class="tab active" data-target="#page1">üìù Page 1: Item Details & Box Breakdown</div>
      <div class="tab" data-target="#page2">üìç Page 2: Putaway & Labels</div>
    </div>

    <!-- PAGE 1 -->
    <div class="page active" id="page1">
      <h2>Item Information</h2>
      <div class="grid cols-3">
        <div>
          <label for="upc">Scan/Enter UPC</label>
          <div class="row">
            <input type="text" id="upc" placeholder="885123456789" />
            <button class="btn" id="btnScanUPC">üì∑ Scan</button>
            <button class="btn secondary" id="btnGenUPC">üîÑ Gen</button>
          </div>
        </div>
        <div>
          <label for="expectedQty">Expected Qty (from upload)</label>
          <input type="number" id="expectedQty" value="0" />
        </div>
        <div>
          <label for="edgeNo">EdgeNo (from old system)</label>
          <input type="text" id="edgeNo" />
        </div>
      </div>

      <div class="grid cols-4" style="margin-top:8px;">
        <div><label>Brand</label><input id="brand" type="text" /></div>
        <div><label>Gender</label>
          <select id="gender"><option></option><option>MENS</option><option>LADIES</option><option>UNISEX</option></select>
        </div>
        <div><label>COO</label>
          <select id="coo"><option></option><option>USA</option><option>CHINA</option><option>VIETNAM</option><option>INDIA</option><option>MEXICO</option><option>FRANCE</option><option>ITALY</option><option>GERMANY</option><option>POLAND</option><option>UAE</option><option>UK</option><option>SPAIN</option><option>PORTUGAL</option><option>NETHERLANDS</option><option>SWITZERLAND</option><option>TURKEY</option><option>MOROCCO</option><option>OMAN</option></select>
        </div>
        <div><label>Item Description</label><input id="itemDesc" type="text" /></div>
      </div>

      <h3>Box Breakdown (Styles 1‚Äì4) <span class="muted">(At least one required)</span></h3>
      <div class="grid cols-4">
        <div class="card" style="padding:10px;">
          <label>Style 1: Boxes √ó Qty/Box</label>
          <div class="row"><input id="s1_boxes" type="number" min="0" value="0" style="width:100px;"/>√ó<input id="s1_qpb" type="number" min="0" value="0" style="width:100px;"/></div>
          <label class="muted">Box Dimensions (L√óW√óH in)</label>
          <div class="row"><input id="s1_l" type="number" step="0.01" style="width:80px;"/>√ó<input id="s1_w" type="number" step="0.01" style="width:80px;"/>√ó<input id="s1_h" type="number" step="0.01" style="width:80px;"/></div>
          <label class="muted">Box Weight (lb)</label>
          <div class="row"><input id="s1_bw" type="number" step="0.01" style="width:160px;"/></div>
        </div>
        <div class="card" style="padding:10px;">
          <label>Style 2: Boxes √ó Qty/Box</label>
          <div class="row"><input id="s2_boxes" type="number" min="0" value="0" style="width:100px;"/>√ó<input id="s2_qpb" type="number" min="0" value="0" style="width:100px;"/></div>
          <label class="muted">Box Dimensions (L√óW√óH in)</label>
          <div class="row"><input id="s2_l" type="number" step="0.01" style="width:80px;"/>√ó<input id="s2_w" type="number" step="0.01" style="width:80px;"/>√ó<input id="s2_h" type="number" step="0.01" style="width:80px;"/></div>
          <label class="muted">Box Weight (lb)</label>
          <div class="row"><input id="s2_bw" type="number" step="0.01" style="width:160px;"/></div>
        </div>
        <div class="card" style="padding:10px;">
          <label>Style 3: Boxes √ó Qty/Box</label>
          <div class="row"><input id="s3_boxes" type="number" min="0" value="0" style="width:100px;"/>√ó<input id="s3_qpb" type="number" min="0" value="0" style="width:100px;"/></div>
          <label class="muted">Box Dimensions (L√óW√óH in)</label>
          <div class="row"><input id="s3_l" type="number" step="0.01" style="width:80px;"/>√ó<input id="s3_w" type="number" step="0.01" style="width:80px;"/>√ó<input id="s3_h" type="number" step="0.01" style="width:80px;"/></div>
          <label class="muted">Box Weight (lb)</label>
          <div class="row"><input id="s3_bw" type="number" step="0.01" style="width:160px;"/></div>
        </div>
        <div class="card" style="padding:10px;">
          <label>Style 4: Boxes √ó Qty/Box</label>
          <div class="row"><input id="s4_boxes" type="number" min="0" value="0" style="width:100px;"/>√ó<input id="s4_qpb" type="number" min="0" value="0" style="width:100px;"/></div>
          <label class="muted">Box Dimensions (L√óW√óH in)</label>
          <div class="row"><input id="s4_l" type="number" step="0.01" style="width:80px;"/>√ó<input id="s4_w" type="number" step="0.01" style="width:80px;"/>√ó<input id="s4_h" type="number" step="0.01" style="width:80px;"/></div>
          <label class="muted">Box Weight (lb)</label>
          <div class="row"><input id="s4_bw" type="number" step="0.01" style="width:160px;"/></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px; gap:16px; flex-wrap:wrap;">
        <div class="pill">Subtotal Pieces: <b id="subtotalPieces">0</b></div>
        <div class="pill">Total Cubic Feet: <b id="totalCft">0.00</b></div>
        <div class="pill">Total Gross Weight (lb): <b id="totalGw">0.00</b></div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnCheckDiscrepancy">‚ö†Ô∏è Check Discrepancy</button>
        <button class="btn success" id="btnNextToPage2">‚úì Next ‚Üí Page 2</button>
        <span id="discMsg" class="muted"></span>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="page" id="page2">
      <h2>Summary from Page 1</h2>
      <div class="grid cols-3">
        <div><label>UPC</label><input id="sum_upc" type="text" disabled /></div>
        <div><label>Qty</label><input id="sum_qty" type="number" disabled /></div>
        <div><label>Breakdown</label><input id="sum_breakdown" type="text" disabled /></div>
      </div>

      <h3>Putaway Location(s)</h3>
      <div class="row">
        <button class="btn" id="btnScanLoc">üì∏ Scan Location QR</button>
        <select id="presetLoc">
          <option value="">Select preset...</option>
          <option>INBOUND - SOLD</option><option>PUT AWAY</option><option>INCOMING</option>
        </select>
        <button class="btn secondary" id="btnAddLoc">+ Add Location</button>
        <button class="btn secondary" id="btnMoveAll">Move All to Loc 1</button>
      </div>
      <div id="locations"></div>

      <h3>‚ö†Ô∏è Damage Breakdown (Counted: <span id="countedTotal">0</span>)</h3>
      <div class="grid cols-4">
        <div><label>Good / Saleable</label><input id="goodQty" type="number" min="0" value="0" /></div>
        <div><label>Damaged (Unbox & Sell)</label><input id="damageSellQty" type="number" min="0" value="0" /></div>
        <div><label>Damaged (Dispose - Leaking)</label><input id="damageDisposeQty" type="number" min="0" value="0" /></div>
        <div class="row"><div class="pill">Total: <b id="damageTotal">0</b></div></div>
      </div>

      <div class="grid cols-2" style="margin-top:8px;">
        <div><label>OK to Submit?</label>
          <select id="okToSubmit"><option>No</option><option>Yes</option></select>
        </div>
        <div><label>Notes</label><textarea id="notes"></textarea></div>
      </div>

      <div id="discArea" class="hidden" style="margin-top:6px;">
        <h3>‚ö†Ô∏è Inventory Discrepancy Detected</h3>
        <label>Please select reason for discrepancy:</label>
        <select id="discReason">
          <option></option>
          <option>Pending Recount</option>
          <option>Friend/Family Purchase</option>
          <option>Damaged Goods</option>
          <option>Long Time Discrepancy</option>
          <option>Investigate</option>
          <option>Other (explain in notes)</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" id="btnBackToPage1">‚Üê Back to Page 1</button>
        <button class="btn" id="btnDownloadJson">üì• Download JSON</button>
        <button class="btn success" id="btnSubmit">‚úì Submit to Sheet</button>
      </div>

      <h2 style="margin-top:16px;">üè∑Ô∏è INVENTORIED LABEL ‚Äî 6√ó4 Landscape</h2>
      <div class="row noprint">
        <button class="btn" id="btnGenerateLabels">üñ®Ô∏è Generate Labels</button>
        <button class="btn" id="btnPrintLabels" disabled>üñ®Ô∏è Print Labels</button>
        <button class="btn secondary" id="btnSavePDF" disabled>üíæ Save as PDF</button>
        <span id="printMsg" class="muted"></span>
      </div>
    </div>
  </section>
</main>

<!-- Scanner Modal (SAFE CLOSE) -->
<div id="scannerModal" aria-modal="true" role="dialog">
  <div id="scannerBackdrop"></div>
  <div id="scannerShell">
    <div id="scannerHeader">
      <div><b>üì∑ Camera Scanner</b> <span id="scanState" class="muted">(initializing‚Ä¶)</span></div>
      <div class="row">
        <label class="pill" style="color:#111;">
          <input type="checkbox" id="useFront" /> Use Front Camera
        </label>
        <button class="btn secondary" id="btnCloseScanner">‚úï Close</button>
      </div>
    </div>
    <div id="scannerViewport"></div>
    <div id="scanBox"></div>
    <div id="scannerControls">
      <button class="btn" id="btnStartScan">Start</button>
      <button class="btn secondary" id="btnStopScan">Stop</button>
      <span id="scanMsg" class="muted" style="color:#cbd5e1;"></span>
    </div>
  </div>
</div>

<!-- PRINT-ONLY CONTAINER -->
<div id="printSandbox"></div>

<!-- External libs -->
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Save as PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(function(){
  const el = id => document.getElementById(id);
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // --- STATE ---
  const state = {
    expectedMap: new Map(), // upc -> details
    discrepancy: false,
    labelsReady: false,
  };

  // --- HELPERS ---
  function reverse(s){ return (s||'').split('').reverse().join(''); }
  function nowIso(){ return new Date().toISOString(); }
  function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  function toNumber(v){ const n = Number(v||0); return Number.isFinite(n)?n:0; }
  function cft(l,w,h){ const cf = (toNumber(l)*toNumber(w)*toNumber(h))/1728; return isFinite(cf)?cf:0; }
  function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.1, ctx.currentTime); o.start(); setTimeout(()=>{o.stop();ctx.close();},130);}catch(e){} }
  function setPage(n){ el('pageIndicator').textContent = `Page ${n} of 2`; }

  // --- LOGIN ---
  function updateAuthUI(unlocked){
    el('loginStatus').textContent = unlocked? 'Unlocked' : 'Locked';
    el('loginStatus').className = unlocked? 'ok' : 'bad';
    $('#appChrome').style.pointerEvents = unlocked? 'auto' : 'none';
    $('#appChrome').style.opacity = unlocked? '1' : '.5';
  }
  function doUnlock(){
    const u = el('username').value.trim();
    const p = el('password').value.trim();
    if(!u){ el('authMsg').textContent='Select a user first.'; return; }
    if(!p){ el('authMsg').textContent='Enter password.'; return; }
    if(p.toLowerCase() === reverse(u).toLowerCase()){
      localStorage.setItem('st_user', u);
      el('authMsg').textContent = 'Unlocked.'; updateAuthUI(true);
    } else { el('authMsg').textContent='Incorrect password for '+u; updateAuthUI(false); }
  }
  el('btnUnlock').addEventListener('click', doUnlock);
  el('password').addEventListener('keydown', e=>{ if(e.key==='Enter') doUnlock(); });
  el('btnLogout').addEventListener('click', ()=>{ updateAuthUI(false); });

  // Restore session
  (function restore(){
    const u=localStorage.getItem('st_user'); if(u){ el('username').value=u; updateAuthUI(true);} 
    const ep=localStorage.getItem('st_endpoint'); el('endpoint').value = ep ? ep : 'https://script.google.com/macros/s/AKfycbzaWlUf2mpylRpOYTOzl2rxOK71oGM6clodLf18iY51Ina52-2YbKcT2b2HKVEnT6MihA/exec';
    const sid=localStorage.getItem('st_sheetId'); if(sid){ el('sheetId').value=sid; }
  })();

  // --- CONNECTION / EXPECTED INVENTORY ---
  async function callEndpoint(params){
    const url = el('endpoint').value.trim();
    if(!url){ throw new Error('Endpoint missing'); }
    try { localStorage.setItem('st_endpoint', url); } catch(e){}
    const q = new URL(url);
    Object.keys(params||{}).forEach(k=> q.searchParams.set(k, params[k]));
    const res = await fetch(q.toString(), { method:'GET', mode:'cors' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }
  el('btnPing').addEventListener('click', async()=>{
    try{
      el('connMsg').textContent = 'Pinging...';
      const r = await callEndpoint({ action:'ping' });
      el('connMsg').textContent = (r && (r.ok||r.status==='ok')) ? ('Ping ok: '+JSON.stringify(r)) : ('Ping response: '+JSON.stringify(r));
    }catch(e){ el('connMsg').textContent = 'Ping failed: '+e.message; }
  });
  el('btnLoadExpected').addEventListener('click', async()=>{
    const sid = el('sheetId').value.trim();
    if(!sid){ el('connMsg').textContent = 'Enter Sheet ID'; return; }
    try{ localStorage.setItem('st_sheetId', sid); }catch(e){}
    try{
      el('connMsg').textContent = 'Loading expected...';
      const r = await callEndpoint({ action:'loadExpected', sheetId: sid });
      const items = r.items || [];
      state.expectedMap = new Map(items.map(x=>[String(x.upc||'').trim(), x]));
      el('progressTotal').textContent = items.length;
      el('progressNow').textContent = 0;
      el('connMsg').textContent = 'Loaded '+items.length+' expected items.';
    }catch(e){ el('connMsg').textContent = 'Load failed: '+e.message; }
  });

  // Auto-ping on load if endpoint present
  try{ if(el('endpoint').value.trim()){ el('connMsg').textContent='Pinging...'; (async()=>{ try{ const r=await callEndpoint({action:'ping'}); el('connMsg').textContent=(r && (r.ok||r.status==='ok'))? ('Ping ok: '+JSON.stringify(r)) : ('Ping response: '+JSON.stringify(r)); }catch(e){ el('connMsg').textContent='Ping failed: '+e.message; } })(); } }catch(e){}

  // --- SCANNING (UPC & Location) with Safe-Close Modal ---
  let scanning = { type:null };
  let quaggaStarted = false;
  let autoCloseTimer = null;

  function showScannerModal(){
    const modal = el('scannerModal');
    modal.classList.add('show');
    const st = el('scanState'); if(st) st.textContent='(initializing‚Ä¶)';
    clearTimeout(autoCloseTimer);
    autoCloseTimer = setTimeout(()=>{ if(!quaggaStarted){ safeCloseScanner('No camera access. Closing.'); } }, 8000);
  }
  function safeCloseScanner(reason){
    try{ Quagga.offDetected(onDetected); Quagga.stop(); }catch(e){}
    quaggaStarted=false;
    el('scannerModal').classList.remove('show');
    if(reason){ const m=el('scanMsg'); if(m) m.textContent=reason; }
  }

  function openScanner(type){ scanning.type=type; showScannerModal(); startQuagga(); }
  function closeScanner(){ safeCloseScanner(); }

  el('btnCloseScanner').addEventListener('click', ()=> safeCloseScanner('Closed by user.'));
  el('scannerBackdrop').addEventListener('click', ()=> safeCloseScanner('Closed (backdrop).'));
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && el('scannerModal').classList.contains('show')) safeCloseScanner('Closed (Esc).'); });

  el('btnScanUPC').addEventListener('click', ()=> openScanner('upc'));
  el('btnScanLoc').addEventListener('click', ()=> openScanner('loc'));

  async function startQuagga(){
    try{
      if(quaggaStarted){ const st=el('scanState'); if(st) st.textContent='(running)'; return; }
      const front = el('useFront').checked; const constraints = { facingMode: front ? 'user' : 'environment' };
      Quagga.init({
        inputStream: { name:'Live', type:'LiveStream', target: el('scannerViewport'), constraints },
        decoder: { readers: ['upc_reader','upc_e_reader','ean_reader','ean_8_reader','code_128_reader'] },
        locate: true,
      }, (err)=>{
        if(err){ el('scanMsg').textContent='Camera error: '+err; return; }
        Quagga.start(); quaggaStarted=true; const st=el('scanState'); if(st) st.textContent='(running)'; el('scanMsg').textContent='';
      });
      Quagga.offDetected(onDetected); Quagga.onDetected(onDetected);
    }catch(e){ el('scanMsg').textContent='Init error: '+e.message; }
  }
  function stopQuagga(){ try{ Quagga.offDetected(onDetected); Quagga.stop(); }catch(e){} quaggaStarted=false; const st=el('scanState'); if(st) st.textContent='(stopped)'; }
  el('btnStartScan').addEventListener('click', startQuagga);
  el('btnStopScan').addEventListener('click', stopQuagga);

  function onDetected(result){
    const code = (result?.codeResult?.code || '').trim();
    if(!code) return; beep(); stopQuagga(); safeCloseScanner('Scanned: '+code);
    if(scanning.type==='upc'){ el('upc').value = code; loadExpectedForUPC(code); }
    else if(scanning.type==='loc') { addLocation(code, 0); }
  }

  // --- UPC generator for testing ---
  el('btnGenUPC').addEventListener('click', ()=>{ const fake = String(Math.floor(Math.random()*1e12)).padStart(12,'0'); el('upc').value = fake; loadExpectedForUPC(fake); });

  function loadExpectedForUPC(u){
    const key = String(u||'').trim();
    const d = state.expectedMap.get(key);
    if(d){
      el('brand').value = d.brand||''; el('gender').value = d.gender||''; el('coo').value = d.coo||''; el('itemDesc').value = d.desc||'';
      el('expectedQty').value = toNumber(d.expectedQty||0);
    }
  }

  // --- BOX BREAKDOWN + WEIGHT ---
  const styles = [1,2,3,4];
  styles.forEach(i=>{ ['boxes','qpb','l','w','h','bw'].forEach(s=> el(`s${i}_${s}`).addEventListener('input', recompute)); });
  function recompute(){
    let subtotal=0, totalCft=0, totalGw=0; const parts=[];
    styles.forEach(i=>{
      const b  = toNumber(el(`s${i}_boxes`).value);
      const q  = toNumber(el(`s${i}_qpb`).value);
      const l  = toNumber(el(`s${i}_l`).value), w = toNumber(el(`s${i}_w`).value), h = toNumber(el(`s${i}_h`).value);
      const bw = toNumber(el(`s${i}_bw`).value);
      if(b>0 && q>0){ const pcs=b*q; subtotal += pcs; parts.push(`${b} x ${q}`); }
      if(b>0 && l&&w&&h){ totalCft += b * cft(l,w,h); }
      if(b>0 && bw>0){ totalGw += b * bw; }
    });
    el('subtotalPieces').textContent = String(subtotal);
    el('totalCft').textContent = totalCft.toFixed(2);
    el('totalGw').textContent = totalGw.toFixed(2);
    el('sum_upc').value = el('upc').value.trim();
    el('sum_qty').value = subtotal;
    el('sum_breakdown').value = parts.join(' + ');
    el('countedTotal').textContent = String(subtotal);
  }

  // Discrepancy check
  el('btnCheckDiscrepancy').addEventListener('click', ()=>{
    const expected = toNumber(el('expectedQty').value);
    const subtotal = toNumber(el('subtotalPieces').textContent);
    if(subtotal === expected){ state.discrepancy=false; el('discMsg').textContent='‚úì Counts match expected.'; el('discMsg').className='ok'; el('discArea').classList.add('hidden'); }
    else { state.discrepancy=true; el('discMsg').textContent=`‚ö†Ô∏è Discrepancy: expected ${expected}, counted ${subtotal}. Select a reason on Page 2.`; el('discMsg').className='bad'; el('discArea').classList.remove('hidden'); }
  });

  // Page navigation
  $$('.tab').forEach(t=> t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    $$('.page').forEach(x=>x.classList.remove('active')); $(t.dataset.target).classList.add('active');
    setPage(t.dataset.target==='#page1'?1:2);
  }));
  el('btnNextToPage2').addEventListener('click', ()=>{ $$('.tab')[1].click(); });
  el('btnBackToPage1').addEventListener('click', ()=>{ $$('.tab')[0].click(); });
  setPage(1);

  // --- PUTAWAY LOCATIONS ---
  function addLocation(code, qty){
    const wrap = document.createElement('div'); wrap.className='location-row';
    const loc = document.createElement('input'); loc.type='text'; loc.value = code||''; loc.placeholder='A 01 01 01';
    const q = document.createElement('input'); q.type='number'; q.min='0'; q.value=qty||0;
    wrap.appendChild(loc); wrap.appendChild(q); el('locations').appendChild(wrap);
  }
  el('btnAddLoc').addEventListener('click', ()=> addLocation('',0));
  el('btnMoveAll').addEventListener('click', ()=>{
    const subtotal = toNumber(el('subtotalPieces').textContent);
    const rows = $$('#locations .location-row'); if(rows.length===0) addLocation('', subtotal);
    else rows[0].querySelector('input[type=number]').value = subtotal;
  });
  el('presetLoc').addEventListener('change', e=>{ if(e.target.value) addLocation(e.target.value,0); e.target.value=''; });

  // --- DAMAGE TOTALS ---
  ['goodQty','damageSellQty','damageDisposeQty'].forEach(id=> el(id).addEventListener('input', ()=>{
    const t = toNumber(el('goodQty').value)+toNumber(el('damageSellQty').value)+toNumber(el('damageDisposeQty').value);
    el('damageTotal').textContent = String(t);
  }));

  // --- DOWNLOAD JSON ---
  el('btnDownloadJson').addEventListener('click', ()=>{
    const payload = buildPayload();
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='stocktaker_v7_payload.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  function buildPayload(){
    const rows = $$('#locations .location-row').map(r=>({ location: r.querySelector('input[type=text]').value.trim(), qty: toNumber(r.querySelector('input[type=number]').value) }));
    return {
      meta: { app:'StockTaker', ver:'7.0.2', timestamp: nowIso(), user: el('username').value.trim(), counter: el('counter').value },
      item: {
        upc: el('upc').value.trim(), brand: el('brand').value.trim(), gender: el('gender').value, coo: el('coo').value, desc: el('itemDesc').value.trim(), edgeNo: el('edgeNo').value.trim(),
        weight: toNumber(el('weight')?.value || 0),
        dim_in: { L: toNumber(el('len')?.value || 0), W: toNumber(el('wid')?.value || 0), H: toNumber(el('hei')?.value || 0) },
        expectedQty: toNumber(el('expectedQty').value), countedQty: toNumber(el('subtotalPieces').textContent), breakdown: el('sum_breakdown').value,
        boxes: [1,2,3,4].map(i=>({
          boxes: toNumber(el(`s${i}_boxes`).value),
          qtyPerBox: toNumber(el(`s${i}_qpb`).value),
          boxDimIn: {L:toNumber(el(`s${i}_l`).value), W:toNumber(el(`s${i}_w`).value), H:toNumber(el(`s${i}_h`).value)},
          boxWeightLb: toNumber(el(`s${i}_bw`).value)
        })),
        totalGrossWeightLb: toNumber(el('totalGw').textContent)
      },
      putaway: { locations: rows },
      damage: { good: toNumber(el('goodQty').value), unboxSell: toNumber(el('damageSellQty').value), dispose: toNumber(el('damageDisposeQty').value) },
      discrepancy: state.discrepancy ? { reason: el('discReason').value||'' } : null,
      okToSubmit: el('okToSubmit').value==='Yes',
      notes: el('notes').value
    };
  }

  // --- SUBMIT TO SHEET ---
  el('btnSubmit').addEventListener('click', async()=>{
    const payload = buildPayload();
    if(!payload.item.upc){ alert('UPC required.'); return; }
    try{
      el('printMsg').textContent='Submitting...';
      const res = await callEndpoint({ action:'submit', sheetId: el('sheetId').value.trim(), data: JSON.stringify(payload) });
      el('printMsg').textContent='Submitted: '+JSON.stringify(res);
      try{
        const cp = await callEndpoint({ action:'canprint', upc: payload.item.upc, status: state.discrepancy? 'PENDING' : 'VERIFIED' });
        if(cp?.allowed === false){ el('printMsg').textContent += ' | ‚ö†Ô∏è Label printing blocked by rule (allowed to override).'; }
      }catch(e){ /* ignore */ }
    }catch(e){ el('printMsg').textContent='Submit failed: '+e.message; }
  });

  // --- LABEL GENERATION & PRINTING (HTML path) ---
  function clearPrint(){ el('printSandbox').innerHTML=''; state.labelsReady=false; el('btnPrintLabels').disabled=true; el('btnSavePDF').disabled=true; }
  function pagesFromCartons(){ return Math.max(1, [1,2,3,4].map(i=>Number(el(`s${i}_boxes`).value||0)).reduce((a,b)=>a+b,0)); }
  function generateLabels(){
    clearPrint();
    const qty = toNumber(el('subtotalPieces').textContent);
    const parts = el('sum_breakdown').value;
    const upc = el('upc').value.trim();
    const desc = el('itemDesc').value.trim();
    const brand = el('brand').value.trim();
    const gender = el('gender').value; const coo = el('coo').value;
    const recheck = !el('discArea').classList.contains('hidden');
    const gw = el('totalGw').textContent;

    const sandbox = el('printSandbox');
    const pages = pagesFromCartons();
    for(let i=1;i<=pages;i++){
      const node = document.createElement('div'); node.className='label' + (recheck? ' recheck':'');
      node.innerHTML = `
        <div class="hdr">INVENTORIED LABEL</div>
        <div class="grid">
          <div>
            <div class="big">${escapeHtml(desc||'‚Äî')}</div>
            <div><b>Item No:</b> ${escapeHtml(el('edgeNo').value||'‚Äî')}</div>
            <div><b>Brand:</b> ${escapeHtml(brand||'‚Äî')} &nbsp; <b>Gender:</b> ${escapeHtml(gender||'‚Äî')} &nbsp; <b>COO:</b> ${escapeHtml(coo||'‚Äî')}</div>
            <div><b>Location:</b> ${(el('locations').querySelector('input[type=text]')?.value||'‚Äî')}</div>
            <div><b>TOTAL QTY:</b> ${qty} &nbsp; <b>Breakdown:</b> ${escapeHtml(parts||'‚Äî')}</div>
            <div><b>GROSS WT:</b> ${escapeHtml(gw)} lb</div>
            <div>Carton: ${i} of ${pages}</div>
          </div>
          <div>
            <div class="codes">
              <svg class="barcode"></svg>
            </div>
            <div class="codes" style="margin-top:6px;">
              <div id="qr_${i}"></div>
            </div>
            <div style="text-align:left; margin-top:4px; font-weight:800;">UPC: ${escapeHtml(upc||'‚Äî')}</div>
          </div>
        </div>
        <div class="footer"><span>${new Date().toLocaleString()}</span><span>STOCKTAKER v7</span></div>`;
      sandbox.appendChild(node);
      const b = node.querySelector('svg.barcode');
      try{ JsBarcode(b, upc || '000000000000', {format:'CODE128', width:2, height:60, displayValue:false, margin:0}); }catch(e){}
      try{ new QRCode(node.querySelector(`#qr_${i}`), { text: upc || '000000000000', width:100, height:100 }); }catch(e){}
    }
    state.labelsReady=true; el('btnPrintLabels').disabled=false; el('btnSavePDF').disabled=false;
    el('printMsg').textContent = `Prepared ${sandbox.children.length} page(s) for printing.`;
  }
  el('btnGenerateLabels').addEventListener('click', generateLabels);
  el('btnPrintLabels').addEventListener('click', ()=>{ if(!state.labelsReady) return; window.print(); });

  // --- SAVE AS PDF ---
  async function saveLabelsAsPDF(){
    if(!state.labelsReady) return;
    const J = window.jspdf; const sandbox = el('printSandbox');
    const upc = (el('upc')?.value || 'NO_UPC').trim() || 'NO_UPC';
    const ts  = new Date().toISOString().replace(/[:.]/g,'-');
    const doc = new J.jsPDF({ orientation:'landscape', unit:'in', format:[6,4] });
    for(let i=0;i<sandbox.children.length;i++){
      const node = sandbox.children[i];
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: '#ffffff', logging: false });
      const img = canvas.toDataURL('image/png');
      if(i>0) doc.addPage([6,4], 'landscape');
      doc.addImage(img, 'PNG', 0, 0, 6, 4);
    }
    doc.save(`INVENTORIED_LABELS_${upc}_${ts}.pdf`);
  }
  el('btnSavePDF').addEventListener('click', saveLabelsAsPDF);

})();
</script>
</body>
</html>