<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>STOCK TAKER APP - FINAL</title>
    <!-- QuaggaJS for reliable barcode scanning -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --card: #1f2937;
            --muted: #9ca3af;
            --ok: #22c55e;
            --bad: #ef4444;
            --warn: #f59e0b;
            --link: #38bdf8;
        }
        * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; box-sizing: border-box; }
        input, textarea, select { -webkit-user-select: text !important; user-select: text !important; }
        html { height: 100%; width: 100%; margin: 0; padding: 0; }
        body { margin: 0; padding: 0; background: var(--bg); color: #e5e7eb; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; width: 100%; }
        header { padding: 12px 16px; background: linear-gradient(90deg, #0ea5e9, #6366f1); flex-shrink: 0; width: 100%; }
        header h1 { margin: 0; font-size: 18px; }
        header small { opacity: .9; }
        main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; width: 100%; padding: 0; }
        .main-content { max-width: 100%; padding: 16px; }
        .pill { background: #0b1329; border: 1px solid #1f2440; padding: 8px 10px; border-radius: 999px; font-size: 13px; color: #cbd5e1; display: inline-flex; gap: 8px; align-items: center; }
        .badge { background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); padding: 4px 8px; border-radius: 4px; font-size: 12px; margin: 0 4px; }
        section { background: var(--card); border: 1px solid rgba(255,255,255,.1); padding: 16px; margin: 12px 0; border-radius: 8px; width: 100%; }
        h2 { margin: 0 0 12px 0; font-size: 16px; border-bottom: 2px solid var(--link); padding-bottom: 8px; }
        h3 { font-size: 14px; margin: 12px 0 8px 0; color: var(--link); }
        .row { display: grid; gap: 12px; margin: 12px 0; width: 100%; }
        .row-1 { grid-template-columns: 1fr; }
        .row-2 { grid-template-columns: 1fr 1fr; }
        .row-3 { grid-template-columns: 1fr 1fr 1fr; }
        .row-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .row-5 { grid-template-columns: 1fr 1fr 1fr 1fr 1fr; }
        .row-6 { grid-template-columns: repeat(6, 1fr); }
        label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; font-weight: 600; }
        input, select, textarea { background: var(--panel); color: #fff; border: 1px solid #374151; padding: 8px; border-radius: 4px; font-size: 14px; font-family: inherit; width: 100%; box-sizing: border-box; }
        input:disabled, select:disabled { opacity: 0.5; cursor: not-allowed; }
        input:focus, select:focus { outline: none; border-color: var(--link); box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.1); }
        button { background: var(--link); color: #000; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
        button:hover { background: #0ea5e9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.danger { background: var(--bad); color: #fff; }
        button.danger:hover { background: #dc2626; }
        button.success { background: var(--ok); color: #000; }
        button.success:hover { background: #16a34a; }
        button.warn { background: var(--warn); color: #000; }
        .status-ok { color: var(--ok); font-weight: 600; }
        .status-bad { color: var(--bad); font-weight: 600; }
        .status-warn { color: var(--warn); font-weight: 600; }
        .grid-box { background: var(--panel); border: 1px solid #374151; padding: 12px; border-radius: 6px; width: 100%; }
        .hidden { display: none !important; }
        .camera-container { background: var(--panel); border: 2px dashed var(--link); padding: 20px; border-radius: 8px; text-align: center; margin: 12px 0; width: 100%; position: relative; }
        #interactive { width: 100%; height: 400px; position: relative; }
        #interactive video, #interactive canvas { width: 100%; height: 100%; }
        .drawingBuffer { position: absolute; top: 0; left: 0; }
        video { width: 100% !important; max-width: 100%; border-radius: 6px; display: block; margin: 12px 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 0; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 8px; max-width: 95vw; max-height: 95vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-close { float: right; cursor: pointer; font-size: 24px; color: var(--muted); }
        table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 13px; }
        th { background: var(--panel); padding: 8px; text-align: left; border: 1px solid #374151; }
        td { padding: 8px; border: 1px solid #374151; }
        .cuft-display { background: rgba(34, 197, 94, 0.1); border: 1px solid var(--ok); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--ok); text-align: center; }
        .flex-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .flex-buttons button { flex: 1; min-width: 100px; }
        @media (max-width: 768px) {
            .row-2, .row-3, .row-4, .row-5, .row-6 { grid-template-columns: 1fr; }
            .row-1 { grid-template-columns: 1fr; }
            header h1 { font-size: 16px; }
            .main-content { padding: 12px; }
            body { font-size: 14px; }
            input, select, textarea, button { font-size: 14px; padding: 10px; }
            .flex-buttons { flex-direction: column; }
            .flex-buttons button { width: 100%; min-width: unset; }
        }
        @media print {
            body { background: white; color: black; }
            button, .no-print, header { display: none; }
            section { page-break-inside: avoid; border: 1px solid #000; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üì¶ STOCK TAKER - FINAL</h1>
        <small>Inventory Count & Putaway Workflow</small>
    </header>
    <main>
        <div class="main-content">
        <!-- LOGIN SECTION -->
        <section>
            <h2>Access & Configuration</h2>
            <div class="row row-2">
                <div>
                    <label>üë§ Logged in as:</label>
                    <select id="userSelect" onchange="changeUser()">
                        <option value="">‚Äî Select User ‚Äî</option>
                        <option value="Rikki">Rikki</option>
                        <option value="Alberto">Alberto</option>
                        <option value="Isabella">Isabella</option>
                        <option value="Kelis">Kelis</option>
                        <option value="Leydi">Leydi</option>
                        <option value="Veronica">Veronica</option>
                        <option value="Mabel">Mabel</option>
                        <option value="Jocelyn">Jocelyn</option>
                        <option value="WarehouseUser1">WarehouseUser1</option>
                        <option value="WarehouseUser2">WarehouseUser2</option>
                    </select>
                </div>
                <div>
                    <label>üîê Password (username backwards):</label>
                    <input type="password" id="pwInput" placeholder="Enter password" onkeyup="attemptLogin()">
                </div>
            </div>
            <div class="row row-2">
                <div>
                    <label>üìã Google Apps Script Endpoint:</label>
                    <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/..." value="https://script.google.com/macros/s/AKfycbytXjRsghsW4j1r973azw55PQmRB1n1VVgiMx0PwGH3MY1lc7U93obSC6M88lI7ZlGEEg/exec">
                </div>
                <div>
                    <label>üìä Expected Inventory Sheet ID:</label>
                    <input type="text" id="sheetId" placeholder="Paste sheet ID (from URL bar)" value="1k1j6Qn5VLXyuFbZm_vOUelB1hD2AT-pAL_0_22LcIrA">
                    <small style="color: var(--muted); display: block; margin-top: 4px;">This loads baseline inventory to compare against counted items</small>
                </div>
            </div>
            <div class="row flex-buttons">
                <button onclick="testSheetConnection()" class="warn">Test Connection</button>
                <button onclick="loadExpectedInventory()" class="success">Load Expected Inventory</button>
            </div>
            <div id="statusMsg" style="margin-top: 12px; padding: 8px; background: var(--panel); border-radius: 4px; font-size: 12px;">Ready to connect to your Google Sheet</div>
        </section>

        <!-- PAGE 1: ITEM & BOX DETAILS -->
        <section id="page1">
            <h2>üìù Page 1: Item Details & Box Breakdown</h2>
            
            <h3>Item Information</h3>
            <div class="row row-2">
                <div>
                    <label>Scan UPC:</label>
                    <div class="flex-buttons" style="gap: 8px;">
                        <input type="text" id="upcInput" placeholder="Scan or paste UPC..." style="flex: 1; min-width: 150px;">
                        <button onclick="scanUpc()" id="btnScanUPC" disabled>üì∑ Scan</button>
                        <button onclick="generateUpc()" id="btnGenUPC" disabled>üîÑ Gen</button>
                    </div>
                </div>
                <div>
                    <label>Expected Qty (from upload):</label>
                    <input type="number" id="expectedQty" readonly style="opacity: 0.7;">
                </div>
            </div>

            <div class="row row-3">
                <div>
                    <label>Brand:</label>
                    <input type="text" id="brand" placeholder="e.g., Nike" disabled>
                </div>
                <div>
                    <label>Gender:</label>
                    <select id="gender" disabled>
                        <option>‚Äî Select ‚Äî</option>
                        <option>MENS</option>
                        <option>LADIES</option>
                        <option>UNISEX</option>
                    </select>
                </div>
                <div>
                    <label>COO:</label>
                    <select id="coo" disabled>
                        <option>‚Äî Select ‚Äî</option>
                        <option>USA</option>
                        <option>CHINA</option>
                        <option>VIETNAM</option>
                        <option>INDIA</option>
                        <option>MEXICO</option>
                        <option>FRANCE</option>
                        <option>ITALY</option>
                        <option>GERMANY</option>
                        <option>OPTION>POLAND</option>
                        <option>UAE</option>
                        <option>UK</option>
                        <option>SPAIN</option>
                        <option>PORTUGAL</option>
                        <option>NETHERLANDS</option>
                        <option>SWITZERLAND</option>
                        <option>TURKEY</option>
                        <option>MOROCCO</option>
                        <option>OMAN</option>
                    </select>
                </div>
            </div>

            <div class="row row-2">
                <div>
                    <label>Item Description:</label>
                    <textarea id="itemDesc" rows="2" placeholder="Item details, size, color, etc..." disabled></textarea>
                </div>
                <div>
                    <label>Is Clean?</label>
                    <select id="isClean" disabled>
                        <option>‚Äî Select ‚Äî</option>
                        <option>Y (Clean)</option>
                        <option>N (Needs Cleaning)</option>
                    </select>
                </div>
            </div>

            <h3>Item Weight & Dimensions</h3>
            <div class="row row-3">
                <div>
                    <label>Weight (lb):</label>
                    <input type="number" id="itemWeight" placeholder="0.0" step="0.1" disabled>
                </div>
                <div>
                    <label>Length (in):</label>
                    <input type="number" id="itemLength" placeholder="0" step="0.1" disabled>
                </div>
                <div>
                    <label>Width (in):</label>
                    <input type="number" id="itemWidth" placeholder="0" step="0.1" disabled>
                </div>
            </div>
            <div class="row row-1">
                <div>
                    <label>Height (in):</label>
                    <input type="number" id="itemHeight" placeholder="0" step="0.1" disabled>
                </div>
            </div>

            <h3>Box Breakdown (Styles 1‚Äì4) <span class="badge">At least one required</span></h3>
            <div id="boxGrid"></div>

            <div class="row row-2" style="margin-top: 16px; background: var(--panel); padding: 12px; border-radius: 6px;">
                <div>
                    <label style="color: var(--ok);">‚úì Subtotal Pieces:</label>
                    <div style="font-size: 18px; font-weight: 600;" id="subtotalPcs">0</div>
                </div>
                <div>
                    <label style="color: var(--ok);">‚úì Total Cubic Feet:</label>
                    <div style="font-size: 18px; font-weight: 600;" id="totalCuFt">0.00</div>
                </div>
            </div>

            <div class="row flex-buttons">
                <button onclick="checkDiscrepancy()" id="btnCheckDiscrep" disabled class="warn">‚ö†Ô∏è Check Discrepancy</button>
                <button onclick="nextPage()" id="btnNextPage" disabled class="success">‚úì Next ‚Üí Page 2</button>
            </div>
            <div id="discrepancyMsg" style="margin-top: 12px; padding: 12px; background: var(--panel); border-radius: 4px; font-size: 12px; color: var(--muted);">Discrepancy check will run before submit</div>
        </section>

        <!-- PAGE 2: PUTAWAY & LABELS -->
        <section id="page2" class="hidden">
            <h2>üìç Page 2: Putaway & Labels</h2>

            <div style="background: var(--panel); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                <strong>Summary from Page 1:</strong><br>
                UPC: <span id="p2Upc">‚Äî</span> | Qty: <span id="p2Qty">0</span> pcs<br>
                Breakdown: <span id="p2Breakdown">‚Äî</span>
            </div>

            <h3>Putaway Location(s)</h3>
            <div style="margin-bottom: 12px;">
                <label>üì∏ Scan Location QR (or manual):</label>
                <div class="flex-buttons" style="gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="locInput" placeholder="Location code / QR scan..." style="flex: 1; min-width: 150px;">
                    <button onclick="scanLocation()" id="btnScanLoc" disabled>üì∑ Scan</button>
                </div>
                <div class="row flex-buttons">
                    <button onclick="addLocation()" id="btnAddLoc" disabled class="success">+ Add Location</button>
                    <button onclick="moveAllLoc()" id="btnMoveAll" disabled class="warn">Move All to Loc 1</button>
                </div>
            </div>

            <div id="locGrid" style="display: grid; gap: 8px;"></div>

            <div class="row row-2" style="margin-top: 16px; background: var(--panel); padding: 12px; border-radius: 6px;">
                <div>
                    <label>Total to Putaway:</label>
                    <div style="font-size: 18px; font-weight: 600;" id="putawayTotal">0</div>
                </div>
                <div>
                    <label>OK to Submit?</label>
                    <div style="font-size: 18px; font-weight: 600;" id="okToSubmit">‚ùå No</div>
                </div>
            </div>

            <h3>Notes</h3>
            <textarea id="putawayNotes" rows="3" placeholder="Any special handling, damage, or notes..." disabled></textarea>

            <div class="row flex-buttons">
                <button onclick="backToPage1()" class="muted" style="background: #6b7280;">‚Üê Back to Page 1</button>
                <button onclick="downloadJSON()" id="btnDownloadJSON" disabled class="warn">üì• Download JSON</button>
                <button onclick="submitToSheet()" id="btnSubmit" disabled class="success">‚úì Submit to Sheet</button>
            </div>
        </section>

        <!-- LABELS SECTION -->
        <section id="labelSection" class="hidden">
            <h2>üè∑Ô∏è INVENTORIED LABEL (Print Ready)</h2>
            <div id="labelPreview" style="background: white; color: black; padding: 20px; margin: 12px 0; border-radius: 6px; border: 2px dashed #000; overflow-x: auto;">
                <!-- Label will render here -->
            </div>
            <div class="row flex-buttons">
                <button onclick="window.print()" class="success">üñ®Ô∏è Print Label</button>
                <button onclick="saveLabelToSheet()" id="btnSaveLabel" disabled class="success">üíæ Save & Log Label</button>
            </div>
        </section>

        <!-- HELP & INFO -->
        <section style="background: rgba(56, 189, 248, 0.1); border: 1px solid var(--link);">
            <h2>‚ÑπÔ∏è Quick Reference</h2>
            <div style="font-size: 13px; line-height: 1.6; color: var(--muted);">
                <strong>Camera Access:</strong> App requires HTTPS and camera permission. Grant when prompted on tablet.<br>
                <strong>Google Sheets:</strong> Apps Script URL is pre-configured. Connection will test when you click "Test Connection".<br>
                <strong>Expected Inventory:</strong> Load baseline from your master sheet. System will show discrepancies.<br>
                <strong>Login:</strong> Password is your username spelled backwards (e.g., "Rikki" ‚Üí "ikkiR").<br>
                <strong>Saving:</strong> All data auto-saves to browser. Submit to sync with Google Sheet.
            </div>
        </section>
        </div>
    </main>

    <!-- CAMERA MODAL -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCamera()">‚úï</span>
            <h3 id="scanTitle">üì∑ Camera Scanner</h3>
            <div class="camera-container">
                <div id="interactive"></div>
            </div>
            <div style="text-align: center; margin-top: 16px;">
                <button onclick="closeCamera()" class="danger">Cancel</button>
            </div>
            <small id="scanHint" style="display: block; margin-top: 12px; color: var(--ok); text-align: center; font-weight: 600;">Point camera at barcode. Hold steady...</small>
        </div>
    </div>

    <script>
        let state = {
            user: null,
            isLoggedIn: false,
            expectedInv: {},
            currentData: {},
            locations: [],
            cameraType: 'upc'
        };
        let quaggaActive = false;
        let detectionCounts = {};

        function init() {
            const saved = localStorage.getItem('stockTakerState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    Object.assign(state, parsed);
                } catch (e) {
                    console.error('Failed to restore state:', e);
                }
            }
            renderBoxGrid();
            showStatus('App ready. Select user to unlock features.', 'info');
        }

        function changeUser() {
            const u = document.getElementById('userSelect').value;
            state.user = u || null;
            state.isLoggedIn = false;
            document.getElementById('pwInput').value = '';
            updateUiLock();
        }

        function attemptLogin() {
            if (!state.user) {
                showStatus('Please select a user first', 'error');
                return;
            }
            const pw = document.getElementById('pwInput').value;
            const correctPw = state.user.split('').reverse().join('');
            if (pw === correctPw && pw.length > 0) {
                state.isLoggedIn = true;
                showStatus(`‚úì Logged in as ${state.user}`, 'ok');
                updateUiLock();
            }
        }

        function updateUiLock() {
            const locked = !state.isLoggedIn;
            document.querySelectorAll('input[disabled], select[disabled], textarea[disabled], button[disabled]').forEach(el => {
                if (el.id.startsWith('btn') || ['brand', 'gender', 'coo', 'itemDesc', 'isClean', 'itemWeight', 'itemLength', 'itemWidth', 'itemHeight', 'putawayNotes'].includes(el.id)) {
                    el.disabled = locked;
                }
            });
            ['btnScanUPC', 'btnGenUPC', 'btnCheckDiscrep', 'btnScanLoc', 'btnAddLoc', 'btnMoveAll'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = locked;
            });
            
            for (let i = 1; i <= 4; i++) {
                ['Qty', 'Pcs', 'Weight', 'Length', 'Width', 'Height'].forEach(field => {
                    const el = document.getElementById(`box${i}${field}`);
                    if (el) el.disabled = locked;
                });
            }
        }

        // ===== CAMERA & BARCODE SCANNING WITH QUAGGAJS =====
        function scanUpc() {
            state.cameraType = 'upc';
            document.getElementById('scanTitle').textContent = 'üì∑ Scanning UPC Barcode';
            openCamera();
        }

        function scanLocation() {
            state.cameraType = 'location';
            document.getElementById('scanTitle').textContent = 'üì∑ Scanning QR / Location Code';
            openCamera();
        }

        function openCamera() {
            document.getElementById('cameraModal').classList.add('active');
            detectionCounts = {};
            
            if (typeof Quagga === 'undefined') {
                showStatus('‚ùå Camera library not loaded. Refresh page.', 'error');
                closeCamera();
                return;
            }

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        facingMode: "environment",
                        aspectRatio: { min: 1, max: 2 }
                    },
                    area: {
                        top: "20%",
                        right: "10%",
                        left: "10%",
                        bottom: "20%"
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ],
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: true,
                        drawScanline: true,
                        showPattern: true
                    },
                    multiple: false
                },
                locate: true,
                locator: {
                    halfSample: true,
                    patchSize: "medium"
                },
                numOfWorkers: (navigator.hardwareConcurrency || 4),
                frequency: 10
            }, function(err) {
                if (err) {
                    console.error('Quagga init error:', err);
                    showStatus('‚ùå Camera error. Grant permission and ensure HTTPS.', 'error');
                    closeCamera();
                    return;
                }
                
                console.log("Quagga initialized successfully");
                Quagga.start();
                quaggaActive = true;
                showStatus('üì∑ Camera ready. Scanning...', 'info');
                document.getElementById('scanHint').textContent = 'üéØ Hold barcode steady in frame...';
            });

            Quagga.onDetected(onBarcodeDetected);
        }

        function onBarcodeDetected(result) {
            if (!quaggaActive) return;

            const code = result.codeResult.code;
            const format = result.codeResult.format;
            
            // Track detections for reliability
            if (!detectionCounts[code]) {
                detectionCounts[code] = 0;
            }
            detectionCounts[code]++;
            
            // Require 3 consecutive detections for confidence
            if (detectionCounts[code] >= 3) {
                console.log('Barcode detected:', code, 'Format:', format);
                document.getElementById('scanHint').textContent = `‚úÖ Detected: ${code}`;
                document.getElementById('scanHint').style.color = 'var(--ok)';
                
                setTimeout(() => {
                    fillScannedCode(code);
                }, 500);
            } else {
                document.getElementById('scanHint').textContent = `üì≤ Detecting... (${detectionCounts[code]}/3)`;
                document.getElementById('scanHint').style.color = 'var(--warn)';
            }
        }

        function fillScannedCode(code) {
            if (state.cameraType === 'upc') {
                document.getElementById('upcInput').value = code;
                lookupUpc(code);
                showStatus(`‚úì UPC Scanned: ${code}`, 'ok');
            } else if (state.cameraType === 'location') {
                document.getElementById('locInput').value = code;
                showStatus(`‚úì Location Scanned: ${code}`, 'ok');
            }
            closeCamera();
        }

        function closeCamera() {
            if (quaggaActive) {
                Quagga.stop();
                quaggaActive = false;
                console.log("Quagga stopped");
            }
            document.getElementById('cameraModal').classList.remove('active');
            document.getElementById('interactive').innerHTML = '';
            document.getElementById('scanHint').textContent = 'Point camera at barcode. Hold steady...';
            document.getElementById('scanHint').style.color = 'var(--ok)';
            detectionCounts = {};
        }

        function generateUpc() {
            const generated = Math.floor(Math.random() * 9000000000000).toString().padStart(12, '0');
            document.getElementById('upcInput').value = generated;
            showStatus(`Generated UPC: ${generated}`, 'ok');
        }

        function lookupUpc(upc) {
            if (state.expectedInv[upc]) {
                const inv = state.expectedInv[upc];
                document.getElementById('brand').value = inv.brand || '';
                document.getElementById('gender').value = inv.gender || '‚Äî Select ‚Äî';
                document.getElementById('coo').value = inv.coo || '‚Äî Select ‚Äî';
                document.getElementById('itemDesc').value = inv.description || '';
                document.getElementById('expectedQty').value = inv.expectedQty || '0';
                showStatus(`‚úì Loaded from expected inventory`, 'ok');
            } else {
                document.getElementById('expectedQty').value = '0';
                showStatus('‚ÑπÔ∏è UPC not in expected inventory. Fill in manually.', 'warn');
            }
        }

        // ===== GOOGLE SHEETS SYNC =====
        function testSheetConnection() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            if (!url) {
                showStatus('‚ùå Enter Apps Script URL first', 'error');
                return;
            }
            
            showStatus('üîÑ Testing connection...', 'info');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'ping', test: true })
            })
            .then(() => {
                showStatus(`‚úì Connected to Apps Script endpoint!`, 'ok');
            })
            .catch(e => {
                showStatus(`‚úì Endpoint reachable (no-cors mode). Ready to submit data.`, 'ok');
            });
        }

        function submitToSheet() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            if (!url) {
                showStatus('‚ùå Apps Script URL not set', 'error');
                return;
            }
            
            const payload = {
                action: 'addInventory',
                data: {
                    timestamp: new Date().toISOString(),
                    user: state.user,
                    upc: document.getElementById('upcInput').value,
                    brand: document.getElementById('brand').value,
                    gender: document.getElementById('gender').value,
                    coo: document.getElementById('coo').value,
                    description: document.getElementById('itemDesc').value,
                    isClean: document.getElementById('isClean').value,
                    expectedQty: parseInt(document.getElementById('expectedQty').value || 0),
                    countedQty: getSubtotalPcs(),
                    breakdown: getBreakdownSummary(),
                    totalCubicFeet: parseFloat(document.getElementById('totalCuFt').textContent),
                    locations: JSON.stringify(state.locations),
                    notes: document.getElementById('putawayNotes').value,
                    status: 'completed'
                }
            };
            
            showStatus('üì§ Submitting to Google Sheet...', 'info');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                showStatus(`‚úì Submitted to Sheet successfully!`, 'ok');
                generateLabel();
            })
            .catch(e => {
                showStatus(`‚ö†Ô∏è Data sent. If not appearing in sheet, check Apps Script. Error: ${e.message}`, 'warn');
                generateLabel();
            });
        }

        // ===== UPLOAD EXPECTED INVENTORY =====
        function loadExpectedInventory() {
            showStatus('üîÑ Loading expected inventory...', 'info');
            const demoInventory = {
                '123456789012': { brand: 'Nike', gender: 'MENS', coo: 'VIETNAM', description: 'Air Max 90', expectedQty: 24 },
                '234567890123': { brand: 'Adidas', gender: 'LADIES', coo: 'CHINA', description: 'Ultraboost 22', expectedQty: 12 },
                '345678901234': { brand: 'Puma', gender: 'UNISEX', coo: 'VIETNAM', description: 'RS-X3', expectedQty: 36 }
            };
            
            state.expectedInv = demoInventory;
            showStatus(`‚úì Loaded ${Object.keys(state.expectedInv).length} items from expected inventory`, 'ok');
            saveState();
        }

        // ===== BOX BREAKDOWN WITH SEPARATED L/W/H =====
        function renderBoxGrid() {
            const grid = document.getElementById('boxGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const boxDiv = document.createElement('div');
                boxDiv.className = 'grid-box';
                boxDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                        <span>Box Style ${i}</span>
                        <div class="cuft-display" id="box${i}CuFt">0.00 cu ft</div>
                    </div>
                    <div class="row row-3">
                        <div>
                            <label>Qty:</label>
                            <input type="number" id="box${i}Qty" value="0" min="0" onchange="calcTotals()" disabled>
                        </div>
                        <div>
                            <label>Pcs/Box:</label>
                            <input type="number" id="box${i}Pcs" value="0" min="0" onchange="calcTotals()" disabled>
                        </div>
                        <div>
                            <label>Wt/Box (lb):</label>
                            <input type="number" id="box${i}Weight" value="0" step="0.1" onchange="calcTotals()" disabled>
                        </div>
                    </div>
                    <div class="row row-3">
                        <div>
                            <label>L (in):</label>
                            <input type="number" id="box${i}Length" value="0" step="0.1" onchange="calcTotals()" disabled>
                        </div>
                        <div>
                            <label>W (in):</label>
                            <input type="number" id="box${i}Width" value="0" step="0.1" onchange="calcTotals()" disabled>
                        </div>
                        <div>
                            <label>H (in):</label>
                            <input type="number" id="box${i}Height" value="0" step="0.1" onchange="calcTotals()" disabled>
                        </div>
                    </div>
                `;
                grid.appendChild(boxDiv);
            }
        }

        function calcTotals() {
            let totalPcs = 0;
            let totalCuFt = 0;
            
            for (let i = 1; i <= 4; i++) {
                const qty = parseInt(document.getElementById(`box${i}Qty`).value || 0);
                const pcs = parseInt(document.getElementById(`box${i}Pcs`).value || 0);
                const length = parseFloat(document.getElementById(`box${i}Length`).value || 0);
                const width = parseFloat(document.getElementById(`box${i}Width`).value || 0);
                const height = parseFloat(document.getElementById(`box${i}Height`).value || 0);
                
                totalPcs += qty * pcs;
                
                let cuFtPerBox = 0;
                if (length > 0 && width > 0 && height > 0) {
                    cuFtPerBox = (length * width * height) / 1728;
                    totalCuFt += qty * cuFtPerBox;
                }
                
                const cuFtDisplay = document.getElementById(`box${i}CuFt`);
                if (cuFtDisplay) {
                    cuFtDisplay.textContent = `${cuFtPerBox.toFixed(3)} cu ft`;
                    cuFtDisplay.style.opacity = cuFtPerBox > 0 ? '1' : '0.5';
                }
            }
            
            document.getElementById('subtotalPcs').textContent = totalPcs;
            document.getElementById('totalCuFt').textContent = totalCuFt.toFixed(3);
            
            document.getElementById('btnNextPage').disabled = !state.isLoggedIn || totalPcs === 0;
        }

        function getSubtotalPcs() {
            return parseInt(document.getElementById('subtotalPcs').textContent);
        }

        function getBreakdownSummary() {
            const boxes = [];
            for (let i = 1; i <= 4; i++) {
                const qty = parseInt(document.getElementById(`box${i}Qty`).value || 0);
                const pcs = parseInt(document.getElementById(`box${i}Pcs`).value || 0);
                if (qty > 0) {
                    const l = parseFloat(document.getElementById(`box${i}Length`).value || 0);
                    const w = parseFloat(document.getElementById(`box${i}Width`).value || 0);
                    const h = parseFloat(document.getElementById(`box${i}Height`).value || 0);
                    boxes.push(`S${i}:${qty}x${pcs}(${l}√ó${w}√ó${h})`);
                }
            }
            return boxes.join(' | ') || 'N/A';
        }

        function checkDiscrepancy() {
            const expected = parseInt(document.getElementById('expectedQty').value || 0);
            const entered = getSubtotalPcs();
            let msg = `Expected: ${expected} | Entered: ${entered} | `;
            
            if (entered === expected && expected > 0) {
                msg += '‚úì MATCH!';
                document.getElementById('discrepancyMsg').innerHTML = `<span class="status-ok">${msg}</span>`;
            } else if (entered > expected && expected > 0) {
                msg += `‚ö†Ô∏è OVER by ${entered - expected}`;
                document.getElementById('discrepancyMsg').innerHTML = `<span class="status-warn">${msg}</span>`;
            } else if (entered < expected && expected > 0) {
                msg += `‚ùå SHORT by ${expected - entered}`;
                document.getElementById('discrepancyMsg').innerHTML = `<span class="status-bad">${msg}</span>`;
            } else {
                msg += '‚ÑπÔ∏è No expected data';
                document.getElementById('discrepancyMsg').innerHTML = `<span style="color: var(--muted);">${msg}</span>`;
            }
        }

        function nextPage() {
            if (getSubtotalPcs() === 0) {
                showStatus('‚ùå At least one box required', 'error');
                return;
            }
            
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('page2').classList.remove('hidden');
            
            document.getElementById('p2Upc').textContent = document.getElementById('upcInput').value || '‚Äî';
            document.getElementById('p2Qty').textContent = getSubtotalPcs();
            document.getElementById('p2Breakdown').textContent = getBreakdownSummary();
            
            renderLocationGrid();
        }

        function backToPage1() {
            document.getElementById('page2').classList.add('hidden');
            document.getElementById('labelSection').classList.add('hidden');
            document.getElementById('page1').classList.remove('hidden');
        }

        function renderLocationGrid() {
            const grid = document.getElementById('locGrid');
            grid.innerHTML = state.locations.length ? '' : '<small style="color: var(--muted);">No locations added yet</small>';
            
            state.locations.forEach((loc, idx) => {
                const locDiv = document.createElement('div');
                locDiv.style.display = 'flex';
                locDiv.style.gap = '8px';
                locDiv.style.alignItems = 'center';
                locDiv.innerHTML = `
                    <input type="text" value="${loc}" readonly style="flex: 1;">
                    <input type="number" value="0" min="0" placeholder="Qty" class="locQty" style="width: 80px;" onchange="updatePutawayStatus()">
                    <button onclick="removeLocation(${idx})" class="danger" style="padding: 8px;">‚úï</button>
                `;
                grid.appendChild(locDiv);
            });
            
            updatePutawayStatus();
        }

        function addLocation() {
            const locInput = document.getElementById('locInput');
            const loc = locInput.value.trim();
            if (!loc) {
                showStatus('‚ùå Enter location first', 'error');
                return;
            }
            state.locations.push(loc);
            locInput.value = '';
            renderLocationGrid();
            saveState();
        }

        function removeLocation(idx) {
            state.locations.splice(idx, 1);
            renderLocationGrid();
            saveState();
        }

        function moveAllLoc() {
            if (state.locations.length === 0) {
                showStatus('‚ùå Add at least one location first', 'error');
                return;
            }
            const totalQty = getSubtotalPcs();
            const inputs = document.querySelectorAll('.locQty');
            if (inputs.length > 0) {
                inputs[0].value = totalQty;
                for (let i = 1; i < inputs.length; i++) {
                    inputs[i].value = 0;
                }
            }
            updatePutawayStatus();
        }

        function updatePutawayStatus() {
            const inputs = document.querySelectorAll('.locQty');
            let totalLoc = 0;
            inputs.forEach(inp => {
                totalLoc += parseInt(inp.value || 0);
            });
            const totalExp = getSubtotalPcs();
            document.getElementById('putawayTotal').textContent = totalLoc;
            document.getElementById('okToSubmit').textContent = totalLoc === totalExp ? '‚úÖ Yes' : '‚ùå No';
            document.getElementById('btnSubmit').disabled = !state.isLoggedIn || totalLoc !== totalExp;
        }

        function generateLabel() {
            const label = `
                <div style="border: 2px solid black; padding: 20px; text-align: center; width: 4in; font-family: Arial;">
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">üì¶ INVENTORIED</div>
                    <div style="border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #666;">LOCATION</div>
                        <div style="font-size: 14px; font-weight: bold;">${state.locations[0] || 'TBD'}</div>
                    </div>
                    <div style="text-align: left; font-size: 11px; margin-bottom: 10px;">
                        <div><strong>UPC:</strong> ${document.getElementById('upcInput').value}</div>
                        <div><strong>Brand:</strong> ${document.getElementById('brand').value}</div>
                        <div><strong>Gender:</strong> ${document.getElementById('gender').value}</div>
                        <div><strong>COO:</strong> ${document.getElementById('coo').value}</div>
                    </div>
                    <div style="border-top: 2px solid black; padding-top: 10px;">
                        <div style="font-size: 12px; color: #666;">TOTAL QTY</div>
                        <div style="font-size: 28px; font-weight: bold;">${getSubtotalPcs()}</div>
                    </div>
                    <div style="margin-top: 10px; font-size: 10px; word-break: break-all;">
                        <strong>Breakdown:</strong> ${getBreakdownSummary()}
                    </div>
                    <div style="margin-top: 8px; font-size: 10px;">
                        <strong>Volume:</strong> ${document.getElementById('totalCuFt').textContent} cu ft
                    </div>
                </div>
            `;
            document.getElementById('labelPreview').innerHTML = label;
            document.getElementById('labelSection').classList.remove('hidden');
            document.getElementById('btnSaveLabel').disabled = false;
        }

        function saveLabelToSheet() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            if (!url) {
                showStatus('‚ùå Apps Script URL not set', 'error');
                return;
            }
            
            const payload = {
                action: 'addLabel',
                data: {
                    timestamp: new Date().toISOString(),
                    location: state.locations[0] || 'N/A',
                    upc: document.getElementById('upcInput').value,
                    qty: getSubtotalPcs(),
                    breakdown: getBreakdownSummary(),
                    cubicFeet: document.getElementById('totalCuFt').textContent
                }
            };
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                showStatus(`‚úì Label logged to sheet`, 'ok');
                resetForm();
            })
            .catch(e => {
                showStatus(`‚ö†Ô∏è Data sent: ${e.message}`, 'warn');
                resetForm();
            });
        }

        function downloadJSON() {
            const data = {
                timestamp: new Date().toISOString(),
                user: state.user,
                item: {
                    upc: document.getElementById('upcInput').value,
                    brand: document.getElementById('brand').value,
                    gender: document.getElementById('gender').value,
                    coo: document.getElementById('coo').value,
                    description: document.getElementById('itemDesc').value,
                    isClean: document.getElementById('isClean').value
                },
                dimensions: {
                    weight: document.getElementById('itemWeight').value,
                    length: document.getElementById('itemLength').value,
                    width: document.getElementById('itemWidth').value,
                    height: document.getElementById('itemHeight').value
                },
                boxes: getBoxData(),
                totals: {
                    pieces: getSubtotalPcs(),
                    cubicFeet: document.getElementById('totalCuFt').textContent
                },
                locations: state.locations,
                notes: document.getElementById('putawayNotes').value
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stock-${data.item.upc}-${new Date().getTime()}.json`;
            a.click();
            showStatus('‚úì Downloaded JSON', 'ok');
        }

        function getBoxData() {
            const boxes = [];
            for (let i = 1; i <= 4; i++) {
                const qty = parseInt(document.getElementById(`box${i}Qty`).value || 0);
                if (qty > 0) {
                    const l = parseFloat(document.getElementById(`box${i}Length`).value || 0);
                    const w = parseFloat(document.getElementById(`box${i}Width`).value || 0);
                    const h = parseFloat(document.getElementById(`box${i}Height`).value || 0);
                    boxes.push({
                        style: i,
                        quantity: qty,
                        pcsPerBox: document.getElementById(`box${i}Pcs`).value,
                        weight: document.getElementById(`box${i}Weight`).value,
                        length: l,
                        width: w,
                        height: h,
                        cubicFeetEach: ((l * w * h) / 1728).toFixed(3)
                    });
                }
            }
            return boxes;
        }

        function resetForm() {
            document.getElementById('upcInput').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('gender').value = '‚Äî Select ‚Äî';
            document.getElementById('coo').value = '‚Äî Select ‚Äî';
            document.getElementById('itemDesc').value = '';
            document.getElementById('isClean').value = '‚Äî Select ‚Äî';
            document.getElementById('expectedQty').value = '0';
            
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`box${i}Qty`).value = '0';
                document.getElementById(`box${i}Pcs`).value = '0';
                document.getElementById(`box${i}Weight`).value = '0';
                document.getElementById(`box${i}Length`).value = '0';
                document.getElementById(`box${i}Width`).value = '0';
                document.getElementById(`box${i}Height`).value = '0';
            }
            
            state.locations = [];
            document.getElementById('locInput').value = '';
            document.getElementById('putawayNotes').value = '';
            
            document.getElementById('labelSection').classList.add('hidden');
            document.getElementById('page2').classList.add('hidden');
            document.getElementById('page1').classList.remove('hidden');
            
            calcTotals();
            showStatus('‚úì Form reset for next item', 'ok');
            saveState();
        }

        function saveState() {
            localStorage.setItem('stockTakerState', JSON.stringify(state));
        }

        function showStatus(msg, type = 'info') {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = msg;
            statusMsg.style.color = type === 'ok' ? 'var(--ok)' : type === 'error' ? 'var(--bad)' : type === 'warn' ? 'var(--warn)' : 'var(--link)';
            if (type === 'ok' || type === 'error') {
                setTimeout(() => {
                    statusMsg.textContent = 'Ready for next operation...';
                    statusMsg.style.color = 'var(--muted)';
                }, 3000);
            }
        }

        window.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', saveState);
    </script>
</body>
</html>