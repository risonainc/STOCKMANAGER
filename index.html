<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StockTaker v7.0.2 ‚Äî FULL (Sheets‚ÄëWired, Box Dims + Gross Wt + Scanner)</title>
  <style>
    :root{ --ink:#000; --bg:#fff; --border:#000; --line:2px; --w6:6in; --h4:4in; --w4:4in; --h6:6in; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    h1,h2,h3{margin:.5rem 0;font-weight:900;text-transform:uppercase}
    .app{max-width:1180px;margin:0 auto;padding:20px 16px 84px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;border-bottom:var(--line) solid var(--border);padding-bottom:10px;margin-bottom:18px}
    header .meta{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    label{font-weight:800;display:block;margin-bottom:6px}
    input,select,button,textarea{border:var(--line) solid var(--border);padding:10px;border-radius:6px;background:#fff;color:#000}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{border:var(--line) solid var(--border);padding:16px;border-radius:10px}
    .card h3{display:flex;justify-content:space-between;align-items:center;border-bottom:var(--line) solid var(--border);padding-bottom:8px;margin-bottom:12px}
    .span-2{grid-column:span 2}.span-3{grid-column:span 3}.span-4{grid-column:span 4}.span-5{grid-column:span 5}.span-6{grid-column:span 6}.span-12{grid-column:span 12}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{font-weight:900;text-transform:uppercase;letter-spacing:.04em;cursor:pointer}
    .btn.primary{background:#000;color:#fff}
    .btn.print{border-style:double}
    .screen{display:none}.screen.active{display:block}
    .status{font-size:.9rem;font-weight:800}
    .muted{opacity:.8}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{border:2px solid #000;border-radius:999px;padding:4px 10px;display:inline-flex;gap:8px;align-items:center}
    #labelPreview{margin-top:18px;display:flex;gap:18px;flex-wrap:wrap}
    .label{position:relative;background:#fff;color:#000;border:3px solid #000;border-radius:12px;padding:14px;overflow:hidden}
    .label .hdr{font-weight:900;border-bottom:3px solid #000;padding-bottom:6px;margin-bottom:8px;text-align:center}
    .grid{display:grid;gap:8px}
    .barcode{display:flex;justify-content:center;align-items:center}
    .qr{position:absolute;right:10px;top:10px}
    .carton{width:var(--w6);height:var(--h4)}.inventoried{width:var(--w4);height:var(--h6)}.pallet{width:var(--w6);height:var(--h4)}
    @media print{header,.noprint,.modal{display:none !important}#labelPreview{gap:0}.label{page-break-inside:avoid;margin:0;border:3px solid #000}}
    @page{margin:.25in}
    .progress{display:flex;gap:8px;align-items:center}
    .bar{height:10px;background:#fff;border:2px solid #000;border-radius:8px;overflow:hidden;width:220px}
    .bar>span{display:block;height:100%;background:#000;width:0%}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal.active{display:flex}
    .modal .box{background:#fff;color:#000;border:3px solid #000;border-radius:10px;padding:12px;max-width:720px;width:95%}
    #scanner{width:100%;height:320px;background:#000}
  </style>
</head>
<body>
  <div class="app">
    <header class="noprint">
      <h1>StockTaker <span class="mono">v7.0.2</span> ‚Äî FULL</h1>
      <div class="meta">
        <div>
          <label>User</label>
          <select id="user"><option></option><option>Rikki</option><option>Alberto</option><option>Isabella</option><option>Kelis</option><option>Leydi</option><option>Veronica</option><option>Mabel</option><option>Jocelyn</option></select>
        </div>
        <div>
          <label>Apps Script Endpoint</label>
          <input id="endpoint" value="https://script.google.com/macros/s/AKfycby46Td8-7ckAlM08Pw9SJ2hC9DBl42sC_47zUgSjmGQrHSgw79Tywc0ztsWayURwrl-Rw/exec"/>
        </div>
        <div>
          <label>Expected Sheet ID</label>
          <input id="sheetId" value="1k1j6Qn5VLXyuFbZm_vOUelB1hD2AT-pAL_0_22LcIrA"/>
        </div>
        <div class="actions">
          <button id="btnSaveCfg" class="btn">Save</button>
          <button id="btnLoad" class="btn">Test Connection</button>
          <button id="btnLoadExpected" class="btn">Load Expected</button>
        </div>
        <div class="progress">
          <span>Progress:</span>
          <div class="bar"><span id="pbar"></span></div>
          <span id="ptext">0 of 0</span>
        </div>
      </div>
    </header>

    <section class="screen active" id="screen1">
      <div class="row">
        <div class="card span-6">
          <h3><span>Item Details</span><span class="muted">Page 1 of 2</span></h3>
          <div class="row">
            <div class="span-12">
              <label>UPC</label>
              <div class="actions">
                <input id="upc" class="mono" placeholder="Scan or enter UPC" />
                <button id="btnScan" class="btn">üì∑ Scan</button>
                <button id="btnGenUPC" class="btn">Gen</button>
              </div>
              <div id="lookupStatus" class="status muted" style="margin-top:6px"></div>
            </div>
            <div class="span-6"><label>Brand</label><input id="brand" /></div>
            <div class="span-6"><label>Description</label><input id="desc" /></div>
            <div class="span-4"><label>COO</label><select id="coo"><option></option><option>USA</option><option>FRANCE</option><option>ITALY</option><option>UAE</option><option>SPAIN</option><option>UK</option></select></div>
            <div class="span-4"><label>Gender</label><select id="gender"><option></option><option>MENS</option><option>LADIES</option><option>UNISEX</option></select></div>
            <div class="span-4"><label>C/D</label><select id="cd"><option></option><option>CLEAN</option><option>DECODED</option></select></div>
            <div class="span-6"><label>Expected Qty</label><input id="expectedQty" type="number" min="0" value="0" /></div>
            <div class="span-6"><label>Counted By</label><select id="counter"><option></option><option>Leydi</option><option>Karina</option><option>Jocelyn</option><option>Kelis</option><option>Mabel</option></select></div>
            <div class="span-6"><label>EdgeNo (old system)</label><input id="edgeno" /></div>
          </div>
        </div>

        <div class="card span-6">
          <h3>Item Dimensions</h3>
          <div class="row">
            <div class="span-3"><label>L (in)</label><input id="len" type="number" step="0.01"/></div>
            <div class="span-3"><label>W (in)</label><input id="wid" type="number" step="0.01"/></div>
            <div class="span-3"><label>H (in)</label><input id="ht" type="number" step="0.01"/></div>
            <div class="span-3"><label>Weight (lb)</label><input id="wt" type="number" step="0.01"/></div>
          </div>
        </div>

        <div class="card span-12">
          <h3>Box Breakdown (Styles 1‚Äì4) ‚Äî with Box Dimensions & Gross Weight</h3>
          <div class="row">
            <div class="span-3">
              <label>Style 1: Boxes √ó Qty/Box</label>
              <div class="actions"><input id="b1_boxes" type="number" min="0" value="0"/><span>√ó</span><input id="b1_qty" type="number" min="0" value="0"/></div>
              <label>Box Dim (L√óW√óH in)</label>
              <div class="actions"><input id="b1_l" type="number" step="0.01"/><input id="b1_w" type="number" step="0.01"/><input id="b1_h" type="number" step="0.01"/></div>
              <label>Box Weight (lb)</label><input id="b1_wt" type="number" step="0.01"/>
            </div>
            <div class="span-3">
              <label>Style 2: Boxes √ó Qty/Box</label>
              <div class="actions"><input id="b2_boxes" type="number" min="0" value="0"/><span>√ó</span><input id="b2_qty" type="number" min="0" value="0"/></div>
              <label>Box Dim (L√óW√óH in)</label>
              <div class="actions"><input id="b2_l" type="number" step="0.01"/><input id="b2_w" type="number" step="0.01"/><input id="b2_h" type="number" step="0.01"/></div>
              <label>Box Weight (lb)</label><input id="b2_wt" type="number" step="0.01"/>
            </div>
            <div class="span-3">
              <label>Style 3: Boxes √ó Qty/Box</label>
              <div class="actions"><input id="b3_boxes" type="number" min="0" value="0"/><span>√ó</span><input id="b3_qty" type="number" min="0" value="0"/></div>
              <label>Box Dim (L√óW√óH in)</label>
              <div class="actions"><input id="b3_l" type="number" step="0.01"/><input id="b3_w" type="number" step="0.01"/><input id="b3_h" type="number" step="0.01"/></div>
              <label>Box Weight (lb)</label><input id="b3_wt" type="number" step="0.01"/>
            </div>
            <div class="span-3">
              <label>Style 4: Boxes √ó Qty/Box</label>
              <div class="actions"><input id="b4_boxes" type="number" min="0" value="0"/><span>√ó</span><input id="b4_qty" type="number" min="0" value="0"/></div>
              <label>Box Dim (L√óW√óH in)</label>
              <div class="actions"><input id="b4_l" type="number" step="0.01"/><input id="b4_w" type="number" step="0.01"/><input id="b4_h" type="number" step="0.01"/></div>
              <label>Box Weight (lb)</label><input id="b4_wt" type="number" step="0.01"/>
            </div>
          </div>
          <div class="row">
            <div class="span-3"><strong>Subtotal Pieces:</strong> <span id="subtotalPieces" class="big">0</span></div>
            <div class="span-3"><strong>Total Cartons:</strong> <span id="subtotalBoxes" class="big">0</span></div>
            <div class="span-3"><strong>Total Cubic Feet:</strong> <span id="cubicFeet" class="big">0.00</span></div>
            <div class="span-3"><strong>Total Gross Weight (lb):</strong> <span id="grossWt" class="big">0.00</span></div>
          </div>
          <div class="actions" style="margin-top:10px">
            <button id="btnCheck" class="btn">Check Discrepancy</button>
            <button id="toScreen2" class="btn primary">Next ‚Üí Page 2</button>
          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="screen2">
      <div class="row">
        <div class="card span-6">
          <h3><span>Putaway & Damage</span><span class="muted">Page 2 of 2</span></h3>
          <div>
            <label>Locations</label>
            <div class="actions" style="margin:6px 0">
              <input id="locInput" placeholder="Scan or type location (e.g., A 01 01 01)" />
              <button id="addLoc" class="btn">+ Add</button>
              <select id="presetLoc"><option value="">Select preset...</option><option>INBOUND - SOLD</option><option>PUT AWAY</option><option>INCOMING</option></select>
              <button id="moveAllLoc1" class="btn">Move All to Loc 1</button>
            </div>
            <div id="locations" style="margin-top:6px"></div>
          </div>
          <div class="row">
            <div class="span-4"><label>Good</label><input id="good" type="number" min="0" value="0"/></div>
            <div class="span-4"><label>Damage ‚Äì Sell</label><input id="damSell" type="number" min="0" value="0"/></div>
            <div class="span-4"><label>Damage ‚Äì Dispose</label><input id="damDisp" type="number" min="0" value="0"/></div>
          </div>
          <div style="margin-top:8px"><strong>Total to Putaway:</strong> <span id="toPutaway" class="big">0</span></div>
          <div style="margin-top:8px">
            <label>Discrepancy Reason (if any)</label>
            <select id="reason"><option></option><option>Pending Recount</option><option>Friend/Family Purchase</option><option>Damaged Goods</option><option>Long Time Discrepancy</option><option>Investigate</option><option>Other</option></select>
          </div>
          <div style="margin-top:8px"><label>Notes</label><textarea id="notes" rows="3"></textarea></div>
          <div class="actions" style="margin-top:12px">
            <button id="backTo1" class="btn">‚Üê Back</button>
            <button id="submitNext" class="btn primary">Submit & Next ‚Üí</button>
          </div>
          <div id="submitStatus" class="status" style="margin-top:8px"></div>
        </div>

        <div class="card span-6">
          <h3>Labels & Export</h3>
          <div class="actions">
            <button id="genLabels" class="btn">Generate Labels</button>
            <button id="printLabels" class="btn print">Print</button>
            <button id="savePdf" class="btn">Save as PDF</button>
          </div>
          <div id="labelPreview" class="noprint"></div>
          <div id="printGuard" class="status warn" style="display:none;margin-top:8px"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Scanner Modal -->
  <div class="modal" id="scanModal">
    <div class="box">
      <div class="actions" style="justify-content:space-between;align-items:center">
        <strong>Camera Scanner</strong>
        <div class="actions">
          <select id="cameraFacing"><option value="environment">Back Camera</option><option value="user">Front Camera</option></select>
          <button id="btnCloseScan" class="btn">‚úï Close</button>
        </div>
      </div>
      <div id="scanner"></div>
      <div class="muted" style="margin-top:6px">Point camera at barcode. Hold steady‚Ä¶</div>
    </div>
  </div>

  <!-- External libs (CDN for speed; we can bundle locally next build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.6/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <script>
    const $=(s,c=document)=>c.querySelector(s); const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
    const val=id=>document.getElementById(id).value.trim(); const num=id=>Number(document.getElementById(id).value)||0;
    const ts=()=>{const d=new Date(),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`};
    function saveCfg(){localStorage.setItem('stock_cfg',JSON.stringify({endpoint:val('endpoint'),sheetId:val('sheetId'),user:val('user')}))}
    function loadCfg(){try{const c=JSON.parse(localStorage.getItem('stock_cfg')||'{}'); if(c.endpoint) $('#endpoint').value=c.endpoint; if(c.sheetId) $('#sheetId').value=c.sheetId; if(c.user) $('#user').value=c.user;}catch(e){}}

    async function callGET(action, params={}){ const u=new URL(val('endpoint')); u.searchParams.set('action', action); Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v)); const res=await fetch(u.toString(), { method:'GET' }); return res.text().then(t=>{ try{return JSON.parse(t);}catch{ return { ok:false, raw:t }; }}); }
    async function callPOSTForm(action, fields={}){ const data=new URLSearchParams(); data.set('action', action); Object.entries(fields).forEach(([k,v])=> data.set(k, String(v))); const res=await fetch(val('endpoint'), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:data.toString() }); return res.text().then(t=>{ try{return JSON.parse(t);}catch{ return { ok:false, raw:t }; }}); }

    function setProgress(done,total){ const pct=total?Math.round((done/total)*100):0; const bar=$('#pbar'); if(bar) bar.style.width=pct+'%'; const t=$('#ptext'); if(t) t.textContent=`${done} of ${total}`; }

    function cfFromBox(i){ const l=num(`b${i}_l`), w=num(`b${i}_w`), h=num(`b${i}_h`); const boxes=num(`b${i}_boxes`), q=num(`b${i}_qty`); if(!(l&&w&&h&&boxes&&q)) return 0; return (l*w*h/1728) * (boxes*q); }
    function gwFromBox(i){ const wt=num(`b${i}_wt`), boxes=num(`b${i}_boxes`); if(!(wt&&boxes)) return 0; return wt*boxes; }
    function calcBreakdown(){ const styles=[1,2,3,4]; const subtotalBoxes=styles.reduce((a,i)=>a+num(`b${i}_boxes`),0); const subtotalPieces=styles.reduce((a,i)=>a+num(`b${i}_boxes`)*num(`b${i}_qty`),0); const cubicFeet = styles.reduce((a,i)=>a+cfFromBox(i),0); const grossWt = styles.reduce((a,i)=>a+gwFromBox(i),0); $('#subtotalBoxes').textContent=subtotalBoxes; $('#subtotalPieces').textContent=subtotalPieces; $('#cubicFeet').textContent=cubicFeet.toFixed(2); $('#grossWt').textContent=grossWt.toFixed(2); $('#good').value=subtotalPieces; $('#toPutaway').textContent=subtotalPieces; return {subtotalBoxes, subtotalPieces, cubicFeet:Number(cubicFeet.toFixed(2)), grossWt:Number(grossWt.toFixed(2))}; }
    function checkDiscrepancy(){ const expected=num('expectedQty'); const {subtotalPieces}=calcBreakdown(); if(!expected){ alert('No expected qty set.'); return null;} if(subtotalPieces===expected){ alert('‚úì Subtotal matches expected'); return true;} alert(`‚ö†Ô∏è Discrepancy: Entered ${subtotalPieces} vs Expected ${expected}`); return false; }
    function go(id){ $$('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }
    function randomUPC(){ const base=Array.from({length:11},()=>Math.floor(Math.random()*10)).join(''); const sum=base.split('').reduce((a,d,i)=>a+(i%2?+d:+d*3),0); const check=(10-(sum%10))%10; return base+check; }

    let expectedMap=new Map();
    async function loadExpected(){ try{ const st=$('#lookupStatus'); st.textContent='Loading expected‚Ä¶'; const data=await callGET('getExpectedInventory', { sheetId: val('sheetId') }); expectedMap=new Map(); (data.items||[]).forEach(it=>{ if(it.upc) expectedMap.set(String(it.upc).replace(/\D/g,''), it); }); st.textContent=`Loaded ${expectedMap.size} expected items.`; setProgress(0, expectedMap.size||0); }catch(e){ $('#lookupStatus').textContent=`Error: ${e.message}`; } }
    function applyExpected(upc){ const clean=String(upc||'').replace(/\D/g,''); if(!clean) return; const it=expectedMap.get(clean); const st=$('#lookupStatus'); if(it){ $('#brand').value=it.brand||''; $('#desc').value=it.desc||it.description||''; $('#gender').value=it.gender||''; $('#coo').value=it.coo||''; $('#expectedQty').value=Number(it.expectedQty||it.qty||0); st.innerHTML='<span class="ok">Matched expected</span>'; } else { st.innerHTML='<span class="warn">UPC not in expected list</span> ‚Äî will log to unexpected_items'; } }

    function makeQRCode(el,text,size=120){ el.innerHTML=''; new QRCode(el,{text,width:size,height:size,correctLevel:QRCode.CorrectLevel.M}); }
    function makeBarcode(el,text){ el.innerHTML=''; const svg=document.createElementNS('http://www.w3.org/2000/svg','svg'); el.appendChild(svg); JsBarcode(svg,text,{format:'CODE128',displayValue:false,lineColor:'#000',height:60,margin:0}); }
    function labelNode(type,data){ if(type==='carton'){ const div=document.createElement('div'); div.className='label carton'; div.innerHTML=`<div class="hdr xl">CARTON LABEL</div><div class="qr" id="qr"></div><div class="grid"><div class="big">${data.brand?data.brand+' ‚Äî ':''}${data.desc||'ITEM'}</div><div class="big">Qty: <strong>${data.subtotalPieces}</strong> pcs ‚Ä¢ Cartons: <strong>${data.subtotalBoxes}</strong></div><div class="muted">Counted By: <strong>${data.counter||data.user||'-'}</strong> ‚Ä¢ ${data.ts}</div></div><div class="barcode" id="bc"></div><div style="text-align:center;margin-top:4px"><span class="mono big">${data.upc}</span></div>`; makeQRCode(div.querySelector('#qr'),`CARTON:${data.upc}:${data.ts}`,120); makeBarcode(div.querySelector('#bc'),data.upc); return div; }
      if(type==='inventoried'){ const div=document.createElement('div'); div.className='label inventoried'; const cf=(data.L&&data.W&&data.H)?((data.L*data.W*data.H)/1728).toFixed(2):'‚Äî'; div.innerHTML=`<div class="hdr xl">INVENTORIED LABEL</div><div class="grid"><div class="big">${data.brand?data.brand+' ‚Äî ':''}${data.desc||'ITEM'}</div><div>Gross Weight: <strong>${data.grossWt||data.wt||'‚Äî'}</strong> lb ‚Ä¢ Cubic Feet: <strong>${cf}</strong></div><div class="muted">Counted By: <strong>${data.counter||data.user||'-'}</strong> ‚Ä¢ ${data.ts}</div></div><div class="barcode" id="bc"></div><div style="text-align:center;margin-top:4px"><span class="mono big">${data.upc}</span></div>`; makeBarcode(div.querySelector('#bc'),data.upc); return div; }
      if(type==='pallet'){ const div=document.createElement('div'); div.className='label pallet'; div.innerHTML=`<div class="hdr xl">PALLET LABEL</div><div class="qr" id="qr"></div><div class="grid"><div class="big">${data.brand?data.brand+' ‚Äî ':''}${data.desc||'ITEM'}</div><div>Total Boxes: <strong>${data.subtotalBoxes}</strong> ‚Ä¢ Total Pieces: <strong>${data.subtotalPieces}</strong></div><div>Date: <strong>${data.ts.split(' ')[0]}</strong> ‚Ä¢ Weight: <strong>${data.grossWt||data.wt||'‚Äî'} lb</strong></div></div><div class="barcode" id="bc"></div><div style="text-align:center;margin-top:4px"><span class="mono big">${data.upc}</span></div>`; makeQRCode(div.querySelector('#qr'),`PALLET:${data.upc}:${data.ts}`,120); makeBarcode(div.querySelector('#bc'),data.upc); return div; } }
    async function saveLabelsAsPDF(){ const nodes=$$('#labelPreview .label'); if(!nodes.length){ alert('Generate labels first.'); return; } const { jsPDF } = window.jspdf; const pdf=new jsPDF({unit:'mm',format:'a4'}); let first=true; for(const node of nodes){ const canvas=await html2canvas(node,{scale:2,backgroundColor:'#ffffff'}); const img=canvas.toDataURL('image/png'); const mmW=210,mmH=297; const w=canvas.width,h=canvas.height; const imgW=Math.min(mmW-20,(mmH-20)*(w/h)); const imgH=imgW*h/w; if(!first) pdf.addPage(); first=false; pdf.addImage(img,'PNG',10,10,imgW,imgH); } pdf.save(`labels_${Date.now()}.pdf`); }

    function collect(){ const b=calcBreakdown(); const discrepancy=(num('expectedQty')>0)&&(b.subtotalPieces!==num('expectedQty'));
      return { upc:val('upc')||randomUPC(), brand:val('brand'), desc:val('desc'), coo:val('coo'), gender:val('gender'), cd:val('cd'), expected:num('expectedQty'), counter:val('counter'), user:val('user'), edgeno:val('edgeno'), L:num('len'), W:num('wid'), H:num('ht'), wt:num('wt'), subtotalBoxes:b.subtotalBoxes, subtotalPieces:b.subtotalPieces, cubicFeet:b.cubicFeet, grossWt:b.grossWt, locations: $$('#locations .chip').map(c=>c.dataset.loc), good:num('good'), damSell:num('damSell'), damDisp:num('damDisp'), reason:val('reason'), notes:val('notes'), ts:ts(), discrepancy };
    }
    async function submitToSheets(){ const payload=collect(); const status=$('#submitStatus'); status.textContent='Submitting‚Ä¶'; status.className='status';
      try{ const res=await callPOSTForm('submitInventory', { user:payload.user, device:navigator.userAgent, 'tabs[inventoryitem_master]':true, 'tabs[labels]':true, 'tabs[damage_log]':(payload.damSell>0||payload.damDisp>0), 'tabs[unexpected_items]': !expectedMap.has(String(payload.upc).replace(/\D/g,'')), 'tabs[carton_registry]':true, 'record[json]': JSON.stringify(payload) }); if(res && res.ok){ status.innerHTML=`<span class="ok">‚úì Submitted</span> ‚Äî Row: ${res.row||'?'} ‚Ä¢ ID: ${res.id||'-'}`; ['upc','expectedQty','b1_boxes','b1_qty','b2_boxes','b2_qty','b3_boxes','b3_qty','b4_boxes','b4_qty','good','damSell','damDisp','reason','notes'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.value=(el.type==='number')?0:''; }); calcBreakdown(); go('#screen1'); $('#upc').focus(); } else { throw new Error(res && res.error ? res.error : 'Unknown submit error'); } }catch(e){ status.innerHTML=`<span class="err">‚úó Submit failed:</span> ${e.message}`; }
    }
    async function guardPrint(){ const data=collect(); const guard=$('#printGuard'); guard.style.display='none'; guard.textContent=''; try{ const res=await callGET('canprint',{ upc:data.upc, qty:data.subtotalPieces, discrepancy:data.discrepancy, status:data.discrepancy?'PENDING':'VERIFIED' }); if(res && res.allowed===false){ guard.style.display='block'; guard.textContent='Warning: Printing before approval. Proceeding per override.'; } }catch(e){}
    }

    let scanning=false;
    async function startScanner(){ if(scanning) return; scanning=true; $('#scanModal').classList.add('active'); const facing=$('#cameraFacing').value||'environment'; Quagga.init({ inputStream:{ type:'LiveStream', target:document.getElementById('scanner'), constraints:{ facingMode:facing } }, decoder:{ readers:['ean_reader','upc_reader','upc_e_reader','code_128_reader'] } }, err=>{ if(err){ alert('Camera init error: '+err); scanning=false; $('#scanModal').classList.remove('active'); return; } Quagga.start(); }); Quagga.onDetected(res=>{ const code=(res&&res.codeResult&&res.codeResult.code)||''; if(code){ try{ Quagga.stop(); }catch(e){} scanning=false; $('#scanModal').classList.remove('active'); document.getElementById('upc').value = code.replace(/\D/g,''); applyExpected(code); try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.5, ctx.currentTime+0.01); o.start(); o.stop(ctx.currentTime+0.12); }catch(e){} }
      }); }
    function stopScanner(){ if(scanning){ try{ Quagga.stop(); }catch(e){} scanning=false; } $('#scanModal').classList.remove('active'); }

    ['b1_boxes','b1_qty','b2_boxes','b2_qty','b3_boxes','b3_qty','b4_boxes','b4_qty','len','wid','ht','b1_l','b1_w','b1_h','b1_wt','b2_l','b2_w','b2_h','b2_wt','b3_l','b3_w','b3_h','b3_wt','b4_l','b4_w','b4_h','b4_wt']
      .forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input',calcBreakdown); });

    const btnCheck=document.getElementById('btnCheck'); if(btnCheck) btnCheck.onclick=checkDiscrepancy;
    const toScreen2=document.getElementById('toScreen2'); if(toScreen2) toScreen2.onclick=()=>{ calcBreakdown(); go('#screen2'); };
    const backTo1=document.getElementById('backTo1'); if(backTo1) backTo1.onclick=()=>go('#screen1');

    const btnGenUPC=document.getElementById('btnGenUPC'); if(btnGenUPC) btnGenUPC.onclick=()=>{ document.getElementById('upc').value=randomUPC(); applyExpected(val('upc')); };
    const upcEl=document.getElementById('upc'); if(upcEl) upcEl.addEventListener('change',e=> applyExpected(e.target.value));

    const addLoc=document.getElementById('addLoc'); if(addLoc) addLoc.onclick=()=>{ const t=val('locInput'); if(!t) return; addLocChip(t); document.getElementById('locInput').value=''; };
    const moveAll=document.getElementById('moveAllLoc1'); if(moveAll) moveAll.onclick=()=>{ const good=num('good'); const chips=$$('#locations .chip'); if(chips[0]) chips[0].dataset.qty=good; };
    const preset=document.getElementById('presetLoc'); if(preset) preset.onchange=()=>{ if(preset.value) addLocChip(preset.value); };

    function addLocChip(text){ const wrap=document.getElementById('locations'); const chip=document.createElement('span'); chip.dataset.loc=text; chip.className='pill chip'; chip.innerHTML=`${text} <button class='btn' style='padding:2px 6px'>√ó</button>`; chip.querySelector('button').onclick=()=>chip.remove(); wrap.appendChild(chip); }

    const genLabels=document.getElementById('genLabels'); if(genLabels) genLabels.onclick=async()=>{ await guardPrint(); const data=collect(); const prev=document.getElementById('labelPreview'); prev.innerHTML=''; ['carton','inventoried','pallet'].forEach(t=> prev.appendChild(labelNode(t, data))); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); };
    const printLabels=document.getElementById('printLabels'); if(printLabels) printLabels.onclick=()=>{ if(!$('#labelPreview .label')){ alert('Generate labels first.'); return; } window.print(); };
    const savePdf=document.getElementById('savePdf'); if(savePdf) savePdf.onclick=saveLabelsAsPDF;

    const submitNext=document.getElementById('submitNext'); if(submitNext) submitNext.onclick=submitToSheets;

    const btnLoad=document.getElementById('btnLoad'); if(btnLoad) btnLoad.onclick=async()=>{ try{ const r=await callGET('ping'); alert(r && r.ok? '‚úì Endpoint reachable' : ('Endpoint error: '+(r.error||r.raw))); }catch(e){ alert('Endpoint error: '+e.message); } };
    const btnLoadExpected=document.getElementById('btnLoadExpected'); if(btnLoadExpected) btnLoadExpected.onclick=loadExpected;
    const btnSaveCfg=document.getElementById('btnSaveCfg'); if(btnSaveCfg) btnSaveCfg.onclick=saveCfg;

    const btnScan=document.getElementById('btnScan'); if(btnScan) btnScan.onclick=startScanner;
    const btnCloseScan=document.getElementById('btnCloseScan'); if(btnCloseScan) btnCloseScan.onclick=stopScanner;

    loadCfg(); calcBreakdown(); setProgress(0,0);
  </script>
</body>
</html>
