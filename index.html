<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>STOCK TAKER APP - PRODUCTION v3-FINAL-FIXED</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --card: #1f2937;
            --muted: #9ca3af;
            --ok: #22c55e;
            --bad: #ef4444;
            --warn: #f59e0b;
            --link: #38bdf8;
        }
        * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; box-sizing: border-box; }
        input, textarea, select { -webkit-user-select: text !important; user-select: text !important; }
        html { height: 100%; width: 100%; margin: 0; padding: 0; }
        body { margin: 0; padding: 0; background: var(--bg); color: #e5e7eb; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; width: 100%; }
        header { padding: 12px 16px; background: linear-gradient(90deg, #0ea5e9, #6366f1); flex-shrink: 0; width: 100%; }
        header h1 { margin: 0; font-size: 18px; }
        header small { opacity: .9; }
        main { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; width: 100%; padding: 0; }
        .main-content { max-width: 100%; padding: 16px; }
        .badge { background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); padding: 4px 8px; border-radius: 4px; font-size: 12px; margin: 0 4px; }
        section { background: var(--card); border: 1px solid rgba(255,255,255,.1); padding: 16px; margin: 12px 0; border-radius: 8px; width: 100%; }
        h2 { margin: 0 0 12px 0; font-size: 16px; border-bottom: 2px solid var(--link); padding-bottom: 8px; }
        h3 { font-size: 14px; margin: 12px 0 8px 0; color: var(--link); }
        .row { display: grid; gap: 12px; margin: 12px 0; width: 100%; }
        .row-1 { grid-template-columns: 1fr; }
        .row-2 { grid-template-columns: 1fr 1fr; }
        .row-3 { grid-template-columns: 1fr 1fr 1fr; }
        label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; font-weight: 600; }
        input, select, textarea { background: var(--panel); color: #fff; border: 1px solid #374151; padding: 8px; border-radius: 4px; font-size: 14px; font-family: inherit; width: 100%; box-sizing: border-box; }
        input:disabled, select:disabled { opacity: 0.5; cursor: not-allowed; }
        input:focus, select:focus { outline: none; border-color: var(--link); box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.1); }
        button { background: var(--link); color: #000; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
        button:hover { background: #0ea5e9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.danger { background: var(--bad); color: #fff; }
        button.danger:hover { background: #dc2626; }
        button.success { background: var(--ok); color: #000; }
        button.success:hover { background: #16a34a; }
        button.warn { background: var(--warn); color: #000; }
        .status-ok { color: var(--ok); font-weight: 600; }
        .grid-box { background: var(--panel); border: 1px solid #374151; padding: 12px; border-radius: 6px; width: 100%; }
        .hidden { display: none !important; }
        .camera-container { background: var(--panel); border: 2px dashed var(--link); padding: 20px; border-radius: 8px; text-align: center; margin: 12px 0; width: 100%; position: relative; }
        #interactive { width: 100%; height: 400px; position: relative; }
        #interactive video, #interactive canvas { width: 100%; height: 100%; }
        #qrVideo { width: 100%; height: 400px; border-radius: 6px; }
        video { width: 100% !important; max-width: 100%; border-radius: 6px; display: block; margin: 12px 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 0; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 8px; max-width: 95vw; max-height: 95vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-close { float: right; cursor: pointer; font-size: 24px; color: var(--muted); }
        .flex-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .flex-buttons button { flex: 1; min-width: 100px; }
        .cuft-display { background: rgba(34, 197, 94, 0.1); border: 1px solid var(--ok); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: var(--ok); text-align: center; }
        .discrepancy-section { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--bad); padding: 12px; border-radius: 6px; margin-top: 12px; }
        
        /* LABEL STYLES - 4x6 Landscape B&W IMPROVED */
        .label-container { background: white; color: black; padding: 0; margin: 0; width: 6in; height: 4in; font-family: 'Arial', sans-serif; display: flex; flex-direction: column; position: relative; page-break-inside: avoid; }
        .label-border-accurate { border: 3px solid black; }
        .label-border-recheck { border: 5px dashed black; }
        .label-header { background: black; color: white; padding: 6px 12px; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .label-header-recheck { background: repeating-linear-gradient(45deg, black, black 10px, #555 10px, #555 20px); }
        .label-status { font-weight: bold; font-size: 11px; padding: 3px 6px; border: 2px solid black; background: white; color: black; }
        .label-status-accurate { text-decoration: underline; }
        .label-status-recheck { border: 3px solid black; transform: rotate(-5deg); }
        .label-body { flex: 1; display: flex; flex-direction: column; padding: 8px 10px; gap: 6px; overflow: hidden; }
        .label-description { background: white; padding: 6px 8px; font-size: 18px; font-weight: bold; line-height: 1.2; border: 1px solid black; border-bottom: 2px solid black; text-align: center; }
        .label-info { font-size: 13px; line-height: 1.3; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 8px; }
        .label-info-row { display: flex; gap: 4px; }
        .label-info-label { font-weight: bold; min-width: 50px; }
        .label-info-value { flex: 1; }
        .label-codes { display: flex; gap: 8px; justify-content: space-between; align-items: flex-end; flex-shrink: 0; }
        .label-qr { width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border: 1px solid black; flex-shrink: 0; }
        .label-barcode-section { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .label-barcode-image { height: 50px; display: flex; align-items: center; }
        .label-barcode-image svg { height: 100%; max-width: 160px; }
        .label-barcode-text { font-size: 10px; font-weight: bold; text-align: center; }
        
        @media (max-width: 768px) {
            .row-2, .row-3 { grid-template-columns: 1fr; }
            body { font-size: 14px; }
            input, select, textarea, button { font-size: 14px; padding: 10px; }
            .flex-buttons { flex-direction: column; }
            .flex-buttons button { width: 100%; min-width: unset; }
        }
        @media print {
            body { background: white; color: black; }
            button, .no-print, header { display: none; }
            section { page-break-inside: avoid; }
            .label-container { page-break-inside: avoid; width: 6in; height: 4in; }
        }
    
    /* Damage + Progress additions */
    .damage-section { background: rgba(249,115,22,0.1); border: 1px solid #f59e0b; padding: 12px; border-radius: 6px; margin-top: 12px; display: none; }
    .damage-inputs { display: grid; gap: 8px; margin-top: 8px; }
    .damage-inputs label { font-size: 12px; color: #9ca3af; margin-bottom: 2px; font-weight: 600; }
    .damage-inputs input { background: #111827; color: #fff; border: 1px solid #374151; padding: 8px; border-radius: 4px; }
    .damage-total { background: #111827; padding: 8px; margin-top: 8px; border-radius: 4px; font-weight: bold; text-align: center; color: #22c55e; display: flex; justify-content: space-between; align-items: center; }
    .progress-tracker { background: #111827; padding: 12px; border-radius: 6px; margin-top: 12px; font-size: 12px; }
    .progress-bar { background: #374151; height: 6px; border-radius: 3px; overflow: hidden; width: 100%; margin-top: 8px; }
    .progress-fill { background: #22c55e; height: 100%; width: 0%; transition: width 0.3s; }

    
/* FORCE ONE LABEL PER PAGE */
@media print {
    @page {
        size: 4in 6in !important;
        margin: 0 !important;
    }

    html, body {
        width: 4in;
        height: 6in;
        margin: 0;
        padding: 0;
    }

    body * {
        visibility: hidden;
    }

    #printArea, #printArea * {
        visibility: visible !important;
    }

    #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 4in;
        height: 6in;
    }

    #printArea > div {
        page-break-after: always !important;
        page-break-inside: avoid !important;
        width: 3.8in;
        height: 5.8in;
        margin: 0.1in;
    }
}

</style>
</head>
<body>
    <header>
        <h1>üì¶ STOCK TAKER - PRODUCTION v3-FINAL-FIXED</h1>
        <small>Inventory Count & Putaway Workflow</small>
    </header>
    <main>
        <div class="main-content">
        <!-- LOGIN SECTION -->
        <section>
            <h2>Access & Configuration</h2>
            <div class="row row-2">
                <div>
                    <label>üë§ Logged in as:</label>
                    <select id="userSelect" onchange="changeUser()">
                        <option value="">‚Äî Select User ‚Äî</option>
                        <option value="Rikki">Rikki</option>
                        <option value="Alberto">Alberto</option>
                        <option value="Isabella">Isabella</option>
                        <option value="Kelis">Kelis</option>
                        <option value="Leydi">Leydi</option>
                        <option value="Veronica">Veronica</option>
                        <option value="Mabel">Mabel</option>
                        <option value="Jocelyn">Jocelyn</option>
                        <option value="WarehouseUser1">WarehouseUser1</option>
                        <option value="WarehouseUser2">WarehouseUser2</option>
                    </select>
                </div>
                <div>
                    <label>üîê Password (username backwards):</label>
                    <input type="password" id="pwInput" placeholder="Enter password" onkeyup="attemptLogin()">
                </div>
            </div>
            <div class="row row-2">
                <div>
                    <label>üìã Google Apps Script Endpoint:</label>
                    <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/..." value="https://script.google.com/macros/s/AKfycbwn7xtE4hrf5FV4dlwzHKSj5xmy3HgCm1x41oYDbdjZwbsH33QsOKF5WxE0wLlAsafzYA/exec"

                </div>
                <div>
                    <label>üìä Expected Inventory Sheet ID:</label>
                    <input type="text" id="sheetId" placeholder="Paste sheet ID (from URL bar)" value="1k1j6Qn5VLXyuFbZm_vOUelB1hD2AT-pAL_0_22LcIrA">
                </div>
            </div>
            <div class="row flex-buttons">
                <button onclick="testSheetConnection()" class="warn">Test Connection</button>
                <button onclick="loadExpectedInventory()" class="success">Load Expected Inventory</button>
            </div>
            <div id="statusMsg" style="margin-top: 12px; padding: 8px; background: var(--panel); border-radius: 4px; font-size: 12px;">Ready to connect to your Google Sheet</div>

      <div class="progress-tracker">
        <strong>üìä Progress:</strong>
        <span id="itemsEntered">0</span> of <span id="totalItems">200</span> items
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <span id="percentComplete">0%</span>
      </div>

        </section>

        <!-- PAGE 1: ITEM & BOX DETAILS -->
        <section id="page1">
            <h2>üìù Page 1: Item Details & Box Breakdown</h2>
            
            <h3>Item Information</h3>
            <div class="row row-2">
                <div>
                    <label>Scan UPC:</label>
                    <div class="flex-buttons" style="gap: 8px;">
                        <input type="text" id="upcInput" placeholder="Scan or paste UPC..." style="flex: 1; min-width: 150px;">
                        <button onclick="scanUpc()" id="btnScanUPC" disabled>üì∑ Scan</button>
                        <button onclick="generateUpc()" id="btnGenUPC" disabled>üîÑ Gen</button>
                    </div>
                </div>
                <div>
                    <label>Expected Qty (from upload):</label>
                    <input type="number" id="expectedQty" readonly style="opacity: 0.7;">
                </div>
            </div>

            <div class="row row-3">
                <div>
                    
                <div style="margin: 16px 0; padding: 12px; background: rgba(59,130,246,0.1); border: 2px solid #3b82f6; border-radius: 8px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #3b82f6;">üë§ Counted By:</label>
                    <select id="countedBy" required style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #3b82f6; border-radius: 6px; background: #1e293b; color: white;">
                        <option value="">‚Äî Select Counter ‚Äî</option>
                        <option>Leydi</option>
                        <option>Karina</option>
                        <option>Jocelyn</option>
                        <option>Kelis</option>
                        <option>Mabel</option>
                    </select>
                </div>
<label>Brand:</label>
                    <input type="text" id="brand" placeholder="e.g., Nike" disabled>
                </div>
                <div>
                    <label>Gender:</label>
                    <select id="gender" disabled>
                        <option>‚Äî Select ‚Äî</option>
                        <option>MENS</option>
                        <option>LADIES</option>
                        <option>UNISEX</option>
                    </select>
                </div>
                <div>
                    <label>COO:</label>
                    <select id="coo" disabled>
                        <option>‚Äî Select ‚Äî</option>
                        <option>USA</option>
                        <option>CHINA</option>
                        <option>VIETNAM</option>
                        <option>INDIA</option>
                        <option>MEXICO</option>
                        <option>FRANCE</option>
                        <option>ITALY</option>
                        <option>GERMANY</option>
                        <option>POLAND</option>
                        <option>UAE</option>
                        <option>UK</option>
                        <option>SPAIN</option>
                        <option>PORTUGAL</option>
                        <option>NETHERLANDS</option>
                        <option>SWITZERLAND</option>
                        <option>TURKEY</option>
                        <option>MOROCCO</option>
                        <option>OMAN</option>
                    </select>
                </div>
            </div>

            <div class="row row-2">
                <div>
                    <label>Item Description:</label>
                    <textarea id="itemDesc" rows="2" placeholder="Item details, size, color, etc..." disabled></textarea>
                </div>
                <div>
                    <label>EdgeNo (from old system):</label>
                    <input type="text" id="edgeNo" placeholder="EdgeNo..." disabled>
                </div>
            </div>

            <div class="row row-2">
                <div>
                    <label>Is Clean?</label>
                    <select id="isClean" disabled>
                        <option>‚Äî Select ‚Äî</option>
                        <option>Y (Clean)</option>
                        <option>N (Needs Cleaning)</option>
                    </select>
                </div>
                <div></div>
            </div>

            <h3>Item Weight & Dimensions</h3>
            <div class="row row-3">
                <div>
                    <label>Weight (lb):</label>
                    <input type="number" id="itemWeight" placeholder="0.0" step="0.1" disabled>
                </div>
                <div>
                    <label>Length (in):</label>
                    <input type="number" id="itemLength" placeholder="0" step="0.1" disabled>
                </div>
                <div>
                    <label>Width (in):</label>
                    <input type="number" id="itemWidth" placeholder="0" step="0.1" disabled>
                </div>
            </div>
            <div class="row row-1">
                <div>
                    <label>Height (in):</label>
                    <input type="number" id="itemHeight" placeholder="0" step="0.1" disabled>
                </div>
            </div>

            <h3>Box Breakdown (Styles 1‚Äì4) <span class="badge">At least one required</span></h3>
            <div id="boxGrid"></div>

            <div class="row row-2" style="margin-top: 16px; background: var(--panel); padding: 12px; border-radius: 6px;">
                <div>
                    <label style="color: var(--ok);">‚úì Subtotal Pieces:</label>
                    <div style="font-size: 18px; font-weight: 600;" id="subtotalPcs">0</div>
                </div>
                <div>
                    <label style="color: var(--ok);">‚úì Total Cubic Feet:</label>
                    <div style="font-size: 18px; font-weight: 600;" id="totalCuFt">0.00</div>
                </div>
            </div>

            <div class="row flex-buttons">
                <button onclick="checkDiscrepancy()" id="btnCheckDiscrep" disabled class="warn">‚ö†Ô∏è Check Discrepancy</button>
                <button onclick="nextPage()" id="btnNextPage" disabled class="success">‚úì Next ‚Üí Page 2</button>
            </div>
            <div id="discrepancyMsg" style="margin-top: 12px; padding: 12px; background: var(--panel); border-radius: 4px; font-size: 12px; color: var(--muted);">Discrepancy check will run before submit</div>
        </section>

        <!-- PAGE 2: PUTAWAY & LABELS -->
        <section id="page2" class="hidden">
            <h2>üìç Page 2: Putaway & Labels</h2>

            <div style="background: var(--panel); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                <strong>Summary from Page 1:</strong><br>
                UPC: <span id="p2Upc">‚Äî</span> | Qty: <span id="p2Qty">0</span> pcs<br>
                Breakdown: <span id="p2Breakdown">‚Äî</span>
            </div>

            <h3>Putaway Location(s)</h3>
            <div style="margin-bottom: 12px;">
                <label>üì∏ Scan Location QR (or manual):</label>
                <div class="flex-buttons" style="gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="locInput" placeholder="Location code / QR scan..." style="flex: 1; min-width: 150px;">

            <div style="margin: 8px 0;">
              <label>Or choose a preset location:</label>
              <select id="locSelect" onchange="onSelectLocation()" disabled>
                <option value="">Select location...</option>
              </select>
            </div>

                    <button onclick="scanLocation()" id="btnScanLoc" disabled>üì∑ Scan</button>
                </div>
                <div class="row flex-buttons">
                    <button onclick="addLocation()" id="btnAddLoc" disabled class="success">+ Add Location</button>
                    <button onclick="moveAllLoc()" id="btnMoveAll" disabled class="warn">Move All to Loc 1</button>
                </div>
            </div>

            <div id="locGrid" style="display: grid; gap: 8px;"></div>

        <div id="damageSection" class="damage-section">
          <h3>‚ö†Ô∏è Damage Breakdown (Counted: <span id="countedQtyDisplay">0</span>)</h3>
          <div class="damage-inputs">
            <label>Good / Saleable:</label>
            <input type="number" id="qtyGood" value="0" min="0" onchange="validateDamage()" disabled>
            <label>Damaged (Unbox & Sell):</label>
            <input type="number" id="qtyDamagedUnbox" value="0" min="0" onchange="validateDamage()" disabled>
            <label>Damaged (Dispose - Leaking):</label>
            <input type="number" id="qtyDamagedDispose" value="0" min="0" onchange="validateDamage()" disabled>
          </div>
          <div class="damage-total">
            Total: <span id="damageTotal">0</span>
            <span id="damageStatus">‚úì</span>
          </div>
        </div>


            <div class="row row-2" style="margin-top: 16px; background: var(--panel); padding: 12px; border-radius: 6px;">
                <div>
                    <label>Total to Putaway:</label>
                    <div style="font-size: 18px; font-weight: 600;" id="putawayTotal">0</div>
                </div>
                <div>
                    <label>OK to Submit?</label>
                    <div style="font-size: 18px; font-weight: 600;" id="okToSubmit">‚ùå No</div>
                </div>
            </div>

            <h3>Notes</h3>
            <textarea id="putawayNotes" rows="2" placeholder="Any special handling, damage, or notes..." disabled></textarea>

            <!-- DISCREPANCY REASON (Only shows if count doesn't match) -->
            <div id="discrepancyReasonSection" class="discrepancy-section hidden">
                <h3 style="margin-top: 0;">‚ö†Ô∏è Inventory Discrepancy Detected</h3>
                <label>Please select reason for discrepancy:</label>
                <select id="discrepancyReason" disabled style="margin-bottom: 8px;">
                    <option value="">‚Äî Select Reason ‚Äî</option>
                    <option value="Pending Recount">Pending Recount</option>
                    <option value="Friend/Family Purchase">Friend/Family Purchase</option>
                    <option value="Damaged Goods">Damaged Goods</option>
                    <option value="Long Time Discrepancy">Long Time Discrepancy</option>
                    <option value="Investigate">Investigate</option>
                    <option value="Other">Other (explain in notes)</option>
                </select>
            </div>

            <div class="row flex-buttons">
                <button onclick="backToPage1()" class="muted" style="background: #6b7280;">‚Üê Back to Page 1</button>
                <button onclick="downloadJSON()" id="btnDownloadJSON" disabled class="warn">üì• Download JSON</button>
                <button onclick="submitToSheet()" id="btnSubmit" disabled class="success">‚úì Submit to Sheet</button>
            </div>
        </section>

        <!-- LABELS SECTION -->
        <section id="labelSection" class="hidden">
            <h2>üè∑Ô∏è INVENTORIED LABEL - 4√ó6 LANDSCAPE</h2>
            <div id="labelPreview" style="background: #f5f5f5; padding: 20px; margin: 12px 0; border-radius: 6px; display: flex; justify-content: center;">
                <!-- Label will render here -->
            </div>
            <div class="row flex-buttons">
                <button onclick="window.print()" class="success">üñ®Ô∏è Print Label</button>
                <button onclick="saveLabelToSheet()" id="btnSaveLabel" disabled class="success">üíæ Save & Log</button>
            </div>
        </section>

        <!-- HELP & INFO -->
        <section style="background: rgba(56, 189, 248, 0.1); border: 1px solid var(--link);">
            <h2>‚ÑπÔ∏è Quick Reference</h2>
            <div style="font-size: 13px; line-height: 1.6; color: var(--muted);">
                <strong>Camera Access:</strong> App requires HTTPS and camera permission. Grant when prompted on tablet.<br>
                <strong>Item Master:</strong> Auto-populated on first UPC scan, reused for future scans (no re-entry!).<br>
                <strong>Labels (B&W):</strong> ACCURATE = solid border | RECHECK = dashed border + hatching header<br>
                <strong>Discrepancy Reasons:</strong> Required field when count doesn't match expected quantity.<br>
                <strong>Login:</strong> Password is your username spelled backwards (e.g., "Rikki" ‚Üí "ikkiR").<br>
                <strong>Saving:</strong> Data syncs to BOTH item_master (lookup) and inventory (log).
            </div>
        </section>
        </div>
    </main>

    <!-- CAMERA MODAL -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCamera()">‚úï</span>
            <h3 id="scanTitle">üì∑ Camera Scanner</h3>
            <div class="camera-container">
                <div id="interactive"></div>
                <video id="qrVideo" class="hidden"></video>
            </div>
            <div style="text-align: center; margin-top: 16px;">
                <button onclick="closeCamera()" class="danger">Cancel</button>
            </div>
            <small id="scanHint" style="display: block; margin-top: 12px; color: var(--ok); text-align: center; font-weight: 600;">Point camera at barcode. Hold steady...</small>
        </div>
    </div>

    <!-- SUBMISSION CONFIRMATION MODAL -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="modal-close" onclick="closeConfirmation()">‚úï</span>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                <h2 style="margin: 0; color: var(--ok);">Inventory Submitted Successfully!</h2>
            </div>
            
            <div style="background: var(--panel); padding: 16px; border-radius: 6px; margin-bottom: 16px; font-size: 13px;">
                <div style="margin-bottom: 12px; border-bottom: 1px solid #374151; padding-bottom: 12px;">
                    <strong>üì¶ Item Details:</strong><br>
                    UPC: <span id="confUpc">‚Äî</span><br>
                    Brand: <span id="confBrand">‚Äî</span><br>
                    Qty: <span id="confQty">0</span> pcs
                </div>
                <div style="margin-bottom: 12px; border-bottom: 1px solid #374151; padding-bottom: 12px;">
                    <strong>üìç Putaway:</strong><br>
                    Locations: <span id="confLocs">‚Äî</span><br>
                    Timestamp: <span id="confTime">‚Äî</span>
                </div>
                <div>
                    <strong>‚úÖ Status:</strong><br>
                    Data synced to item_master & inventory logs
                </div>
            </div>

            <div class="row flex-buttons">
                <button onclick="printLabel()" class="success">üñ®Ô∏è Print Label</button>
                <button onclick="nextItemReset()" id="btnNextItem" class="success" style="flex: 1.2;">üì¶ Next Item ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        let state = {
            user: null,
            isLoggedIn: false,
            expectedInv: {},
            itemMaster: {},
            currentData: {},
            locations: [],
            cameraType: 'upc'
        };
        let quaggaActive = false;
        let qrScanActive = false;
        let detectionCounts = {};

        function init() {
            const saved = localStorage.getItem('stockTakerState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    Object.assign(state, parsed);
                } catch (e) {
                    console.error('Failed to restore state:', e);
                }
            }
            renderBoxGrid();
            showStatus('App ready. Select user to unlock features.', 'info');
        }

        function changeUser() {
            const u = document.getElementById('userSelect').value;
            state.user = u || null;
            state.isLoggedIn = false;
            document.getElementById('pwInput').value = '';
            updateUiLock();
        }

        function attemptLogin() {
            if (!state.user) {
                showStatus('Please select a user first', 'error');
                return;
            }
            const pw = document.getElementById('pwInput').value;
            const correctPw = state.user.split('').reverse().join('');
            if (pw === correctPw && pw.length > 0) {
                state.isLoggedIn = true;
                showStatus(`‚úì Logged in as ${state.user}`, 'ok');
                updateUiLock();
            }
        }

        function updateUiLock() {
            const locked = !state.isLoggedIn;
            document.querySelectorAll('input[disabled], select[disabled], textarea[disabled], button[disabled]').forEach(el => {
                if (el.id.startsWith('btn') || ['brand', 'gender', 'coo', 'itemDesc', 'edgeNo', 'isClean', 'itemWeight', 'itemLength', 'itemWidth', 'itemHeight', 'putawayNotes', 'discrepancyReason'].includes(el.id)) {
                    el.disabled = locked;
                }
            });
            ['btnScanUPC', 'btnGenUPC', 'btnCheckDiscrep', 'btnScanLoc', 'btnAddLoc', 'btnMoveAll'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = locked;
            });
            
            for (let i = 1; i <= 4; i++) {
                ['Qty', 'Pcs', 'Weight', 'Length', 'Width', 'Height'].forEach(field => {
                    const el = document.getElementById(`box${i}${field}`);
                    if (el) el.disabled = locked;
                });
            }
        }

        function scanUpc() {
            state.cameraType = 'upc';
            document.getElementById('scanTitle').textContent = 'üì∑ Scanning UPC Barcode';
            openCamera();
        }

        function scanLocation() {
            state.cameraType = 'location';
            document.getElementById('scanTitle').textContent = 'üì∑ Scanning QR / Location Code';
            openCamera();
        }

        function openCamera() {
            document.getElementById('cameraModal').classList.add('active');
            detectionCounts = {};
            
            if (state.cameraType === 'location') {
                openQRScanner();
            } else {
                openBarcodeScanner();
            }
        }

        function openBarcodeScanner() {
            if (typeof Quagga === 'undefined') {
                showStatus('‚ùå Camera library not loaded. Refresh page.', 'error');
                closeCamera();
                return;
            }

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        facingMode: "environment",
                        aspectRatio: { min: 1, max: 2 }
                    },
                    area: {
                        top: "20%",
                        right: "10%",
                        left: "10%",
                        bottom: "20%"
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ],
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: true,
                        drawScanline: true,
                        showPattern: true
                    },
                    multiple: false
                },
                locate: true,
                locator: {
                    halfSample: true,
                    patchSize: "medium"
                },
                numOfWorkers: (navigator.hardwareConcurrency || 4),
                frequency: 10
            }, function(err) {
                if (err) {
                    console.error('Quagga init error:', err);
                    showStatus('‚ùå Camera error. Grant permission and ensure HTTPS.', 'error');
                    closeCamera();
                    return;
                }
                
                Quagga.start();
                quaggaActive = true;
                showStatus('üì∑ Camera ready. Scanning barcodes...', 'info');
                document.getElementById('scanHint').textContent = 'üéØ Hold barcode steady in frame...';
            });

            Quagga.onDetected(onBarcodeDetected);
        }

        function onBarcodeDetected(result) {
            if (!quaggaActive) return;

            const code = result.codeResult.code;
            
            if (!detectionCounts[code]) {
                detectionCounts[code] = 0;
            }
            detectionCounts[code]++;
            
            if (detectionCounts[code] >= 3) {
                document.getElementById('scanHint').textContent = `‚úÖ Detected: ${code}`;
                document.getElementById('scanHint').style.color = 'var(--ok)';
                
                setTimeout(() => {
                    fillScannedCode(code);
                }, 500);
            } else {
                document.getElementById('scanHint').textContent = `üì≤ Detecting... (${detectionCounts[code]}/3)`;
                document.getElementById('scanHint').style.color = 'var(--warn)';
            }
        }

        function openQRScanner() {
            if (typeof jsQR === 'undefined') {
                showStatus('‚ùå QR library not loaded. Refresh page.', 'error');
                closeCamera();
                return;
            }

            const video = document.getElementById('qrVideo');
            video.classList.remove('hidden');
            document.getElementById('interactive').style.display = 'none';

            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
            })
            .then(stream => {
                video.srcObject = stream;
                video.play();
                qrScanActive = true;
                showStatus('üì∑ Camera ready. Scanning QR codes...', 'info');
                document.getElementById('scanHint').textContent = 'üì¶ Point camera at QR code...';
                scanQRFrames();
            })
            .catch(err => {
                showStatus('‚ùå Camera access denied. Grant permission.', 'error');
                closeCamera();
            });
        }

        function scanQRFrames() {
            const video = document.getElementById('qrVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let lastDetectedCode = null;
            let detectionStreak = 0;

            const processFrame = () => {
                if (!qrScanActive) return;

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    try {
                        const qrCode = jsQR(imageData.data, imageData.width, imageData.height);
                        
                        if (qrCode) {
                            const detectedData = qrCode.data;
                            
                            if (detectedData === lastDetectedCode) {
                                detectionStreak++;
                            } else {
                                detectionStreak = 1;
                                lastDetectedCode = detectedData;
                            }
                            
                            if (detectionStreak >= 2) {
                                document.getElementById('scanHint').textContent = `‚úÖ Detected: ${detectedData}`;
                                document.getElementById('scanHint').style.color = 'var(--ok)';
                                
                                setTimeout(() => {
                                    fillScannedCode(detectedData);
                                }, 500);
                                return;
                            } else {
                                document.getElementById('scanHint').textContent = `üì≤ Detecting... (${detectionStreak}/2)`;
                                document.getElementById('scanHint').style.color = 'var(--warn)';
                            }
                        } else {
                            detectionStreak = 0;
                            document.getElementById('scanHint').textContent = 'üì¶ Point camera at QR code...';
                            document.getElementById('scanHint').style.color = 'var(--ok)';
                        }
                    } catch (e) {
                        // Continue scanning
                    }
                }
                
                setTimeout(processFrame, 100);
            };

            processFrame();
        }

        function fillScannedCode(code) {
            if (state.cameraType === 'upc') {
                document.getElementById('upcInput').value = code;
                lookupUpc(code);
                showStatus(`‚úì UPC Scanned: ${code}`, 'ok');
            } else if (state.cameraType === 'location') {
                document.getElementById('locInput').value = code;
                showStatus(`‚úì Location Scanned: ${code}`, 'ok');
            }
            closeCamera();
        }

        function closeCamera() {
            if (quaggaActive) {
                Quagga.stop();
                quaggaActive = false;
            }
            if (qrScanActive) {
                const video = document.getElementById('qrVideo');
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                qrScanActive = false;
                video.classList.add('hidden');
                document.getElementById('interactive').style.display = 'block';
            }
            document.getElementById('cameraModal').classList.remove('active');
            document.getElementById('interactive').innerHTML = '';
            detectionCounts = {};
        }

        function generateUpc() {
            const generated = Math.floor(Math.random() * 9.0e+12).toString().padStart(12, '0');
            document.getElementById('upcInput').value = generated;
            showStatus(`Generated UPC: ${generated}`, 'ok');
        }

        function lookupUpc(upc) {
            if (state.itemMaster[upc]) {
                const inv = state.itemMaster[upc];
                document.getElementById('brand').value = inv.brand || '';
                document.getElementById('gender').value = inv.gender || '‚Äî Select ‚Äî';
                document.getElementById('coo').value = inv.coo || '‚Äî Select ‚Äî';
                document.getElementById('itemDesc').value = inv.description || '';
                document.getElementById('edgeNo').value = inv.edgeNo || '';
                document.getElementById('itemWeight').value = inv.itemWeight || '0';
                document.getElementById('itemLength').value = inv.itemLength || '0';
                document.getElementById('itemWidth').value = inv.itemWidth || '0';
                document.getElementById('itemHeight').value = inv.itemHeight || '0';
                document.getElementById('expectedQty').value = inv.expectedQty || '0';
                showStatus(`‚úì Loaded from Item Master (previously scanned)`, 'ok');
            }
            else if (state.expectedInv[upc]) {
                const inv = state.expectedInv[upc];
                document.getElementById('brand').value = inv.brand || '';
                document.getElementById('gender').value = inv.gender || '‚Äî Select ‚Äî';
                document.getElementById('coo').value = inv.coo || '‚Äî Select ‚Äî';
                document.getElementById('itemDesc').value = inv.description || '';
                document.getElementById('expectedQty').value = inv.expectedQty || '0';
                showStatus(`‚úì Loaded from expected inventory`, 'ok');
            } else {
                document.getElementById('expectedQty').value = '0';
                showStatus('‚ÑπÔ∏è UPC not found. Fill in details (will be saved to Item Master).', 'warn');
            }
        }

        function testSheetConnection() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            if (!url) {
                showStatus('‚ùå Enter Apps Script URL first', 'error');
                return;
            }
            
            showStatus('üîÑ Testing connection...', 'info');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'ping', test: true })
            })
            .then(() => {
                showStatus(`‚úì Connected to Apps Script endpoint!`, 'ok');
            })
            .catch(e => {
                showStatus(`‚úì Endpoint reachable (no-cors mode). Ready to submit data.`, 'ok');
            });
        }

        function submitToSheet() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            if (!url) {
                showStatus('‚ùå Apps Script URL not set', 'error');
                return;
            }
            
            const expected = parseInt(document.getElementById('expectedQty').value || 0);
            const entered = getSubtotalPcs();
            const hasDiscrepancy = entered !== expected && expected > 0;
            
            if (hasDiscrepancy) {
                const reason = document.getElementById('discrepancyReason').value;
                if (!reason) {
                    showStatus('‚ùå Please select a discrepancy reason', 'error');
                    return;
                }
            }
            
            const isAccurate = entered === expected && expected > 0;
            
            const location1_code = state.locations.length > 0 ? state.locations[0] : '';
            
            let location1_qty = 0;
            const locQtyInputs = document.querySelectorAll('.locQty');
            if (locQtyInputs.length > 0) {
                location1_qty = parseInt(locQtyInputs[0].value || 0);
            }
            
            const payload = {
                action: 'addInventory',
                data: {
                    timestamp: new Date().toISOString(),
                    user: state.user,
                    countedBy: document.getElementById("countedBy")?.value || state.user,
                    upc: document.getElementById('upcInput').value,
                    brand: document.getElementById('brand').value,
                    gender: document.getElementById('gender').value,
                    coo: document.getElementById('coo').value,
                    description: document.getElementById('itemDesc').value,
                    edgeNo: document.getElementById('edgeNo').value,
                    isClean: document.getElementById('isClean').value,
                    expectedQty: expected,
                    countedQty: entered,
                    itemWeight: parseFloat(document.getElementById('itemWeight').value || 0),
                    itemLength: parseFloat(document.getElementById('itemLength').value || 0),
                    itemWidth: parseFloat(document.getElementById('itemWidth').value || 0),
                    itemHeight: parseFloat(document.getElementById('itemHeight').value || 0),
                    breakdown: getBreakdownSummary(),
                    totalCubicFeet: parseFloat(document.getElementById('totalCuFt').textContent),
                    location1_code: location1_code,
                    location1_qty: location1_qty,
                    locations: JSON.stringify(state.locations),
                    discrepancyReason: document.getElementById('discrepancyReason').value || '',
                    notes: document.getElementById('putawayNotes').value,
                    status: 'completed',
                    accurate: isAccurate
                }
            };
            
            showStatus('üì§ Submitting to Google Sheet...', 'info');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                showStatus(`‚úì Submitted to Sheet successfully!`, 'ok');
                
                const upc = document.getElementById('upcInput').value;
                state.itemMaster[upc] = {
                    brand: document.getElementById('brand').value,
                    gender: document.getElementById('gender').value,
                    coo: document.getElementById('coo').value,
                    description: document.getElementById('itemDesc').value,
                    edgeNo: document.getElementById('edgeNo').value,
                    itemWeight: parseFloat(document.getElementById('itemWeight').value || 0),
                    itemLength: parseFloat(document.getElementById('itemLength').value || 0),
                    itemWidth: parseFloat(document.getElementById('itemWidth').value || 0),
                    itemHeight: parseFloat(document.getElementById('itemHeight').value || 0),
                    expectedQty: expected
                };
                saveState();
                
                showConfirmation(payload.data);
            })
            .catch(e => {
                showStatus(`‚ö†Ô∏è Data sent. Check Google Sheet.`, 'warn');
                showConfirmation(payload.data);
            });
        }

        function showConfirmation(data) {
            document.getElementById('confUpc').textContent = data.upc || '‚Äî';
            document.getElementById('confBrand').textContent = data.brand || '‚Äî';
            document.getElementById('confQty').textContent = data.countedQty;
            document.getElementById('confLocs').textContent = data.location1_code || 'N/A';
            document.getElementById('confTime').textContent = new Date(data.timestamp).toLocaleString();
            document.getElementById('confirmationModal').classList.add('active');
        }

        function closeConfirmation() {
            document.getElementById('confirmationModal').classList.remove('active');
        }

        
// Send carton IDs to carton_registry sheet
async function registerCartons(cartonData) {
    try {
        const response = await fetch(state.scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'registerCartons',
                data: cartonData
            })
        });
        console.log('‚úì Cartons registered:', cartonData.cartons.length);
    } catch (error) {
        console.error('Error registering cartons:', error);
    }
}

function printLabel() {
            generateLabel();
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function nextItemReset() {
            closeConfirmation();
            resetForm();
            showStatus('‚úì Ready for next item!', 'ok');
        }

        async function loadExpectedInventory() {
    try {
        const scriptUrl = document.getElementById('appsScriptUrl').value;
        if (!scriptUrl) {
            showNotification('‚ö†Ô∏è Please configure Script URL first', 'warn');
            return;
        }

        showNotification('üìä Loading inventory from Google Sheet...', 'info');
        console.log('=== LOADING EXPECTED INVENTORY ===');
        console.log('Script URL:', scriptUrl);
        console.log('Sending action: getExpectedInventory');

        const response = await fetch(scriptUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'getExpectedInventory',
                data: {}
            })
        });

        console.log('Response received, status:', response.status);
        const result = await response.json();
        console.log('Result status:', result.status);
        console.log('Result count:', result.count);

        if (result.status === 'success' && result.items) {
            state.expectedInventory = {};

            result.items.forEach((item, index) => {
                state.expectedInventory[item.upc] = item;
                if (index < 3) {
                    console.log('Sample item ' + (index + 1) + ':', item);
                }
            });

            const count = result.items.length;
            console.log('‚úÖ SUCCESS: Loaded', count, 'items into state.expectedInventory');
            console.log('Total UPCs in state:', Object.keys(state.expectedInventory).length);

            showNotification('‚úÖ Loaded ' + count + ' items from expected inventory', 'success');
            saveState();
        } else {
            console.error('‚ùå Bad response:', result);
            throw new Error(result.message || 'Invalid response from server');
        }

    } catch (error) {
        console.error('‚ùå LOAD ERROR:', error);
        console.error('Error message:', error.message);
        showNotification('‚ùå Failed to load: ' + error.message, 'error');
    }
}

        showNotification('üìä Loading inventory from Google Sheet...', 'info');
        console.log('=== LOADING EXPECTED INVENTORY ===');
        console.log('Script URL:', scriptUrl);
        console.log('Sending action: getExpectedInventory');

        const response = await fetch(scriptUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'getExpectedInventory',
                data: {}
            })
        });

        console.log('Response received, status:', response.status);
        const result = await response.json();
        console.log('Result status:', result.status);
        console.log('Result count:', result.count);

        if (result.status === 'success' && result.items) {
            state.expectedInventory = {};

            result.items.forEach((item, index) => {
                state.expectedInventory[item.upc] = item;
                if (index < 3) {
                    console.log('Sample item ' + (index + 1) + ':', item);
                }
            });

            const count = result.items.length;
            console.log('‚úÖ SUCCESS: Loaded', count, 'items into state.expectedInventory');
            console.log('Total UPCs in state:', Object.keys(state.expectedInventory).length);

            showNotification('‚úÖ Loaded ' + count + ' items from expected inventory', 'success');
            saveState();
        } else {
            console.error('‚ùå Bad response:', result);
            throw new Error(result.message || 'Invalid response from server');
        }

    } catch (error) {
        console.error('‚ùå LOAD ERROR:', error);
        console.error('Error message:', error.message);
        showNotification('‚ùå Failed to load: ' + error.message, 'error');
    }
},
                '2.34567890123e+11': { brand: 'Adidas', gender: 'LADIES', coo: 'CHINA', description: 'Ultraboost 22', expectedQty: 12 },
                '3.45678901234e+11': { brand: 'Puma', gender: 'UNISEX', coo: 'VIETNAM', description: 'RS-X3', expectedQty: 36 }
            };
            
            state.expectedInv = demoInventory;
            showStatus(`‚úì Loaded ${Object.keys(state.expectedInv).length} items from expected inventory`, 'ok');
            saveState();
        }

        function renderBoxGrid() {
            const grid = document.getElementById('boxGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const boxDiv = document.createElement('div');
                boxDiv.className = 'grid-box';
                boxDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                        <span>Box Style ${i}</span>
                        <div class="cuft-display" id="box${i}CuFt">0.00 cu ft</div>
                    </div>
                    <div class="row row-3">
                        <div>
                            <label>Qty:</label>
                            <input type="number" id="box${i}Qty" value="0" min="0" onchange="calcTotals()" disabled>
                        </div>
                        <div>
                            <label>Pcs/Box:</label>
                            <input type="number" id="box${i}Pcs" value="0" min="0" onchange="calcTotals()" disabled>
                        </div>
                        <div>
                            <label>Wt/Box (lb):</label>
                            <input type="number" id="box${i}Weight" value="0" step="0.1" onchange="calcTotals()" disabled>
                        </div>
                    </div>
                    <div class="row row-3">
                        <div>
                            <label>L (in):</label>
                            <input type="number" id="box${i}Length" value="0" step="0.1" onchange="calcTotals()" disabled>
                        </div>
                        <div>
                            <label>W (in):</label>
                            <input type="number" id="box${i}Width" value="0" step="0.1" onchange="calcTotals()" disabled>
                        </div>
                        <div>
                            <label>H (in):</label>
                            <input type="number" id="box${i}Height" value="0" step="0.1" onchange="calcTotals()" disabled>
                        </div>
                    </div>
                `;
                grid.appendChild(boxDiv);
            }
        }

        function calcTotals() {
            let totalPcs = 0;
            let totalCuFt = 0;
            
            for (let i = 1; i <= 4; i++) {
                const qty = parseInt(document.getElementById(`box${i}Qty`).value || 0);
                const pcs = parseInt(document.getElementById(`box${i}Pcs`).value || 0);
                const length = parseFloat(document.getElementById(`box${i}Length`).value || 0);
                const width = parseFloat(document.getElementById(`box${i}Width`).value || 0);
                const height = parseFloat(document.getElementById(`box${i}Height`).value || 0);
                
                totalPcs += qty * pcs;
                
                let cuFtPerBox = 0;
                if (length > 0 && width > 0 && height > 0) {
                    cuFtPerBox = (length * width * height) / 1728;
                    totalCuFt += qty * cuFtPerBox;
                }
                
                const cuFtDisplay = document.getElementById(`box${i}CuFt`);
                if (cuFtDisplay) {
                    cuFtDisplay.textContent = `${cuFtPerBox.toFixed(3)} cu ft`;
                    cuFtDisplay.style.opacity = cuFtPerBox > 0 ? '1' : '0.5';
                }
            }
            
            document.getElementById('subtotalPcs').textContent = totalPcs;
            document.getElementById('totalCuFt').textContent = totalCuFt.toFixed(3);
            
            document.getElementById('btnNextPage').disabled = !state.isLoggedIn || totalPcs === 0;
        }

        function getSubtotalPcs() {
            return parseInt(document.getElementById('subtotalPcs').textContent);
        }

        function getBreakdownSummary() {
            const boxes = [];
            for (let i = 1; i <= 4; i++) {
                const qty = parseInt(document.getElementById(`box${i}Qty`).value || 0);
                const pcs = parseInt(document.getElementById(`box${i}Pcs`).value || 0);
                if (qty > 0) {
                    boxes.push(`S${i}:${qty}√ó${pcs}`);
                }
            }
            return boxes.join('|') || 'N/A';
        }

        function checkDiscrepancy() {
            const expected = parseInt(document.getElementById('expectedQty').value || 0);
            const entered = getSubtotalPcs();
            let msg = `Expected: ${expected} | Entered: ${entered} | `;
            
            if (entered === expected && expected > 0) {
                msg += '‚úì MATCH!';
                document.getElementById('discrepancyMsg').innerHTML = `<span class="status-ok">${msg}</span>`;
            } else if (entered > expected && expected > 0) {
                msg += `‚ö†Ô∏è OVER by ${entered - expected}`;
                document.getElementById('discrepancyMsg').innerHTML = `<span class="status-ok">${msg}</span>`;
            } else if (entered < expected && expected > 0) {
                msg += `‚ùå SHORT by ${expected - entered}`;
                document.getElementById('discrepancyMsg').innerHTML = `<span class="status-ok">${msg}</span>`;
            } else {
                msg += '‚ÑπÔ∏è No expected data';
                document.getElementById('discrepancyMsg').innerHTML = `<span style="color: var(--muted);">${msg}</span>`;
            }
        }

        function nextPage() {
            if (getSubtotalPcs() === 0) {
                showStatus('‚ùå At least one box required', 'error');
                return;
            }
            
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('page2').classList.remove('hidden');
            
            document.getElementById('p2Upc').textContent = document.getElementById('upcInput').value || '‚Äî';
            document.getElementById('p2Qty').textContent = getSubtotalPcs();
            document.getElementById('p2Breakdown').textContent = getBreakdownSummary();
            
            renderLocationGrid();
            updateDiscrepancyDisplay();
        }

        function updateDiscrepancyDisplay() {
            const expected = parseInt(document.getElementById('expectedQty').value || 0);
            const entered = getSubtotalPcs();
            const hasDiscrepancy = entered !== expected && expected > 0;
            
            const section = document.getElementById('discrepancyReasonSection');
            const reasonSelect = document.getElementById('discrepancyReason');
            
            if (hasDiscrepancy) {
                section.classList.remove('hidden');
                reasonSelect.disabled = false;
            } else {
                section.classList.add('hidden');
                reasonSelect.disabled = true;
                reasonSelect.value = '';
            }
        }

        function backToPage1() {
            document.getElementById('page2').classList.add('hidden');
            document.getElementById('labelSection').classList.add('hidden');
            document.getElementById('page1').classList.remove('hidden');
        }

        function renderLocationGrid() {
            const grid = document.getElementById('locGrid');
            grid.innerHTML = state.locations.length ? '' : '<small style="color: var(--muted);">No locations added yet</small>';
            
            state.locations.forEach((loc, idx) => {
                const locDiv = document.createElement('div');
                locDiv.style.display = 'flex';
                locDiv.style.gap = '8px';
                locDiv.style.alignItems = 'center';
                locDiv.innerHTML = `
                    <input type="text" value="${loc}" readonly style="flex: 1;">
                    <input type="number" value="0" min="0" placeholder="Qty" class="locQty" style="width: 80px;" onchange="updatePutawayStatus()">
                    <button onclick="removeLocation(${idx})" class="danger" style="padding: 8px;">‚úï</button>
                `;
                grid.appendChild(locDiv);
            });
            
            updatePutawayStatus();
        }

        function addLocation() {
            const locInput = document.getElementById('locInput');
            const loc = locInput.value.trim();
            if (!loc) {
                showStatus('‚ùå Enter location first', 'error');
                return;
            }
            state.locations.push(loc);
            locInput.value = '';
            renderLocationGrid();
            saveState();
        }

        function removeLocation(idx) {
            state.locations.splice(idx, 1);
            renderLocationGrid();
            saveState();
        }

        function moveAllLoc() {
            if (state.locations.length === 0) {
                showStatus('‚ùå Add at least one location first', 'error');
                return;
            }
            const totalQty = getSubtotalPcs();
            const inputs = document.querySelectorAll('.locQty');
            if (inputs.length > 0) {
                inputs[0].value = totalQty;
                for (let i = 1; i < inputs.length; i++) {
                    inputs[i].value = 0;
                }
            }
            updatePutawayStatus();
        }

        function updatePutawayStatus() {
            const inputs = document.querySelectorAll('.locQty');
            let totalLoc = 0;
            inputs.forEach(inp => {
                totalLoc += parseInt(inp.value || 0);
            });
            const totalExp = getSubtotalPcs();
            document.getElementById('putawayTotal').textContent = totalLoc;
            document.getElementById('okToSubmit').textContent = totalLoc === totalExp ? '‚úÖ Yes' : '‚ùå No';
            document.getElementById('btnSubmit').disabled = !state.isLoggedIn || totalLoc !== totalExp;
        }

        function generateLabel() {
            const expected = parseInt(document.getElementById('expectedQty').value || 0);
            const entered = getSubtotalPcs();
            const isAccurate = entered === expected && expected > 0;
            
            const upc = document.getElementById('upcInput').value || '000000000000';
            const brand = document.getElementById('brand').value || 'N/A';
            const gender = document.getElementById('gender').value || '‚Äî';
            const coo = document.getElementById('coo').value || '‚Äî';
            const desc = document.getElementById('itemDesc').value || 'Item Description';
            const location = state.locations[0] || 'TBD';
            
            const borderClass = isAccurate ? 'label-border-accurate' : 'label-border-recheck';
            const headerClass = isAccurate ? '' : 'label-header-recheck';
            const statusText = isAccurate ? '‚úì VERIFIED' : '‚ö†Ô∏è RECHECK';
            const statusClass = isAccurate ? 'label-status-accurate' : 'label-status-recheck';
            
            const label = `
                <div class="label-container ${borderClass}">
                    <div class="label-header ${headerClass}">
                        <div>üì¶ INVENTORIED NOV.2025</div>
                        <div class="label-status ${statusClass}">${statusText}</div>
                    </div>
                    
                    <div class="label-body">
                        <div class="label-description">${desc}</div>
                        
                        <div class="label-info">
                            <div class="label-info-row"><span class="label-info-label">Brand:</span> <span class="label-info-value">${brand}</span></div>
                            <div class="label-info-row"><span class="label-info-label">Gender:</span> <span class="label-info-value">${gender}</span></div>
                            <div class="label-info-row"><span class="label-info-label">COO:</span> <span class="label-info-value">${coo}</span></div>
                            <div class="label-info-row"><span class="label-info-label">Location:</span> <span class="label-info-value"><strong>${location}</strong></span></div>
                            <div class="label-info-row"><span class="label-info-label">Qty:</span> <span class="label-info-value"><strong>${entered} pcs</strong></span></div>
                        </div>
                        
                        <div class="label-codes">
                            <div class="label-qr"><svg id="qrcode" width="70" height="70"></svg></div>
                            <div class="label-barcode-section">
                                <div class="label-barcode-image"><svg id="barcode"></svg></div>
                                <div class="label-barcode-text">${upc}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('labelPreview').innerHTML = label;
            
            setTimeout(() => {
                try {
                    JsBarcode("#barcode", upc, {
                        format: "code128",
                        width: 2,
                        height: 50,
                        margin: 0
                    });
                } catch (e) {
                    console.log('Barcode generation skipped');
                }
            }, 100);
            
            setTimeout(() => {
                try {
                    const qrElement = document.getElementById('qrcode');
                    if (qrElement) qrElement.innerHTML = '';
                    QRCode.toCanvas(document.getElementById('qrcode'), `UPC:${upc}|LOC:${location}`, { width: 70 }, (error) => {
                        if (error) console.log('QR skipped');
                    });
                } catch (e) {
                    console.log('QR generation skipped');
                }
            }, 150);
            
            document.getElementById('labelSection').classList.remove('hidden');
            document.getElementById('btnSaveLabel').disabled = false;
        }

        function saveLabelToSheet() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            if (!url) {
                showStatus('‚ùå Apps Script URL not set', 'error');
                return;
            }
            
            const payload = {
                action: 'addLabel',
                data: {
                    timestamp: new Date().toISOString(),
                    location: state.locations[0] || 'N/A',
                    upc: document.getElementById('upcInput').value,
                    qty: getSubtotalPcs(),
                    breakdown: getBreakdownSummary()
                }
            };
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                showStatus(`‚úì Label logged to sheet`, 'ok');
            })
            .catch(e => {
                showStatus(`‚ö†Ô∏è Data sent: ${e.message}`, 'warn');
            });
        }

        function downloadJSON() {
            const data = {
                timestamp: new Date().toISOString(),
                user: state.user,
                item: {
                    upc: document.getElementById('upcInput').value,
                    brand: document.getElementById('brand').value,
                    gender: document.getElementById('gender').value,
                    coo: document.getElementById('coo').value,
                    description: document.getElementById('itemDesc').value,
                    edgeNo: document.getElementById('edgeNo').value,
                    isClean: document.getElementById('isClean').value
                },
                dimensions: {
                    weight: document.getElementById('itemWeight').value,
                    length: document.getElementById('itemLength').value,
                    width: document.getElementById('itemWidth').value,
                    height: document.getElementById('itemHeight').value
                },
                boxes: getBoxData(),
                totals: {
                    pieces: getSubtotalPcs(),
                    cubicFeet: document.getElementById('totalCuFt').textContent
                },
                locations: state.locations,
                notes: document.getElementById('putawayNotes').value
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stock-${data.item.upc}-${new Date().getTime()}.json`;
            a.click();
            showStatus('‚úì Downloaded JSON', 'ok');
        }

        function getBoxData() {
            const boxes = [];
            for (let i = 1; i <= 4; i++) {
                const qty = parseInt(document.getElementById(`box${i}Qty`).value || 0);
                if (qty > 0) {
                    boxes.push({
                        style: i,
                        quantity: qty,
                        pcsPerBox: document.getElementById(`box${i}Pcs`).value,
                        weight: document.getElementById(`box${i}Weight`).value,
                        length: document.getElementById(`box${i}Length`).value,
                        width: document.getElementById(`box${i}Width`).value,
                        height: document.getElementById(`box${i}Height`).value
                    });
                }
            }
            return boxes;
        }

        function resetForm() {
            document.getElementById('upcInput').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('gender').value = '‚Äî Select ‚Äî';
            document.getElementById('coo').value = '‚Äî Select ‚Äî';
            document.getElementById('itemDesc').value = '';
            document.getElementById('edgeNo').value = '';
            document.getElementById('isClean').value = '‚Äî Select ‚Äî';
            document.getElementById('expectedQty').value = '0';
            document.getElementById('itemWeight').value = '0';
            document.getElementById('itemLength').value = '0';
            document.getElementById('itemWidth').value = '0';
            document.getElementById('itemHeight').value = '0';
            
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`box${i}Qty`).value = '0';
                document.getElementById(`box${i}Pcs`).value = '0';
                document.getElementById(`box${i}Weight`).value = '0';
                document.getElementById(`box${i}Length`).value = '0';
                document.getElementById(`box${i}Width`).value = '0';
                document.getElementById(`box${i}Height`).value = '0';
            }
            
            state.locations = [];
            document.getElementById('locInput').value = '';
            document.getElementById('putawayNotes').value = '';
            document.getElementById('discrepancyReason').value = '';
            
            document.getElementById('labelSection').classList.add('hidden');
            document.getElementById('page2').classList.add('hidden');
            document.getElementById('page1').classList.remove('hidden');
            
            calcTotals();
            saveState();
        }

        function saveState() {
            localStorage.setItem('stockTakerState', JSON.stringify(state));
        }

        function showStatus(msg, type = 'info') {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = msg;
            statusMsg.style.color = type === 'ok' ? 'var(--ok)' : type === 'error' ? 'var(--bad)' : type === 'warn' ? 'var(--warn)' : 'var(--link)';
            if (type === 'ok' || type === 'error') {
                setTimeout(() => {
                    statusMsg.textContent = 'Ready for next operation...';
                    statusMsg.style.color = 'var(--muted)';
                }, 3000);
            }
        }

        window.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', saveState);
    
// ==== v3 Additions: Locations, Damage, Progress ====
const __LOC_LIST = [
  'A-01-01-01','A-01-01-02','A-01-02-01','A-01-02-02','A-01-03-01','A-01-03-02',
  'A-01-04-01','A-01-04-02','A-01-05-01','A-01-05-02','A-FLOOR',
  'B-01-01-01','B-01-01-02','B-01-02-01','B-01-02-02','B-01-03-01','B-01-03-02',
  'B-01-04-01','B-01-04-02','B-01-05-01','B-01-05-02','B-01-06-01','B-01-06-02','B-FLOOR',
  'C-01-01-01','C-01-01-02','C-01-02-01','C-01-02-02','C-01-03-01','C-01-03-02','C-01-04-01',
  'C-01-04-02','C-01-05-01','C-01-05-02','C-01-06-01','C-01-06-02','C-01-07-01','C-01-07-02',
  'C-01-08-01','C-01-08-02','C-FLOOR',
  'D-01-01-01','D-01-01-02','D-01-02-01','D-01-02-02','D-01-03-01','D-01-03-02','D-01-04-01',
  'D-01-04-02','D-FLOOR','E-01-01-01','E-01-01-02','E-01-01-03','E-01-01-04','E-01-02-01',
  'E-01-02-02','E-FLOOR','F-01-01-01','F-01-01-02','F-FLOOR'
];
function populateLocationDropdown(){ try{ const s = document.getElementById('locSelect'); if(!s) return; s.innerHTML = '<option value="">Select location...</option>'; __LOC_LIST.forEach(l=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; s.appendChild(o); }); }catch(e){} }
function onSelectLocation(){ try{ const s=document.getElementById('locSelect'); const i=document.getElementById('locInput'); if(s&&i&&s.value) i.value=s.value; }catch(e){} }

function validateDamage(){ const counted=parseInt((document.getElementById('subtotalPcs')?.textContent||'0'),10); const g=parseInt((document.getElementById('qtyGood')?.value||'0'),10)||0; const u=parseInt((document.getElementById('qtyDamagedUnbox')?.value||'0'),10)||0; const d=parseInt((document.getElementById('qtyDamagedDispose')?.value||'0'),10)||0; const t=g+u+d; const tot=document.getElementById('damageTotal'); const st=document.getElementById('damageStatus'); if(tot) tot.textContent=String(t); if(st){ if(t===counted){ st.textContent='‚úì'; st.style.color='#22c55e'; } else { st.textContent='‚ùå Need '+counted; st.style.color='#ef4444'; } } }
function showDamageIfNeeded(){ const exp=parseInt((document.getElementById('expectedQty')?.value||'0'),10); const cnt=parseInt((document.getElementById('subtotalPcs')?.textContent||'0'),10); const sec=document.getElementById('damageSection'); if(!sec) return; if(exp>0 && cnt!==exp){ sec.style.display='block'; ['qtyGood','qtyDamagedUnbox','qtyDamagedDispose'].forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=false; }); const g=document.getElementById('qtyGood'); if(g) g.value=String(cnt); const cd=document.getElementById('countedQtyDisplay'); if(cd) cd.textContent=String(cnt); const tot=document.getElementById('damageTotal'); if(tot) tot.textContent=String(cnt); const st=document.getElementById('damageStatus'); if(st){ st.textContent='‚úì'; st.style.color='#22c55e'; } } else { sec.style.display='none'; } }

function updateProgress(){ const e=document.getElementById('itemsEntered'); const t=document.getElementById('totalItems'); const p=document.getElementById('percentComplete'); const f=document.getElementById('progressFill'); const entered=parseInt((e?.textContent||'0'),10); const total=parseInt((t?.textContent||'200'),10); const pct=Math.max(0,Math.min(100,Math.round((entered/Math.max(1,total))*100))); if(p) p.textContent=pct+'%'; if(f) f.style.width=pct+'%'; }
function incrementProgress(){ const e=document.getElementById('itemsEntered'); if(e){ e.textContent=String(parseInt((e.textContent||'0'),10)+1); } updateProgress(); }

// Hook into existing functions if present
(function(){
  // init hook
  try {
    const __init = window.init;
    window.init = function(){ if(typeof __init==='function') __init(); populateLocationDropdown(); updateProgress(); };
  } catch(e){}
  // updateUiLock hook
  try {
    const __lock = window.updateUiLock;
    window.updateUiLock = function(){ if(typeof __lock==='function') __lock(); ['locSelect','qtyGood','qtyDamagedUnbox','qtyDamagedDispose'].forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled = !((window.state&&state.isLoggedIn) || false); }); };
  } catch(e){}
  // nextPage hook
  try {
    const __next = window.nextPage || window.goPage2 || window.toPage2;
    if(__next){
      const wrapped = function(){ const r = __next.apply(this, arguments); try{ showDamageIfNeeded(); }catch(e){} return r; };
      if(window.nextPage) window.nextPage = wrapped; else if(window.goPage2) window.goPage2 = wrapped; else window.toPage2 = wrapped;
    }
  } catch(e){}
  // submitToSheet hook
  try {
    const __submit = window.submitToSheet;
    if(typeof __submit==='function'){
      window.submitToSheet = async function(){ incrementProgress(); try{ const g=parseInt((document.getElementById('qtyGood')?.value||'0'),10)||0; const u=parseInt((document.getElementById('qtyDamagedUnbox')?.value||'0'),10)||0; const d=parseInt((document.getElementById('qtyDamagedDispose')?.value||'0'),10)||0; window.__damageCache={good:g,unbox:u,dispose:d,total:g+u+d}; }catch(e){} return await __submit.apply(this, arguments); };
    }
  } catch(e){}
})();
// ==== end v3 additions ====
</script>

<!-- LABEL PRINT MODAL -->
<div class="modal" id="labelModal">
    <div class="modal-content" style="max-width: 95vw; max-height: 95vh;">
        <span class="modal-close" onclick="closeLabelModal()">‚úï</span>
        <h2>üè∑Ô∏è Select Labels to Print</h2>

        <div style="background: var(--panel); padding: 16px; border-radius: 6px; margin-bottom: 16px;">
            <strong>Item:</strong> <span id="labelItemDesc">‚Äî</span><br>
            <strong>UPC:</strong> <span id="labelUpc">‚Äî</span> | 
            <strong>Qty:</strong> <span id="labelQty">‚Äî</span> pcs | 
            <strong>Cartons:</strong> <span id="labelCartons">‚Äî</span>
        </div>

        <div style="margin-bottom: 16px;">
            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <input type="checkbox" id="printItemMaster" checked>
                <strong>Item Master Label</strong> (1 label - 4√ó6 Portrait)
            </label>

            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <input type="checkbox" id="printCartons" checked>
                <strong>Carton Labels</strong> (<span id="cartonCount">0</span> labels - 6√ó4 Landscape)
            </label>

            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <input type="checkbox" id="printPallets">
                <strong>Pallet Labels</strong> (6√ó4 Landscape)
            </label>

            <div id="palletOptions" style="margin-left: 32px; display: none;">
                <label>Number of pallets: <input type="number" id="palletCount" value="1" min="1" style="width: 60px;"></label>
            </div>
        </div>

        <div style="background: rgba(56,189,248,0.1); padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 12px;">
            <strong>üí° TIP:</strong> After generating, you can:<br>
            ‚Ä¢ Print directly to thermal printer<br>
            ‚Ä¢ Save as PDF for backup/desktop printing<br>
            ‚Ä¢ Download JSON backup for reprinting
        </div>

        <div class="flex-buttons">
            <button onclick="closeLabelModal()" class="danger">Cancel</button>
            <button onclick="generateAndPrintLabels()" class="success">üñ®Ô∏è Generate & Print</button>
        </div>
    </div>
</div>

<!-- LABEL PREVIEW MODAL -->
<div class="modal" id="labelPreviewModal">
    <div class="modal-content" style="max-width: 95vw; max-height: 95vh; overflow-y: auto;">
        <span class="modal-close" onclick="closeLabelPreview()">‚úï</span>
        <h2>Label Preview</h2>
        <div id="labelPreviewContainer" style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
        </div>
        <div class="flex-buttons" style="margin-top: 20px; gap: 12px;">
            <button onclick="closeLabelPreview()" class="danger">Close</button>
            <button onclick="printAllLabels()" class="success">üñ®Ô∏è Print All</button>
            <button onclick="saveToPDF()" class="warn">üíæ Save as PDF</button>
            <button onclick="downloadLabelData()" style="background: #8b5cf6; color: white;">üìÑ Download JSON</button>
        </div>
    </div>
</div>

<style>
/* Label Styles */
.label-item-master {
    width: 4in; height: 6in; background: white; color: black; border: 2px solid black;
    padding: 0; margin: 10px; font-family: Arial, sans-serif; page-break-after: always;
    display: flex; flex-direction: column;
}
.label-item-master .label-header {
    background: black; color: white; padding: 8px; text-align: center;
    font-weight: bold; font-size: 14px; border: 3px solid black;
}
.label-item-master .label-description {
    padding: 12px; text-align: center; font-size: 26px; font-weight: bold;
    line-height: 1.2; border-bottom: 2px solid black;
}
.label-item-master .label-brand {
    padding: 8px 12px; text-align: center; font-size: 22px;
    font-weight: bold; border-bottom: 1px solid #ccc;
}
.label-item-master .label-qr-section {
    display: flex; justify-content: center; padding: 12px; border-bottom: 1px solid #ccc;
}
.label-item-master .label-details {
    padding: 12px; font-size: 15px; line-height: 1.8; flex: 1;
}
.label-item-master .label-details .upc-large { font-size: 20px; font-weight: bold; }
.label-item-master .label-timestamp {
    padding: 8px 12px; font-size: 12px; border-top: 1px solid #ccc;
    text-align: center; background: #f5f5f5;
}
.label-item-master .label-barcode {
    padding: 8px; text-align: center; border-top: 2px solid black;
}

.label-carton, .label-pallet {
    width: 6in; height: 4in; background: white; color: black; border: 3px solid black;
    padding: 0; margin: 10px; font-family: Arial, sans-serif; page-break-after: always;
    display: flex; flex-direction: column;
}
.label-carton .label-header, .label-pallet .label-header {
    background: black; color: white; padding: 12px; font-weight: bold;
    font-size: 24px; line-height: 1.3; border: 4px solid black;
}
.label-carton .label-body, .label-pallet .label-body { display: flex; flex: 1; padding: 12px; }
.label-carton .label-qr-container, .label-pallet .label-qr-container {
    width: 25%; display: flex; align-items: center; justify-content: center; border-right: 2px solid #ccc;
}
.label-carton .label-info, .label-pallet .label-info {
    width: 75%; padding: 0 12px; font-size: 16px; line-height: 2.0;
}
.label-carton .label-info .upc-large, .label-pallet .label-info .upc-large {
    font-size: 20px; font-weight: bold;
}
.label-carton .label-barcode, .label-pallet .label-barcode {
    padding: 8px; text-align: center; border-top: 3px solid black;
}

@media print {
    @page { size: 4in 6in portrait; margin: 0; }
    @page landscape { size: 6in 4in landscape; margin: 0; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    html, body { margin: 0 !important; padding: 0 !important; background: white !important; }
    body * { visibility: hidden; }
    .label-item-master, .label-carton, .label-pallet,
    .label-item-master *, .label-carton *, .label-pallet * { visibility: visible !important; }
    .label-item-master, .label-carton, .label-pallet {
        position: absolute; left: 0; top: 0; margin: 0 !important; background: white;
        page-break-after: always; page-break-inside: avoid;
    }
    .label-carton, .label-pallet { page: landscape; }
    .label-item-master .label-header, .label-carton .label-header, .label-pallet .label-header {
        background: black !important; color: white !important; border: 4px solid black !important;
    }
    .label-item-master .label-timestamp { background: white !important; border: 2px solid #666 !important; }
}

/* FORCE ONE LABEL PER PAGE */
@media print {
    @page {
        size: 4in 6in !important;
        margin: 0 !important;
    }

    html, body {
        width: 4in;
        height: 6in;
        margin: 0;
        padding: 0;
    }

    body * {
        visibility: hidden;
    }

    #printArea, #printArea * {
        visibility: visible !important;
    }

    #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 4in;
        height: 6in;
    }

    #printArea > div {
        page-break-after: always !important;
        page-break-inside: avoid !important;
        width: 3.8in;
        height: 5.8in;
        margin: 0.1in;
    }
}

</style>

<script>
let labelData = {};

function showLabelModal() {
    labelData = {
        upc: document.getElementById('upcInput').value || '000000000000',
        brand: document.getElementById('brand').value || 'N/A',
        description: document.getElementById('itemDesc').value || 'Item Description',
        location: state.locations[0] || 'TBD',
        qty: parseInt(document.getElementById('subtotalPcs').textContent || 0),
        user: state.user,
        timestamp: new Date()
    };

    let totalCartons = 0;
    for (let i = 1; i <= 4; i++) {
        totalCartons += parseInt(document.getElementById(`box${i}Qty`).value || 0);
    }
    labelData.totalCartons = totalCartons;

    document.getElementById('labelItemDesc').textContent = labelData.description;
    document.getElementById('labelUpc').textContent = labelData.upc;
    document.getElementById('labelQty').textContent = labelData.qty;
    document.getElementById('labelCartons').textContent = totalCartons;
    document.getElementById('cartonCount').textContent = totalCartons;
    document.getElementById('labelModal').classList.add('active');
}

function closeLabelModal() { document.getElementById('labelModal').classList.remove('active'); }
function closeLabelPreview() { document.getElementById('labelPreviewModal').classList.remove('active'); }

document.addEventListener('change', (e) => {
    if (e.target.id === 'printPallets') {
        document.getElementById('palletOptions').style.display = e.target.checked ? 'block' : 'none';
    }
});

function generateCartonId(index) {
    const ts = labelData.timestamp;
    const dateStr = ts.getFullYear().toString().slice(2) + String(ts.getMonth()+1).padStart(2,'0') + 
                    String(ts.getDate()).padStart(2,'0') + String(ts.getHours()).padStart(2,'0') +
                    String(ts.getMinutes()).padStart(2,'0') + String(ts.getSeconds()).padStart(2,'0');
    return `C-${dateStr}-${String(index).padStart(3,'0')}`;
}

function generatePalletId(index) {
    const ts = labelData.timestamp;
    const dateStr = ts.getFullYear().toString().slice(2) + String(ts.getMonth()+1).padStart(2,'0') + 
                    String(ts.getDate()).padStart(2,'0');
    return `P-${dateStr}-${String(index).padStart(3,'0')}`;
}

function generateAndPrintLabels() {
    const container = document.getElementById('labelPreviewContainer');
    container.innerHTML = '';

    if (document.getElementById('printItemMaster').checked) {
        container.appendChild(createItemMasterLabel());
    }
    if (document.getElementById('printCartons').checked && labelData.totalCartons > 0) {
        for (let i = 1; i <= labelData.totalCartons; i++) {
            container.appendChild(createCartonLabel(i));
        }
    }
    if (document.getElementById('printPallets').checked) {
        const palletCount = parseInt(document.getElementById('palletCount').value || 1);
        const cartonsPerPallet = Math.ceil(labelData.totalCartons / palletCount);
        for (let i = 1; i <= palletCount; i++) {
            container.appendChild(createPalletLabel(i, palletCount, cartonsPerPallet));
        }
    }

    closeLabelModal();
    document.getElementById('labelPreviewModal').classList.add('active');
}

function createItemMasterLabel() {
    const div = document.createElement('div');
    div.className = 'label-item-master';
    div.innerHTML = `
        <div class="label-header">INVENTORIED NOV.2025<br>‚úì VERIFIED</div>
        <div class="label-description">${labelData.description}</div>
        <div class="label-brand">${labelData.brand}</div>
        <div class="label-qr-section"><canvas id="qr-item" width="120" height="120"></canvas></div>
        <div class="label-details">
            <div class="upc-large">UPC: ${labelData.upc}</div>
            <strong>Location:</strong> ${labelData.location}<br>
            <strong>Total:</strong> ${labelData.qty} pcs (${labelData.totalCartons} cartons)
        </div>
        <div class="label-timestamp">${labelData.timestamp.toLocaleDateString()} ${labelData.timestamp.toLocaleTimeString()}</div>
        <div class="label-barcode">
            <svg id="barcode-item"></svg>
            <div style="font-size: 18px; font-weight: bold; margin-top: 4px;">${labelData.upc}</div>
        </div>
    `;
    setTimeout(() => {
        QRCode.toCanvas(div.querySelector('#qr-item'), JSON.stringify({type:'ITEM',upc:labelData.upc,loc:labelData.location}), {width:120});
        JsBarcode(div.querySelector('#barcode-item'), labelData.upc, {format:'code128',width:2,height:50,displayValue:false});
    }, 100);
    return div;
}

function createCartonLabel(boxNum) {
    const cartonId = generateCartonId(boxNum);
    const pcsPerCarton = Math.floor(labelData.qty / labelData.totalCartons);
    const div = document.createElement('div');
    div.className = 'label-carton';
    div.innerHTML = `
        <div class="label-header">${labelData.brand} - ${labelData.description}</div>
        <div class="label-body">
            <div class="label-qr-container"><canvas id="qr-carton-${boxNum}" width="110" height="110"></canvas></div>
            <div class="label-info">
                <strong>CARTON:</strong> ${cartonId}<br>
                <strong>BOX ${boxNum} of ${labelData.totalCartons}</strong> | ${pcsPerCarton} pcs<br>
                <div class="upc-large">UPC: ${labelData.upc}</div>
                <strong>Location:</strong> ${labelData.location}<br>
                <strong>Time:</strong> ${labelData.timestamp.toLocaleDateString()} ${labelData.timestamp.toLocaleTimeString()}<br>
                <strong>User:</strong> ${labelData.user}
            </div>
        </div>
        <div class="label-barcode">
            <svg id="barcode-carton-${boxNum}"></svg>
            <div style="font-size: 18px; font-weight: bold; margin-top: 4px;">${labelData.upc}</div>
        </div>
    `;
    setTimeout(() => {
        QRCode.toCanvas(div.querySelector(`#qr-carton-${boxNum}`), JSON.stringify({type:'CARTON',id:cartonId,upc:labelData.upc,box:boxNum,pcs:pcsPerCarton}), {width:110});
        JsBarcode(div.querySelector(`#barcode-carton-${boxNum}`), labelData.upc, {format:'code128',width:2,height:50,displayValue:false});
    }, 100);
    return div;
}

function createPalletLabel(palletNum, totalPallets, cartonsPerPallet) {
    const palletId = generatePalletId(palletNum);
    const pcsPerPallet = Math.floor(labelData.qty / totalPallets);
    const div = document.createElement('div');
    div.className = 'label-pallet';
    div.innerHTML = `
        <div class="label-header">üî∑ PALLET ${palletNum} of ${totalPallets}<br>${labelData.brand} - ${labelData.description}</div>
        <div class="label-body">
            <div class="label-qr-container"><canvas id="qr-pallet-${palletNum}" width="110" height="110"></canvas></div>
            <div class="label-info">
                <strong>PALLET:</strong> ${palletId}<br>
                <strong>‚îú‚îÄ</strong> ${cartonsPerPallet} cartons<br>
                <strong>‚îú‚îÄ</strong> ${pcsPerPallet} pcs total<br>
                <strong>‚îî‚îÄ</strong> ${Math.floor(pcsPerPallet/cartonsPerPallet)} pcs/carton<br>
                <div class="upc-large">UPC: ${labelData.upc}</div>
                <strong>Location:</strong> ${labelData.location}<br>
                <strong>Time:</strong> ${labelData.timestamp.toLocaleDateString()} ${labelData.timestamp.toLocaleTimeString()}<br>
                <strong>User:</strong> ${labelData.user}
            </div>
        </div>
        <div class="label-barcode">
            <svg id="barcode-pallet-${palletNum}"></svg>
            <div style="font-size: 18px; font-weight: bold; margin-top: 4px;">${labelData.upc}</div>
        </div>
    `;
    setTimeout(() => {
        QRCode.toCanvas(div.querySelector(`#qr-pallet-${palletNum}`), JSON.stringify({type:'PALLET',id:palletId,upc:labelData.upc,cartons:cartonsPerPallet,pcs:pcsPerPallet}), {width:110});
        JsBarcode(div.querySelector(`#barcode-pallet-${palletNum}`), labelData.upc, {format:'code128',width:2,height:50,displayValue:false});
    }, 100);
    return div;
}

// FIXED PRINT FUNCTION
function printAllLabels() {
    document.getElementById('labelPreviewModal').classList.remove('active');
    setTimeout(() => { window.print(); setTimeout(() => document.getElementById('labelPreviewModal').classList.add('active'), 500); }, 200);
}

// SAVE AS PDF (browser native)
function saveToPDF() {
    alert('üìÑ To save as PDF:\n\n1. Click "Print All" button\n2. Select "Save as PDF" as printer\n3. Choose save location\n4. Click Save\n\nTIP: Name file: UPC-' + labelData.upc + '-' + new Date().toISOString().slice(0,10));
    printAllLabels();
}

// DOWNLOAD JSON BACKUP
function downloadLabelData() {
    const data = { timestamp: labelData.timestamp.toISOString(), upc: labelData.upc, brand: labelData.brand,
        description: labelData.description, location: labelData.location, qty: labelData.qty,
        totalCartons: labelData.totalCartons, user: labelData.user, cartonIds: [] };
    for (let i = 1; i <= labelData.totalCartons; i++) { data.cartonIds.push(generateCartonId(i)); }
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `labels-${labelData.upc}-${Date.now()}.json`; a.click();
}


// Send carton IDs to carton_registry sheet
async function registerCartons(cartonData) {
    try {
        const response = await fetch(state.scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'registerCartons',
                data: cartonData
            })
        });
        console.log('‚úì Cartons registered:', cartonData.cartons.length);
    } catch (error) {
        console.error('Error registering cartons:', error);
    }
}

function printLabel() { showLabelModal(); }
</script>
</body>
</html>
