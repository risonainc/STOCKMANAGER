<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STOCKMANAGERAPP · Mobile Inventory v1.0.0-PRELOCK (Front Cam + Lookup + Summary+CSV + Labels QR Composite)</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--muted:#9ca3af;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b;--link:#38bdf8}
    body{margin:0;background:var(--bg);color:#eef2ff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:12px 16px;background:linear-gradient(90deg,#0ea5e9,#6366f1)}
    header h1{margin:0;font-size:18px} header small{opacity:.9}
    main{max-width:1060px;margin:0 auto;padding:16px}
    .pill{background:#0b1329;border:1px solid #1f2440;padding:8px 10px;border-radius:999px;font-size:13px;color:#cbd5e1;display:inline-flex;gap:8px;align-items:center}
    .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin:10px 0 16px}
    .page{background:var(--panel);border:1px solid #243047;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.35);padding:14px;margin-bottom:18px}
    h2{font-size:18px;margin:8px 0 12px} h3{font-size:15px;margin:16px 0 6px;color:#cbd5e1}
    label{font-size:12px;color:#cbd5e1;margin-bottom:4px;display:block}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px 12px;border-radius:8px;border:1px solid #324156;background:var(--card);color:#e5e7eb}
    input[readonly]{opacity:.9;background:#1b2232} input:disabled,select:disabled,textarea:disabled{opacity:.6}
    .grid{display:grid;gap:10px} .g2{grid-template-columns:repeat(2,1fr)} .g3{grid-template-columns:repeat(3,1fr)} .g4{grid-template-columns:repeat(4,1fr)}
    .row{display:flex;gap:10px;align-items:center} .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:#0b1329;border:1px solid #2b3953;color:#e5e7eb;padding:10px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:#0ea5e9;border-color:#0891b2} .btn.success{background:#16a34a;border-color:#15803d}
    .btn.warn{background:#f59e0b;border-color:#b45309} .btn.ghost{background:transparent;border-color:#2b3953}
    .btn.danger{background:#ef4444;border-color:#b91c1c}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .scanner{position:relative;background:#0b1329;border:1px dashed #334155;border-radius:10px;min-height:240px;display:none;align-items:center;justify-content:center;overflow:hidden}
    .scanner video{width:100%;height:100%;object-fit:cover}
    .scan-overlay{position:absolute;inset:0;border:3px solid rgba(56,189,248,.8);border-radius:14px;box-shadow:0 0 0 200vmax rgba(0,0,0,.35) inset;pointer-events:none}
    .overlay-box{position:absolute;left:50%;top:50%;translate:-50% -50%;width:min(80%,520px);height:190px;border:3px solid rgba(34,197,94,.9);border-radius:10px}
    .hidden{display:none!important} .stat{padding:8px 10px;border-radius:8px;border:1px solid #2b3953;background:#0c142b;display:inline-flex;gap:8px;align-items:center}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn-t{color:var(--warn)} .muted{color:var(--muted);font-size:12px}
    .box-card{border:1px solid #2b3953;border-radius:10px;padding:10px;background:#0c142b}
    .kbd{font-family:ui-monospace,Menlo,monospace;background:#0b1329;border:1px solid #2b3953;border-bottom-width:3px;border-radius:6px;padding:2px 6px}

    /* Label print sheet */
    #labelSheet{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:100}
    #labelCard{background:white;color:#000;width:6in;height:4in;display:flex;flex-direction:column;padding:.2in;box-sizing:border-box}
    #labelHeader{font-weight:800;font-size:20pt;border-bottom:2px solid #000;padding-bottom:4pt;margin-bottom:4pt;display:flex;justify-content:space-between}
    #labelBody{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:.1in}
    #labelLeft{display:flex;flex-direction:column;gap:6pt}
    #labelRight{display:flex;flex-direction:column;align-items:flex-end;justify-content:space-between}
    #codes{display:flex;gap:.1in;align-items:center}
    #codes canvas{background:#fff}
    #itemDesc{font-weight:700;font-size:14pt;text-align:center;border:2px solid #000;padding:4pt}
    @media print{ body>*:not(#labelSheet){display:none!important} #labelSheet{display:block!important} #labelCard{box-shadow:none} @page{size:6in 4in landscape;margin:.25in} }
  </style>
</head>
<body>
  <header>
    <h1>STOCKMANAGERAPP · Mobile Inventory <small>v1.0.0‑PRELOCK</small></h1>
  </header>
  <main>
    <div class="bar">
      <div class="pill">Page <span id="pageIndicator">1</span> of 2</div>
      <div class="pill">Logged in as:
        <select id="loginName" style="background:transparent;border:0;border-bottom:1px dashed #e5e7eb;color:#fff">
          <option value="">— Select User —</option>
          <option>Rikki</option>
          <option>Alberto</option>
          <option>Isabella</option>
          <option>Kelis</option>
          <option>Leydi</option>
          <option>Veronica</option>
          <option>Mabel</option>
          <option>Jocelyn</option>
          <option>WarehouseUser1</option>
          <option>WarehouseUser2</option>
        </select>
        <span id="loginLock" class="muted">(locked until login)</span>
      </div>
      <div class="pill">Sheet: <span id="sheetIdDisplay">—</span></div>
      <div class="pill">Camera: <span id="camLabel">Front</span></div>
    </div>

    <section id="page1" class="page">
      <h2>Validate Item Details &amp; Packing</h2>
      <div class="grid g3">
        <div>
          <label>UPC <span class="muted">*</span></label>
          <input id="upc" inputmode="numeric" autocomplete="off" placeholder="Scan or enter UPC" disabled />
        </div>
        <div class="actions" style="align-items:end">
          <button class="btn primary" id="btnScanUPC" disabled>Scan UPC/Barcode</button>
          <button class="btn ghost" id="btnGenUPC" disabled>Generate UPC</button>
          <button class="btn" id="btnToggleCam">Front</button>
        </div>
        <div>
          <label>Sheet ID</label>
          <input id="sheetId" placeholder="Google Sheet ID" />
        </div>
      </div>

      <div class="grid g3" style="margin-top:10px">
        <div>
          <label>Brand</label>
          <input id="brand" placeholder="Auto‑filled if known" disabled />
        </div>
        <div>
          <label>Gender (M / LADIES / UNISEX)</label>
          <input id="gender" placeholder="Type 'LADIES' not 'WOMEN'" disabled />
        </div>
        <div>
          <label>Master Item Description</label>
          <input id="desc" placeholder="Item name / size" disabled />
        </div>
      </div>

      <div class="grid g4" style="margin-top:10px">
        <div>
          <label>COO</label>
          <input id="coo" placeholder="Country of Origin" disabled />
        </div>
        <div>
          <label>C/D</label>
          <input id="cd" placeholder="CLEAN / DECODED" disabled />
        </div>
        <div>
          <label>Expected Quantity</label>
          <input id="expectedQty" type="number" min="0" step="1" disabled />
        </div>
        <div>
          <label>Entered Quantity (Subtotal)</label>
          <input id="enteredQty" type="number" readonly />
        </div>
      </div>

      <h3>Item Weight &amp; Dimensions</h3>
      <div class="grid g4">
        <div><label>Item Weight (lb)</label><input id="itemWeight" type="number" step="0.01" min="0" placeholder="lbs"/></div>
        <div><label>Item L (in)</label><input id="itemL" type="number" step="0.01" min="0" placeholder="inches"/></div>
        <div><label>Item W (in)</label><input id="itemW" type="number" step="0.01" min="0" placeholder="inches"/></div>
        <div><label>Item H (in)</label><input id="itemH" type="number" step="0.01" min="0" placeholder="inches"/></div>
      </div>

      <h3>Box Breakdown (Styles 1–4)</h3>
      <div id="boxStyles" class="grid g1"></div>

      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="stat">Subtotal Pcs: <strong id="subtotal">0</strong></div>
        <div class="stat">Match Status: <strong id="matchStatus">—</strong></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="btn warn" id="btnCheck" disabled>Check Discrepancy</button>
        <button class="btn success" id="toPage2" disabled>Next → Putaway (Page 2)</button>
      </div>

      <div id="upcScanner" class="scanner" aria-live="polite">
        <div class="scan-overlay"></div>
        <div class="overlay-box"></div>
        <video id="upcVideo" muted playsinline></video>
      </div>
    </section>

    <section id="page2" class="page hidden">
      <h2>Putaway</h2>
      <label>Putaway Instructions / Notes</label>
      <textarea id="putawayNotes" rows="2" placeholder="Special handling, bin hints, etc." disabled></textarea>

      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div class="actions">
          <button class="btn primary" id="btnScanLocation" disabled>Scan Location QR</button>
          <span class="muted">Default camera: <span class="kbd">Front</span></span>
        </div>
        <div class="row" style="gap:12px">
          <div class="stat">Entered Qty: <strong id="enteredQty2">0</strong></div>
          <div class="stat">Putaway Total: <strong id="putawayTotal">0</strong></div>
          <div class="stat">OK to Submit: <strong id="okToSubmit">No</strong></div>
        </div>
      </div>

      <h3>Locations (up to 9)</h3>
      <div id="locations" class="grid g1"></div>

      <div class="actions" style="margin-top:10px;justify-content:space-between">
        <button class="btn" id="backTo1">← Back</button>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="btnDownloadJSON">Download JSON (offline)</button>
          <button class="btn success" id="btnSubmitNext" disabled>Submit & Next</button>
        </div>
      </div>

      <div id="qrScanner" class="scanner" aria-live="polite">
        <div class="scan-overlay"></div>
        <div class="overlay-box" style="height:70%;width:min(80%,520px);"></div>
        <video id="qrVideo" muted playsinline></video>
      </div>
    </section>

    <section class="page">
      <h3>Service, Discrepancy & Labels</h3>
      <div class="grid g4">
        <div class="row" style="gap:8px;align-items:end">
          <div>
            <label>Apps Script Endpoint URL</label>
            <input id="endpoint" placeholder="https://script.google.com/macros/s/AKfycbypXvTh1R3E1dzurqothXHWWgu269i3ToJKUS7Xi5tLRE56s6den-O8h7E_2D4CFld8Pw/exec" />
          </div>
          <button class="btn" id="btnPing">Ping</button>
        </div>
        <div class="row" style="gap:8px;align-items:end">
          <div>
            <label>Can Print Check</label>
            <input id="canPrintMsg" readonly />
          </div>
          <button class="btn" id="btnCanPrint">Check</button>
          <button class="btn success" id="btnPrintLabel" disabled>Print Label</button>
        </div>
        <div class="row" style="gap:8px;align-items:end">
          <div>
            <label>Discrepancy Email</label>
            <input id="emailMsg" readonly />
          </div>
          <button class="btn" id="btnSendEmail">Send for this Item</button>
          <button class="btn warn" id="btnFinalizeSummary">Finalize & Send Summary (CSV)</button>
        </div>
        <div>
          <label class="muted">Notes</label>
          <div class="muted">Lookup uses <b>Items</b> tab. Label prints 6×4 in landscape. QR encodes <b>UPC|LOCATION|QTY|STATUS</b>. Printing is enabled only after <b>VERIFIED/APPROVED</b>.</div>
        </div>
      </div>
    </section>

    <audio id="beep" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></audio>
  </main>

  <!-- Libs -->
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Label modal -->
  <div id="labelSheet">
    <div id="labelCard">
      <div id="labelHeader">
        <span>INVENTORIED LABEL</span>
        <span id="labelLoc">LOCATION —</span>
      </div>
      <div id="itemDesc">—</div>
      <div id="labelBody">
        <div id="labelLeft">
          <div><b>Item No:</b> <span id="labelItemNo">—</span></div>
          <div><b>Brand:</b> <span id="labelBrand">—</span></div>
          <div><b>Gender:</b> <span id="labelGender">—</span></div>
          <div><b>COO:</b> <span id="labelCOO">—</span></div>
          <div><b>TOTAL QTY:</b> <span id="labelTotal">0</span></div>
          <div><b>Breakdown:</b> <span id="labelBreakdown">—</span></div>
        </div>
        <div id="labelRight">
          <div id="codes">
            <svg id="barcode"></svg>
            <div id="qrcode"></div>
          </div>
          <div style="font-weight:700;text-align:center;width:100%">
            <div>UPC</div>
            <div id="labelUPC" style="font-size:12pt"></div>
          </div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn" onclick="closeLabel()">Close</button>
        <button class="btn success" onclick="window.print()">Print</button>
      </div>
    </div>
  </div>

  <script>
    const $ = s=>document.querySelector(s); const $$ = s=>document.querySelectorAll(s);

    const state = { page:1, subtotal:0, putawayTotal:0, okToSubmit:false, focusedLocationIndex:0, logged:false, canPrint:false };

    (function init(){
      const savedUser = localStorage.getItem('sma_user') || '';
      const endpoint = localStorage.getItem('sma_endpoint') || 'https://script.google.com/macros/s/AKfycbypXvTh1R3E1dzurqothXHWWgu269i3ToJKUS7Xi5tLRE56s6den-O8h7E_2D4CFld8Pw/exec';
      const sheet = localStorage.getItem('sma_sheet') || '1k1j6Qn5VLXyuFbZm_vOUelB1hD2AT-pAL_0_22LcIrA';
      $('#endpoint').value = endpoint; $('#sheetId').value = sheet; $('#sheetIdDisplay').textContent = sheet ? 'Linked':'—';
      if(savedUser){ $('#loginName').value = savedUser; showUnlock(true); }
    })();

    // ==========================================================================
    // CAMERA TOGGLE (ADDED FIX)
    // ==========================================================================
    let currentFacingMode = 'environment';
    function toggleCam() {
      currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
      const btnText = currentFacingMode === 'environment' ? 'Front' : 'Back';
      const toggleBtn = document.getElementById('btnToggleCam');
      const camLabel = document.getElementById('camLabel');
      if (toggleBtn) toggleBtn.textContent = btnText;
      if (camLabel) camLabel.textContent = 'Camera: ' + btnText;
      if (quaggaActive) { stopUPCScan(); setTimeout(() => startUPCScan(), 100); }
    }
    const toggleCamBtn = document.getElementById('btnToggleCam');
    if (toggleCamBtn) { toggleCamBtn.addEventListener('click', toggleCam); }

    function showUnlock(is){ state.logged=!!is; $('#loginLock').textContent=is?'(ready)':'(locked until login)';
      ['upc','brand','gender','desc','coo','cd','expectedQty','itemWeight','itemL','itemW','itemH','putawayNotes'].forEach(id=>{ const el=$('#'+id); if(el) el.disabled=!is; });
      ['btnScanUPC','btnGenUPC','btnCheck','toPage2','btnScanLocation','btnSubmitNext'].forEach(id=>{ const b=$('#'+id); if(b) b.disabled=!is; }); }

    $('#loginName').addEventListener('change', e=>{ const user=e.target.value; if(!user){ showUnlock(false); return; }
      const pwd=prompt('Enter password for '+user+' (hint: username backwards)')||''; const exp=user.split('').reverse().join('').toLowerCase();
      if(pwd.toLowerCase()===exp){ localStorage.setItem('sma_user', user); showUnlock(true); $('#upc').focus(); } else { alert('Incorrect password.'); e.target.value=''; showUnlock(false); } });

    $('#endpoint').addEventListener('input', e=>localStorage.setItem('sma_endpoint', e.target.value));
    $('#sheetId').addEventListener('input', e=>{ localStorage.setItem('sma_sheet', e.target.value); $('#sheetIdDisplay').textContent = e.target.value? 'Linked':'—'; });

    // Box styles
    const boxStyles = $('#boxStyles');
    for(let i=1;i<=4;i++){
      const el=document.createElement('div'); el.className='box-card'; el.innerHTML=`
        <div class="row" style="justify-content:space-between;align-items:center"><strong>Box Style ${i}</strong><span class="muted">Boxes × Qty/Box → Pcs</span></div>
        <div class="grid g4" style="margin-top:6px">
          <div><label>Boxes</label><input data-bs="${i}" class="bs_boxes" type="number" min="0" step="1" value="0" disabled></div>
          <div><label>Qty/Box</label><input data-bs="${i}" class="bs_qty" type="number" min="0" step="1" value="0" disabled></div>
          <div><label>Pcs (auto)</label><input data-bs="${i}" class="bs_pcs" type="number" readonly value="0"></div>
          <div><label>Weight (lb)</label><input data-bs="${i}" class="bs_wt" type="number" step="0.01" min="0" value="" disabled></div>
        </div>
        <div class="grid g3" style="margin-top:6px">
          <div><label>L (in)</label><input data-bs="${i}" class="bs_l" type="number" step="0.01" min="0" value="" disabled></div>
          <div><label>W (in)</label><input data-bs="${i}" class="bs_w" type="number" step="0.01" min="0" value="" disabled></div>
          <div><label>H (in)</label><input data-bs="${i}" class="bs_h" type="number" step="0.01" min="0" value="" disabled></div>
        </div>`; boxStyles.appendChild(el); }

    function recalcSubtotal(){ let subtotal=0; document.querySelectorAll('.bs_boxes').forEach(boxEl=>{ const i=boxEl.getAttribute('data-bs'); const boxes=+boxEl.value||0; const qty=+document.querySelector(`.bs_qty[data-bs="${i}"]`).value||0; const pcsEl=document.querySelector(`.bs_pcs[data-bs="${i}"]`); const pcs=boxes*qty; pcsEl.value=pcs; subtotal+=pcs; });
      state.subtotal=subtotal; $('#enteredQty').value=subtotal; $('#enteredQty2').textContent=subtotal; $('#subtotal').textContent=subtotal; updateMatchStatus(); updateOkToSubmit(); }
    boxStyles.addEventListener('input', recalcSubtotal);

    function updateMatchStatus(){ const expected=+($('#expectedQty').value||0); const actual=state.subtotal; const ms=$('#matchStatus'); if(!expected && !actual){ ms.textContent='—'; ms.className=''; return; } if(expected===actual){ ms.textContent='MATCH'; ms.className='ok'; } else { ms.textContent=`MISMATCH (${actual-expected>=0?'+':''}${actual-expected})`; ms.className='bad'; } }
    function updateOkToSubmit(){ const ok=((+($('#expectedQty').value||0))===state.subtotal && state.subtotal>0); state.okToSubmit=ok; $('#okToSubmit').textContent=ok?'Yes':'No'; }
    $('#expectedQty').addEventListener('input', ()=>{ updateMatchStatus(); updateOkToSubmit(); });

    function goto(p){ state.page=p; $('#pageIndicator').textContent=p; $('#page1').classList.toggle('hidden', p!==1); $('#page2').classList.toggle('hidden', p!==2); if(p===2){ $('#enteredQty2').textContent=state.subtotal; } }
    $('#toPage2').addEventListener('click', ()=>goto(2)); $('#backTo1').addEventListener('click', ()=>goto(1));

    function beep(){ const a=$('#beep'); a.currentTime=0; a.play().catch(()=>{}); }

    // UPC Scan front camera
    let quaggaActive=false; function startUPCScan(){ if(quaggaActive) return; $('#upcScanner').style.display='flex'; Quagga.init({ inputStream:{ type:'LiveStream', target:document.querySelector('#upcVideo'), constraints:{ facingMode:currentFacingMode } }, decoder:{ readers:['upc_reader','upc_e_reader','code_128_reader','ean_reader','ean_8_reader','code_39_reader'] }, locate:true }, err=>{ if(err){ alert('Camera init failed: '+err.message); stopUPCScan(); return; } Quagga.start(); quaggaActive=true; }); Quagga.onDetected(onUPCDetected); }
    function stopUPCScan(){ if(quaggaActive){ Quagga.stop(); quaggaActive=false; } $('#upcScanner').style.display='none'; Quagga.offDetected(onUPCDetected); }
    function onUPCDetected(res){ const code=res?.codeResult?.code; if(!code) return; if(!/^\d{6,14}$/.test(code)) return; beep(); $('#upc').value=code; stopUPCScan(); lookupUPC(code); }
    $('#btnScanUPC').addEventListener('click', ()=>{ quaggaActive?stopUPCScan():startUPCScan(); });
    $('#btnGenUPC').addEventListener('click', ()=>{ const rnd=Math.floor(1e11+Math.random()*9e11).toString(); $('#upc').value=rnd; lookupUPC(rnd); });

    // LADIES normalization
    $('#gender').addEventListener('input', (e)=>{ const v=(e.target.value||'').toUpperCase().replace('WOMEN','LADIES'); if(v!==e.target.value.toUpperCase()) e.target.value=v; });

    // Locations UI
    const locs = $('#locations'); function buildLocations(){ locs.innerHTML=''; for(let i=0;i<9;i++){ const row=document.createElement('div'); row.className='row'; row.style.gap='10px'; row.innerHTML=`
      <div style="flex:2"><label>Location ${i+1} (scan QR or type)</label><input class="loc_code" data-i="${i}" placeholder="ZONE-AISLE-RACK-SHELF-BIN" disabled/></div>
      <div style="flex:1"><label>Qty</label><input class="loc_qty" data-i="${i}" type="number" min="0" step="1" value="0" disabled/></div>`; locs.appendChild(row);} locs.addEventListener('focusin', e=>{ if(e.target.classList.contains('loc_code')) state.focusedLocationIndex=+e.target.getAttribute('data-i'); }); locs.addEventListener('input', recalcPutawayTotal); }
    function recalcPutawayTotal(){ let t=0; document.querySelectorAll('.loc_qty').forEach(q=> t+= +q.value||0 ); state.putawayTotal=t; $('#putawayTotal').textContent=t; updateOkToSubmit(); }
    buildLocations();

    // QR Scan front camera
    let qrStream=null; let qrActive=false; async function startQRScan(){ try{ $('#qrScanner').style.display='flex'; const constraints={ video:{ facingMode:currentFacingMode } }; const video=document.getElementById('qrVideo'); qrStream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject=qrStream; await video.play(); qrActive=true; scanLoop(); }catch(err){ alert('QR camera error: '+err.message); stopQRScan(); } }
    function stopQRScan(){ qrActive=false; if(qrStream){ qrStream.getTracks().forEach(t=>t.stop()); qrStream=null; } $('#qrScanner').style.display='none'; }
    async function scanLoop(){ const reader=new ZXingBrowser.BrowserMultiFormatReader(); const video=document.getElementById('qrVideo'); while(qrActive){ try{ const result=await reader.decodeFromVideoElement(video); if(result?.text){ onQRDetected(result.text); } }catch(e){} await new Promise(r=>setTimeout(r,200)); } }
    function onQRDetected(text){ beep(); const input=document.querySelector(`.loc_code[data-i="${state.focusedLocationIndex}"]`); if(input){ input.value=text; } stopQRScan(); }
    $('#btnScanLocation').addEventListener('click', ()=>{ qrActive?stopQRScan():startQRScan(); });

    // Discrepancy
    $('#btnCheck').addEventListener('click', ()=>{ const ok=state.okToSubmit; alert(ok ? '✔ Counts match. Status: VERIFIED.' : '⚠ Counts mismatch. Status: PENDING.'); });

    // Build submit params (separate locations)
    function buildSubmitParams(){ const p=new URLSearchParams(); p.append('action','submit'); p.append('upc', ($('#upc').value||'').trim()); p.append('brand',$('#brand').value||''); p.append('gender', ($('#gender').value||'').toUpperCase().replace('WOMEN','LADIES')); p.append('masterItemDesc',$('#desc').value||''); p.append('coo',$('#coo').value||''); p.append('cd',$('#cd').value||''); p.append('expectedQty', +($('#expectedQty').value||0) || 0); p.append('enteredQty', state.subtotal||0); p.append('itemWeight', +($('#itemWeight').value||0) || 0); p.append('itemDimL', +($('#itemL').value||0) || 0); p.append('itemDimW', +($('#itemW').value||0) || 0); p.append('itemDimH', +($('#itemH').value||0) || 0); p.append('notes',$('#putawayNotes').value||''); for(let i=1;i<=4;i++){ const get=(cls)=>document.querySelector(`.${cls}[data-bs="${i}"]`).value||''; p.append(`bs${i}_boxes`, get('bs_boxes')||0); p.append(`bs${i}_qty`, get('bs_qty')||0); p.append(`bs${i}_pcs`, get('bs_pcs')||0); p.append(`bs${i}_l`, get('bs_l')); p.append(`bs${i}_w`, get('bs_w')); p.append(`bs${i}_h`, get('bs_h')); p.append(`bs${i}_wt`, get('bs_wt')); } for(let i=0;i<9;i++){ const code=(document.querySelector(`.loc_code[data-i="${i}"]`).value||'').trim(); const qty=+document.querySelector(`.loc_qty[data-i="${i}"]`).value||0; p.append(`location${i+1}_code`, code); p.append(`location${i+1}_qty`, qty); } p.append('processed_by', localStorage.getItem('sma_user')||''); p.append('sheetId', $('#sheetId').value||''); p.append('status', state.okToSubmit ? 'VERIFIED' : 'PENDING'); return p; }

    async function submitNow(){ const url=($('#endpoint').value||'').trim(); if(!url) return alert('Set Endpoint URL first.'); const params=buildSubmitParams(); try{ const resp=await fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:params.toString()}); const text=await resp.text(); alert('Server response: '+text.slice(0,200)); if((params.get('status')||'')==='PENDING') await sendDiscrepancyEmail('Auto: pending discrepancy'); if((params.get('status')||'')==='VERIFIED') await canPrintCheck(); resetForNext(); }catch(err){ alert('Submit failed; downloading JSON locally. '+err.message); const obj=Object.fromEntries(params); downloadJSON(obj); } }
    $('#btnSubmitNext').addEventListener('click', submitNow);

    function resetForNext(){ ['upc','brand','gender','desc','coo','cd','expectedQty','enteredQty','itemWeight','itemL','itemW','itemH','putawayNotes'].forEach(id=>{const el=$('#'+id); if(el) el.value='';}); document.querySelectorAll('.bs_boxes,.bs_qty').forEach(el=>el.value='0'); document.querySelectorAll('.bs_pcs').forEach(el=>el.value='0'); document.querySelectorAll('.bs_wt,.bs_l,.bs_w,.bs_h').forEach(el=>el.value=''); document.querySelectorAll('.loc_code').forEach(el=>el.value=''); document.querySelectorAll('.loc_qty').forEach(el=>el.value='0'); state.subtotal=0; state.putawayTotal=0; state.okToSubmit=false; state.canPrint=false; $('#btnPrintLabel').disabled=true; $('#subtotal').textContent='0'; $('#enteredQty').value='0'; $('#enteredQty2').textContent='0'; $('#putawayTotal').textContent='0'; $('#matchStatus').textContent='—'; $('#canPrintMsg').value=''; goto(1); $('#upc').focus(); }

    function downloadJSON(obj){ const name=`scan_${(obj.upc||'no_upc')}_${new Date().toISOString().replace(/[:.]/g,'-')}.json`; const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }
    $('#btnDownloadJSON').addEventListener('click', ()=>{ const p=buildSubmitParams(); const obj=Object.fromEntries(p); downloadJSON(obj); });

    // Service calls
    async function ping(){ const url=($('#endpoint').value||'').trim(); if(!url) return alert('Set Endpoint URL first.'); const r=await fetch(url+`?action=ping`); const t=await r.text(); $('#canPrintMsg').value='Ping: '+t.slice(0,140); }
    $('#btnPing').addEventListener('click', ping);

    async function canPrintCheck(){ const url=($('#endpoint').value||'').trim(); if(!url) return; const upc=($('#upc').value||'').trim(); if(!upc) return; const r=await fetch(url+`?action=canprint&upc=${encodeURIComponent(upc)}&sheetId=${encodeURIComponent($('#sheetId').value||'')}`); const t=await r.text(); $('#canPrintMsg').value=t.slice(0,300); try{ const j=JSON.parse(t); state.canPrint=!!j.canPrint; }catch{} $('#btnPrintLabel').disabled=!state.canPrint; return t; }
    $('#btnCanPrint').addEventListener('click', canPrintCheck);

    async function sendDiscrepancyEmail(note){ const url=($('#endpoint').value||'').trim(); if(!url) return; const p=buildSubmitParams(); p.set('action','senddiscrepancyemail'); if(note) p.set('note', note); const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:p.toString()}); const t=await r.text(); $('#emailMsg').value=t.slice(0,200); return t; }
    $('#btnSendEmail').addEventListener('click', ()=> sendDiscrepancyEmail('Manual trigger'));

    async function finalizeAndSend(){ const url=($('#endpoint').value||'').trim(); if(!url) return; const p=new URLSearchParams(); p.set('action','finalizeandsummary'); p.set('sheetId',$('#sheetId').value||''); const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:p.toString()}); const t=await r.text(); $('#emailMsg').value=t.slice(0,300); return t; }
    $('#btnFinalizeSummary').addEventListener('click', finalizeAndSend);

    async function lookupUPC(upc){ const url=($('#endpoint').value||'').trim(); if(!url||!upc) return; try{ const r=await fetch(url+`?action=lookup&upc=${encodeURIComponent(upc)}&sheetId=${encodeURIComponent($('#sheetId').value||'')}`); const data=await r.json(); if(data && data.ok && data.item){ const it=data.item; if(it.brand) $('#brand').value=it.brand; if(it.gender) $('#gender').value=(it.gender+'').toUpperCase().replace('WOMEN','LADIES'); if(it.desc) $('#desc').value=it.desc; if(it.coo) $('#coo').value=it.coo; if(it.cd) $('#cd').value=it.cd; if(Number.isFinite(+it.expectedQty)) $('#expectedQty').value=+it.expectedQty; } ['brand','gender'].forEach(id=>{ const el=$('#'+id); if(el && el.value) el.readOnly=true; }); updateMatchStatus(); }catch(e){ console.log('lookup failed', e); } }

    // Label rendering (QR composite: UPC|LOCATION|QTY|STATUS)
    function openLabel(){ $('#labelSheet').style.display='flex'; }
    function closeLabel(){ $('#labelSheet').style.display='none'; }
    function computeBreakdown(){ let parts=[]; document.querySelectorAll('.bs_boxes').forEach(el=>{ const i=el.getAttribute('data-bs'); const b=+el.value||0; const q=+(document.querySelector(`.bs_qty[data-bs="${i}"]`).value||0); if(b>0 && q>0) parts.push(`${b} x ${q}`); }); return parts.length? parts.join(' + ') : '—'; }
    function firstLocation(){ const code=(document.querySelector('.loc_code')?.value||'').trim(); return code || '—'; }
    function renderLabel(){ const upc=($('#upc').value||'').trim(); if(!upc){ alert('UPC missing'); return; } const brand=$('#brand').value||''; const gender=$('#gender').value||''; const desc=$('#desc').value||''; const coo=$('#coo').value||''; const total=state.subtotal||0; const loc=firstLocation(); const statusText = state.canPrint ? 'VERIFIED' : 'PENDING';
      $('#labelLoc').textContent = loc ? `LOCATION ${loc}` : 'LOCATION —';
      $('#labelItemNo').textContent = upc;
      $('#labelBrand').textContent = brand; $('#labelGender').textContent = gender; $('#labelCOO').textContent = coo; $('#labelTotal').textContent = total; $('#labelBreakdown').textContent = computeBreakdown(); $('#labelUPC').textContent = upc;
      $('#itemDesc').textContent = desc || '—';
      try{ JsBarcode('#barcode', upc, {format:'CODE128', width:2, height:60, displayValue:false, margin:0}); }catch(e){ console.log(e); }
      try{ const qrDiv=document.getElementById('qrcode'); qrDiv.innerHTML=''; const composite = `${upc}|${loc}|${total}|${statusText}`; new QRCode(qrDiv,{text:composite,width:120,height:120}); }catch(e){ console.log(e); }
      openLabel(); }

    $('#btnPrintLabel').addEventListener('click', renderLabel);

    // Init
    recalcSubtotal(); updateOkToSubmit();
  </script>
  
  <script>
    function closeLabel(){ document.getElementById('labelSheet').style.display='none'; }
  </script>
</body>
</html>
