<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>STOCKMANAGERAPP · Mobile Inventory (MVP)</title>
<style>
  :root{
    --bg:#0b1220; --card:#131a2a; --ink:#e7ecff; --muted:#9fb0d9; --accent:#4c8bf5;
    --ok:#18b27f; --warn:#f5a623; --bad:#ff4d4f; --line:#27314a; --panel:#0e1628;
    --print-ink:#111; --print-bg:#fff;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  header h1{font-size:16px;margin:0;font-weight:600}
  .pill{background:#223156;border:1px solid var(--line);padding:6px 10px;border-radius:8px;color:#fff;display:inline-flex;gap:8px;align-items:center}
  .wrap{padding:16px;max-width:900px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:0 0 16px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,textarea{width:100%;padding:10px 12px;border-radius:10px;background:#0f1626;color:var(--ink);border:1px solid var(--line);font-size:14px}
  input[readonly]{opacity:.85;background:#0e1423}
  h2{font-size:18px;margin:6px 0 12px} h3{font-size:16px;margin:8px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .row5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .btn{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.secondary{background:#2a3757} .btn.ghost{background:transparent;border:1px solid var(--line)}
  .btn.ok{background:var(--ok)} .btn.bad{background:var(--bad)} .btn.warn{background:var(--warn);color:#222}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .status{padding:8px 10px;border-radius:8px;border:1px solid var(--line);background:#0e1628}
  .status.ok{border-color:#1e7f66;background:#0e1f1b;color:#8af0cf}
  .status.bad{border-color:#7f1e1e;background:#201313;color:#ffb7b7}
  .hidden{display:none!important}
  nav{display:flex;justify-content:space-between;gap:8px;margin-top:10px}

  /* Scanner overlay */
  .scan-overlay{position:fixed;inset:0;background:rgba(6,10,18,.85);display:none;align-items:center;justify-content:center;z-index:9999}
  .scan-content{position:relative;width:min(94vw,640px);aspect-ratio:3/4;background:#000;border-radius:12px;overflow:hidden;border:1px solid #333}
  video{width:100%;height:100%;object-fit:cover}
  .frame{position:absolute;inset:15% 10%;border:3px solid rgba(76,139,245,.9);border-radius:10px;box-shadow:0 0 0 100vmax rgba(0,0,0,.25) inset}
  .scan-bar{position:absolute;left:10%;right:10%;height:2px;top:25%;background:rgba(76,139,245,.75);box-shadow:0 0 12px rgba(76,139,245,.9);animation:scan 2.2s linear infinite}
  .scan-controls{position:absolute;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(transparent,rgba(0,0,0,.8));display:flex;gap:8px;justify-content:center}

  /* Toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f1a2c;border:1px solid var(--line);color:#fff;padding:10px 14px;border-radius:10px;z-index:99999;display:none}

  /* Summary Modal (printable) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10000}
  .paper{background:#fff;color:#111;border-radius:12px;max-width:800px;width:96vw;max-height:90vh;overflow:auto;padding:16px 18px}
  .kv{display:grid;grid-template-columns:1fr 2fr;gap:6px;margin:6px 0}
  .paper table{width:100%;border-collapse:collapse;color:#111}
  .paper th,.paper td{border:1px solid #e0e0e0;padding:6px 8px;font-size:13px;text-align:left}
  .paper .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  @media print{
    body{background:var(--print-bg)!important;color:var(--print-ink)!important}
    #summaryModal{display:flex!important;position:static}
    header,.wrap,.scan-overlay,.toast{display:none!important}
    .paper{box-shadow:none;border:none;width:100%;max-width:100%}
  }
</style>
</head>
<body>
<header>
  <h1>STOCKMANAGERAPP · Mobile Inventory</h1>
  <span class="pill"><b id="pageTag">Page 1 of 2</b></span>
  <span class="pill">Logged in as:
    <input id="loginName" type="text" placeholder="Name or initials" style="width:160px;background:transparent;border:none;border-bottom:1px dashed #49587a;color:#fff;padding:2px 6px;margin-left:6px">
    <button id="saveLogin" class="btn ghost" style="padding:6px 10px;margin-left:6px">Save</button>
  </span>
  <span class="pill">
    Camera:
    <label style="margin-left:8px"><input type="radio" name="cam" value="environment" checked> Back</label>
    <label style="margin-left:8px"><input type="radio" name="cam" value="user"> Front</label>
  </span>
</header>

<div class="wrap">
  <!-- ===== Page 1: Validate Item Details & Packing ===== -->
  <section id="page1" class="card">
    <h2>Validate Item Details &amp; Packing</h2>
    <div class="row">
      <div>
        <label>UPC *</label>
        <div class="toolbar">
          <input id="upc" type="text" inputmode="numeric" pattern="[0-9]*" class="mono" placeholder="Scan or enter UPC" style="flex:1">
          <button id="scanUPC" class="btn">Scan UPC/Barcode</button>
          <button id="genUPC" class="btn secondary">Generate UPC</button>
        </div>
      </div>
      <div>
        <label>Expected / Entered</label>
        <div class="row">
          <input id="expectedQty" type="number" min="0" step="1" placeholder="Expected Quantity">
          <input id="enteredQtyMirror" type="number" readonly placeholder="Entered Quantity (auto)">
        </div>
      </div>
    </div>

    <div class="row3">
      <div><label>Brand</label><input id="brand" type="text" placeholder="Auto-fill on scan if known"></div>
      <div><label>Gender</label><input id="gender" type="text" placeholder="Auto-fill on scan if known"></div>
      <div><label>Master Item Description</label><input id="desc" type="text" placeholder="Auto-fill on scan if known"></div>
    </div>
    <div class="row3">
      <div><label>COO</label><input id="coo" type="text"></div>
      <div><label>C/D</label><input id="cd" type="text" placeholder="CLEAN/DECODED"></div>
      <div></div>
    </div>

    <div class="row4">
      <div><label>Item Weight (lb)</label><input id="itemWeight" type="number" min="0" step="0.01"></div>
      <div><label>L (in)</label><input id="itemDimL" type="number" min="0" step="0.01"></div>
      <div><label>W (in)</label><input id="itemDimW" type="number" min="0" step="0.01"></div>
      <div><label>H (in)</label><input id="itemDimH" type="number" min="0" step="0.01"></div>
    </div>

    <h3>Box Breakdown (Styles 1–4)</h3>
    <div id="boxStyles"></div>

    <div class="row">
      <div class="status">Subtotal Pcs: <b class="mono" id="subtotalPcs">0</b></div>
      <div class="status" id="matchStatus">Match Status: —</div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="checkDiscrepancy" class="btn warn">Check Discrepancy</button>
    </div>

    <nav>
      <div class="muted">Tip: Brand & Gender lock when auto‑filled.</div>
      <button id="toPage2" class="btn">Next → Putaway (Page 2)</button>
    </nav>
  </section>

  <!-- ===== Page 2: Putaway ===== -->
  <section id="page2" class="card hidden">
    <h2>Putaway</h2>
    <label>Putaway Instructions / Notes</label>
    <textarea id="notes" rows="3" placeholder="Optional notes..."></textarea>

    <div class="toolbar" style="margin:10px 0">
      <button id="scanLocation" class="btn secondary">Scan Location QR</button>
      <button id="toggleCamera" class="btn ghost">Toggle Camera</button>
      <span class="muted">Use front camera if it helps align shelf/bin QR codes.</span>
    </div>

    <div class="row3">
      <div class="status">Entered Qty: <b class="mono" id="enteredQty">0</b></div>
      <div class="status">Putaway Total: <b class="mono" id="putawayTotal">0</b></div>
      <div class="status" id="okToSubmit">OK to Submit: <b id="okFlag">No</b></div>
    </div>

    <h3>Locations (up to 9)</h3>
    <div id="locations"></div>

    <nav>
      <button id="backToPage1" class="btn ghost">← Back</button>
      <div class="toolbar">
        <button id="previewSummary" class="btn secondary">Preview & Print Summary</button>
        <button id="downloadJSON" class="btn secondary">Download JSON (offline)</button>
        <button id="submit" class="btn ok" disabled>Submit & Next</button>
      </div>
    </nav>
  </section>
</div>

<!-- Scanner Overlay -->
<div id="scanner" class="scan-overlay" role="dialog" aria-modal="true">
  <div class="scan-content">
    <video id="video" playsinline></video>
    <div class="frame"></div>
    <div class="scan-bar"></div>
    <div class="scan-controls">
      <button id="flip" class="btn ghost">Flip</button>
      <button id="done" class="btn bad">✕</button>
    </div>
  </div>
</div>

<!-- Summary Modal (Printable) -->
<div id="summaryModal" class="modal" role="dialog" aria-modal="true">
  <div class="paper" id="summaryPaper">
    <h2>Inventory Verification Summary</h2>
    <div class="muted" id="summaryMeta"></div>

    <h3>Item Details</h3>
    <div class="kv" id="summaryKV"></div>

    <h3>Box Breakdown</h3>
    <table id="summaryBox">
      <thead><tr><th>Style</th><th>Boxes</th><th>Qty/Box</th><th>Pcs</th><th>L</th><th>W</th><th>H</th><th>Weight</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><th colspan="3" style="text-align:right">Subtotal</th><th id="summarySubtotal">0</th><th colspan="4"></th></tr></tfoot>
    </table>

    <h3>Locations</h3>
    <table id="summaryLoc">
      <thead><tr><th>#</th><th>Location</th><th>Qty</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><th colspan="2" style="text-align:right">Putaway Total</th><th id="summaryPutaway">0</th></tr></tfoot>
    </table>

    <div class="actions">
      <button id="printSummary" class="btn ok" type="button">Print</button>
      <button id="closeSummary" class="btn ghost" type="button">Close</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- ZXing fallback for scanning -->
<script src="https://unpkg.comer@latest</script>
<script>
/* ===== Utilities ===== */
const $ = s => document.querySelector(s);
const el = (t,a={},kids=[])=>{const n=document.createElement(t);for(const[k,v] of Object.entries(a)){if(k==='class')n.className=v;else if(k==='text')n.textContent=v;else n.setAttribute(k,v)}kids.forEach(c=>n.append(c));return n};
const toast=(m,ms=1600)=>{const t=$("#toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",ms);}
const digits = s => String(s||'').replace(/\D+/g,'');
function beep(){const c=new (window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();o.type='triangle';o.frequency.value=880;o.connect(g);g.connect(c.destination);g.gain.value=.12;o.start();setTimeout(()=>{o.stop();c.close()},120);}

/* ===== Config (pre-wired) ===== */
const CONFIG = {
  GS_URL: 'https://script.google.com/macros/s/AKfycbxxC1OEkRqyY3q39LivJhMVZ-f7wiL9cx-RMzE2yqhj0QKIfs3hlHucBovmgUcev8X0gA/exec'
};

/* ===== State ===== */
const STATE = {
  cameraFacing: 'environment',
  detector: null,
  zxingReader: null,
  activeTarget: '', // 'upc' | 'loc'
  boxStyles: [],
  locations: []
};

/* ===== Elements ===== */
const page1=$("#page1"), page2=$("#page2"), pageTag=$("#pageTag");
const login=$("#loginName"), saveLogin=$("#saveLogin");
const upc=$("#upc"), scanUPC=$("#scanUPC"), genUPC=$("#genUPC");
const brand=$("#brand"), gender=$("#gender"), desc=$("#desc"), coo=$("#coo"), cd=$("#cd");
const expected=$("#expectedQty");
const itemWeight=$("#itemWeight"), itemDimL=$("#itemDimL"), itemDimW=$("#itemDimW"), itemDimH=$("#itemDimH");
const subtotalPcs=$("#subtotalPcs"), enteredMirror=$("#enteredQtyMirror"), matchStatus=$("#matchStatus");
const toPage2=$("#toPage2"), backToPage1=$("#backToPage1");
const notes=$("#notes"), enteredQty=$("#enteredQty"), putawayTotal=$("#putawayTotal"), okFlag=$("#okFlag"), submitBtn=$("#submit"), previewSummary=$("#previewSummary"), downloadJSON=$("#downloadJSON");

/* ===== Build dynamic rows ===== */
const boxDiv=$("#boxStyles"), locDiv=$("#locations");
for (let i=1;i<=4;i++){
  const r=el('div',{class:'row5 card'});
  r.append(
    el('div',{},[el('label',{text:`Box Style ${i} — Boxes`}), el('input',{type:'number',min:'0',step:'1',id:`bs${i}_boxes`})]),
    el('div',{},[el('label',{text:'Qty/Box'}), el('input',{type:'number',min:'0',step:'1',id:`bs${i}_qty`})]),
    el('div',{},[el('label',{text:'Pcs (auto)'}), el('input',{type:'number',min:'0',step:'1',readonly:'',id:`bs${i}_pcs`})]),
    el('div',{},[el('label',{text:'L×W×H (in)'}), el('div',{class:'row3'},[
      el('input',{type:'number',min:'0',step:'0.01',id:`bs${i}_L`,placeholder:'L'}),
      el('input',{type:'number',min:'0',step:'0.01',id:`bs${i}_W`,placeholder:'W'}),
      el('input',{type:'number',min:'0',step:'0.01',id:`bs${i}_H`,placeholder:'H'})
    ])]),
    el('div',{},[el('label',{text:'Weight (lb)'}), el('input',{type:'number',min:'0',step:'0.01',id:`bs${i}_weight`})])
  );
  boxDiv.append(r);
}
for (let i=1;i<=9;i++){
  const r=el('div',{class:'row card'});
  r.append(
    el('div',{},[el('label',{text:`Location ${i}`}), el('input',{type:'text',id:`loc${i}_id`,placeholder:'ZONE-AISLE-RACK-SHELF-BIN'})]),
    el('div',{},[el('label',{text:'Qty'}), el('input',{type:'number',min:'0',step:'1',id:`loc${i}_qty`})])
  );
  locDiv.append(r);
}

/* ===== Calculations ===== */
function recalcBox(){
  let sub=0; const arr=[];
  for(let i=1;i<=4;i++){
    const boxes=Number($("#bs"+i+"_boxes").value||0);
    const qty=Number($("#bs"+i+"_qty").value||0);
    const pcs=boxes*qty; $("#bs"+i+"_pcs").value=pcs?pcs:'';
    sub+=pcs;
    arr.push({
      style:i, boxes, qty, pcs,
      L:Number($("#bs"+i+"_L").value||''), W:Number($("#bs"+i+"_W").value||''), H:Number($("#bs"+i+"_H").value||''),
      weight:Number($("#bs"+i+"_weight").value||'')
    });
  }
  subtotalPcs.textContent=String(sub);
  enteredMirror.value=String(sub);
  enteredQty.textContent=String(sub);
  STATE.boxStyles=arr;
  refreshMatch();
  validateSubmit();
}
for (let i=1;i<=4;i++){["_boxes","_qty","_L","_W","_H","_weight"].forEach(s=>$("#bs"+i+s).addEventListener('input',recalcBox));}

function refreshMatch(){
  const exp=Number(expected.value||NaN), sub=Number(subtotalPcs.textContent||0);
  matchStatus.classList.remove('ok','bad');
  if (!expected.value){ matchStatus.textContent="Match Status: —"; return; }
  if (sub===exp){ matchStatus.textContent="Match Status: MATCH"; matchStatus.classList.add('ok'); }
  else { matchStatus.textContent = "Match Status: " + (sub>exp?`OVER by ${sub-exp}`:`SHORT by ${exp-sub}`); matchStatus.classList.add('bad'); }
}
expected.addEventListener('input', refreshMatch);
$("#checkDiscrepancy").addEventListener('click', ()=>{ refreshMatch(); toast(matchStatus.textContent); });

function recalcLocs(){
  let tot=0; const arr=[];
  for(let i=1;i<=9;i++){
    const id=$("#loc"+i+"_id").value.trim();
    const q=Number($("#loc"+i+"_qty").value||0);
    if (id || q){ arr.push({loc:id, qty:q}); }
    tot+=q;
  }
  STATE.locations=arr;
  putawayTotal.textContent=String(tot);
  validateSubmit();
}
for (let i=1;i<=9;i++){ $("#loc"+i+"_id").addEventListener('input',recalcLocs); $("#loc"+i+"_qty").addEventListener('input',recalcLocs); }

function validateSubmit(){
  const ok = Number(enteredQty.textContent||0)>0 && Number(putawayTotal.textContent||0)===Number(enteredQty.textContent||0);
  $("#okFlag").textContent = ok ? "Yes" : "No";
  submitBtn.disabled = !ok;
}

/* ===== Page nav ===== */
toPage2.addEventListener('click', ()=>{ page1.classList.add('hidden'); page2.classList.remove('hidden'); pageTag.textContent="Page 2 of 2"; recalcLocs(); });
backToPage1.addEventListener('click', ()=>{ page2.classList.add('hidden'); page1.classList.remove('hidden'); pageTag.textContent="Page 1 of 2"; });

/* ===== Login ===== */
login.value = localStorage.getItem('SM_login') || '';
saveLogin.addEventListener('click', ()=>{ localStorage.setItem('SM_login', login.value.trim()); toast('Saved'); });

/* ===== UPC generator (fallback) ===== */
genUPC.addEventListener('click', ()=>{
  let base = String(Date.now()).slice(-11);
  let s=0; for(let i=0;i<11;i++){ const d=Number(base[i]); s += (i%2===0)? d*3 : d; }
  const cd = (10-(s%10))%10;
  upc.value = base + cd;
});

/* ===== Scanner (BarcodeDetector → ZXing fallback) ===== */
const scanner=$("#scanner"), video=$("#video"), flip=$("#flip"), done=$("#done");
async function ensureDetector(){
  if ('BarcodeDetector' in window){
    try{ STATE.detector = new BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e','code_128','qr_code']}); return true; }catch{}
  }
  if (!STATE.zxingReader){ STATE.zxingReader = new ZXingBrowser.BrowserMultiFormatReader(); }
  return false;
}
async function startStream(){
  stopStream();
  const cons={audio:false, video:{facingMode:STATE.cameraFacing, width:{ideal:1280}, height:{ideal:720}}};
  const s=await navigator.mediaDevices.getUserMedia(cons);
  video.srcObject=s; await video.play();
}
function stopStream(){ try{video.pause()}catch{} if (video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; } }
async function openScanner(kind){ STATE.activeTarget=kind; scanner.style.display='flex'; await startStream(); loopDetect(); }
flip.addEventListener('click', async ()=>{ STATE.cameraFacing=(STATE.cameraFacing==='environment'?'user':'environment'); await startStream(); });
done.addEventListener('click', ()=>{ stopStream(); scanner.style.display='none'; });
document.querySelectorAll('input[name="cam"]').forEach(r=>r.addEventListener('change', async e=>{ STATE.cameraFacing=e.target.value; if(scanner.style.display==='flex'){ await startStream(); } }));

async function loopDetect(){
  const native=await ensureDetector();
  if(native){
    const tick = async ()=>{
      if (scanner.style.display!=='flex') return;
      try{
        const codes = await STATE.detector.detect(video);
        if (codes && codes.length){
          handleScan(codes[0].rawValue || codes[0].displayValue || '');
          return;
        }
      }catch{}
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  } else {
    STATE.zxingReader.decodeFromVideoDevice(null, video, (res,err)=>{
      if(res){ handleScan(res.getText()); }
    });
  }
}
function handleScan(text){
  beep();
  stopStream(); scanner.style.display='none';
  const v = String(text||'').trim();
  if (STATE.activeTarget==='upc'){ const d=digits(v); upc.value = d || v; fetchItemByUPC(upc.value); }
  if (STATE.activeTarget==='loc'){
    const slot = [...Array(9).keys()].map(i=>$("#loc"+(i+1)+"_id")).find(e=>!e.value.trim()) || $("#loc1_id");
    slot.value = v; recalcLocs();
  }
}
scanUPC.addEventListener('click', ()=>openScanner('upc'));
$("#scanLocation").addEventListener('click', ()=>openScanner('loc'));
$("#toggleCamera").addEventListener('click', ()=>{ STATE.cameraFacing=(STATE.cameraFacing==='environment'?'user':'environment'); toast('Camera: '+(STATE.cameraFacing==='user'?'Front':'Back')); });

/* ===== Backend lookup & submit ===== */
async function fetchItemByUPC(u){
  if (!u){ toast('Enter or scan a UPC first'); return; }
  try{
    const r = await fetch(`${CONFIG.GS_URL}?action=getItem&upc=${encodeURIComponent(u)}`);
    const j = await r.json();
    if (j && j.ok && j.item){
      const it=j.item;
      if (it.brand){ brand.value=it.brand; brand.readOnly=true; } else { brand.readOnly=false; }
      if (it.gender){ gender.value=it.gender; gender.readOnly=true; } else { gender.readOnly=false; }
      if (it.desc){ desc.value=it.desc; }
      if (it.coo){ coo.value=it.coo; }
      if (it.cd){ cd.value=it.cd; }
      if (it.expectedQty!==undefined && it.expectedQty!==''){ expected.value=it.expectedQty; }
      refreshMatch();
      return;
    }
  }catch(e){ /* fall back to seed below */ }
  const SEED={
    "3700591230073":{brand:"ATELIER COLOGNE",gender:"",desc:".33oz",coo:"",cd:"",expectedQty:""},
    "3700591230035":{brand:"ATELIER COLOGNE",gender:"",desc:"3.3oz",coo:"",cd:"",expectedQty:""},
    "6290360593241":{brand:"LATTAFA",gender:"",desc:"KHAMRAH 6.7oz Deo",coo:"",cd:"",expectedQty:""}
  };
  if (SEED[u]){ const it=SEED[u]; brand.value=it.brand; desc.value=it.desc; refreshMatch(); }
  else toast('No match found (you can fill details)');
}

function buildPayload(){
  return {
    timestamp: new Date().toISOString(),
    login: (login.value||'').trim(),
    upc: (upc.value||'').trim(),
    brand: (brand.value||'').trim(),
    gender: (gender.value||'').trim(),
    desc: (desc.value||'').trim(),
    coo: (coo.value||'').trim(),
    cd: (cd.value||'').trim(),
    expectedQty: (expected.value||'').trim(),
    itemWeight: (itemWeight.value||'').trim(),
    itemDimL: (itemDimL.value||'').trim(),
    itemDimW: (itemDimW.value||'').trim(),
    itemDimH: (itemDimH.value||'').trim(),
    subtotalPcs: Number(subtotalPcs.textContent||0),
    boxStyles: STATE.boxStyles.filter(x=> (x.boxes||0)>0 && (x.qty||0)>0),
    locations: STATE.locations.filter(x=> (x.loc && x.loc.trim()) || (x.qty||0)>0),
    notes: (notes.value||'').trim()
  };
}

/* ===== Printable Summary ===== */
const summaryModal=$("#summaryModal"), summaryMeta=$("#summaryMeta"), summaryKV=$("#summaryKV");
const summaryBox=$("#summaryBox tbody"), summarySubtotal=$("#summarySubtotal"), summaryLoc=$("#summaryLoc tbody"), summaryPutaway=$("#summaryPutaway");
$("#previewSummary").addEventListener('click', ()=>{
  const p = buildPayload();
  renderSummary(p);
  summaryModal.style.display='flex';
});
$("#closeSummary").addEventListener('click', ()=>{ summaryModal.style.display='none'; });
$("#printSummary").addEventListener('click', ()=>{ window.print(); });

function renderSummary(p){
  summaryMeta.textContent = `Login: ${p.login||'—'} • Time: ${p.timestamp} • Page 2 of 2`;
  summaryKV.innerHTML='';
  const kv = [
    ['UPC', p.upc||'—'], ['Brand', p.brand||'—'], ['Gender', p.gender||'—'], ['Description', p.desc||'—'],
    ['COO', p.coo||'—'], ['C/D', p.cd||'—'], ['Expected Qty', p.expectedQty||'—'], ['Entered (Subtotal)', String(p.subtotalPcs)],
    ['Item Weight (lb)', p.itemWeight||'—'], ['Item Dimensions (in)', [p.itemDimL||'',p.itemDimW||'',p.itemDimH||''].filter(Boolean).join(' × ')||'—']
  ];
  for (const [k,v] of kv){ summaryKV.append(el('div',{text:k}), el('div',{text:String(v)})); }

  summaryBox.innerHTML=''; let sub=0;
  (p.boxStyles||[]).forEach(bs=>{
    sub += (bs.pcs||0);
    const tr=el('tr'); ['style','boxes','qty','pcs','L','W','H','weight'].forEach(k=> tr.append(el('td',{text:String(bs[k]??'')})) );
    summaryBox.append(tr);
  });
  summarySubtotal.textContent = String(sub);

  summaryLoc.innerHTML=''; let put=0; let i=0;
  (p.locations||[]).forEach(L=>{
    put += (L.qty||0);
    const tr=el('tr'); tr.append(el('td',{text:String(++i)}), el('td',{text:String(L.loc||'—')}), el('td',{text:String(L.qty||0)}));
    summaryLoc.append(tr);
  });
  summaryPutaway.textContent = String(put);
}

/* ===== Download JSON ===== */
downloadJSON.addEventListener('click', ()=>{
  const p = buildPayload();
  const blob = new Blob([JSON.stringify(p,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`stockmanager_submission_${new Date().toISOString().replace(/[:.]/g,'')}.json`; document.body.append(a); a.click(); a.remove();
});

/* ===== Submit ===== */
submitBtn.addEventListener('click', async ()=>{
  const p = buildPayload();
  if (!p.upc){ toast('UPC is required'); return; }
  submitBtn.disabled = true;
  try{
    const r = await fetch(CONFIG.GS_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'submit', payload: p }) });
    const j = await r.json();
    if (j && j.ok){ toast(`Saved (${j.status})`); resetForNext(); summaryModal.style.display='none'; }
    else{ toast('Submit failed'); }
  }catch(e){ toast('Network error while submitting'); }
  finally{ submitBtn.disabled = false; }
});

function resetForNext(){
  upc.value=''; brand.value=''; brand.readOnly=false; gender.value=''; gender.readOnly=false;
  desc.value=''; coo.value=''; cd.value=''; expected.value='';
  itemWeight.value=''; itemDimL.value=''; itemDimW.value=''; itemDimH.value='';
  for (let i=1;i<=4;i++){["_boxes","_qty","_pcs","_L","_W","_H","_weight"].forEach(s=>$("#bs"+i+s).value='');}
  recalcBox();
  notes.value='';
  for (let i=1;i<=9;i++){ $("#loc"+i+"_id").value=''; $("#loc"+i+"_qty").value=''; }
  recalcLocs();
  page2.classList.add('hidden'); page1.classList.remove('hidden'); pageTag.textContent="Page 1 of 2";
}

/* ===== Init ===== */
login.value = localStorage.getItem('SM_login') || '';
saveLogin.addEventListener('click', ()=>{ localStorage.setItem('SM_login', login.value.trim()); toast('Saved'); });
function init(){ recalcBox(); recalcLocs(); }
init();
</script>
</body>
</html>